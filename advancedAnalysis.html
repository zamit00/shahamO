<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-41JX3YK216"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-41JX3YK216');
    </script>
    
    <!-- SEO Meta Tags -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="× ×™×ª×•×— ××ª×§×“× ×©×œ ×ª×™×§ ×”×”×©×§×¢×•×ª ×”×¤× ×¡×™×•× ×™ ×©×œ×š - ×–×™×”×•×™ ×¤×¢×¨×™× ×•×”×–×“×× ×•×™×•×ª, ×”××œ×¦×•×ª ××•×ª×××•×ª ××™×©×™×ª">
    <title>× ×™×ª×•×— ×ª×™×§ ×”×©×§×¢×•×ª ××ª×§×“× | ×¤×™× × ×¡×™-× ×˜</title>
    
    <!-- Open Graph Tags -->
    <meta property="og:title" content="× ×™×ª×•×— ×ª×™×§ ×”×©×§×¢×•×ª ××ª×§×“× - ×¤×™× × ×¡×™-× ×˜">
    <meta property="og:description" content="×§×‘×œ × ×™×ª×•×— ××§×¦×•×¢×™ ×©×œ ×ª×™×§ ×”×”×©×§×¢×•×ª ×”×¤× ×¡×™×•× ×™ ×©×œ×š ×¢× ×”××œ×¦×•×ª ××•×ª×××•×ª ××™×©×™×ª">
    <meta property="og:image" content="https://i.postimg.cc/L4YLr22D/logoxnew.png">
    <meta property="og:url" content="https://zamit00.github.io/NewFinnanciNet/advancedAnalysis.html">
    <meta property="og:type" content="website">
    
    <!-- External Styles -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="about-modal.css">
    <link rel="stylesheet" href="consultation-form.css">
    <link rel="stylesheet" href="terms-modal.css">
    <link rel="stylesheet" href="risk-quest-modal.css">
    <link rel="stylesheet" href="mainStyle.css">
    <link rel="stylesheet" href="footer.css">
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="data.js"></script>
    <script src="kochavimscript.js"></script>
    <script src="PensiaScript.js"></script>
    <script src="mainscript.js"></script>
    <script src="advancedAnalysisEngine.js"></script>
    
    <style>
        :root {
            --primary: #0183AA;
            --secondary: #764ba2;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --text-dark: #333;
            --text-light: #666;
            --bg-light: #f8f9fa;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Heebo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
            min-height: 100vh;
            direction: rtl;
            padding-top: 80px;
            padding-bottom: 50px;
        }
        
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .page-header h1 {
            background: linear-gradient(180deg, #62B1C8 0%, #2494B5 50%, #0183AA 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5rem;
            margin-bottom: 15px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .page-header p {
            color: var(--text-light);
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .page-header .subtitle {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .page-header .feature-tag {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--primary);
            font-weight: 600;
        }
        
        /* Steps Navigation */
        .steps-nav {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            gap: 10px;
            overflow-x: auto;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .step-btn {
            flex: 1;
            min-width: 150px;
            padding: 15px 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .step-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .step-btn.active {
            background: linear-gradient(180deg, #62B1C8 0%, #2494B5 50%, #0183AA 100%);
            color: white;
            border-color: transparent;
        }
        
        .step-btn.completed {
            background: var(--success);
            color: white;
            border-color: transparent;
        }
        
        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            border-radius: 50%;
            background: #e0e0e0;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .step-btn.active .step-number,
        .step-btn.completed .step-number {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .step-title {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        /* Content Panels */
        .step-panel {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease;
        }
        
        .step-panel.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .panel-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .panel-header h2 {
            color: var(--primary);
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .panel-header p {
            color: var(--text-light);
            font-size: 1.1rem;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* Buttons */
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(180deg, #62B1C8 0%, #2494B5 50%, #0183AA 100%);
            color: white;
            box-shadow: 0 4px 15px #0183AA;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px #0183AA;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        /* Risk Selection Buttons */
        #riskBtnLow:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.5) !important;
            border-color: #2e7d32 !important;
        }
        
        #riskBtnMedium:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(255, 152, 0, 0.5) !important;
            border-color: #ef6c00 !important;
        }
        
        #riskBtnHigh:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(244, 67, 54, 0.5) !important;
            border-color: #c62828 !important;
        }
        
        #riskBtnLow:active,
        #riskBtnMedium:active,
        #riskBtnHigh:active {
            transform: translateY(-1px);
        }
        
        /* Pulse Animation for selected risk button */
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.15);
            }
            100% {
                transform: scale(1.1);
            }
        }
        
        .step-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }
        
        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .status-good {
            background: #d4edda;
            color: #155724;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Analysis Cards */
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }
        
        .analysis-card {
            background: white;
            padding: 25px;
            border-radius: 16px;
            border: 1px solid #e8ecf0;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            
        }
        @media (max-width: 768px) {
            .analysis-card {
                max-width: 250px;
            }
            
            footer{max-width: 100%;box-sizing: border-box;margin: 0;padding: 0;}
        }
        
        .analysis-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(180deg, #62B1C8 0%, #2494B5 50%, #0183AA 100%);
        }
        
        .analysis-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }
        
        .analysis-card h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .analysis-card h3 i {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: var(--text-dark);
            font-weight: 500;
        }
        
        .metric-value {
            color: var(--primary);
            font-weight: 700;
        }
        
        /* Recommendations */
        .recommendation {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-right: 5px solid #e0e0e0;
        }
        
        .recommendation.good {
            border-right-color: var(--success);
        }
        
        .recommendation.warning {
            border-right-color: var(--warning);
        }
        
        .recommendation.danger {
            border-right-color: var(--danger);
        }
        
        .recommendation h4 {
            margin-bottom: 10px;
            color: var(--text-dark);
        }
        
        .recommendation p {
            color: var(--text-light);
            line-height: 1.6;
        }
        
        /* Navigation Styles */
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
        }

        .logoimg {
            width: 200px;
            height: auto;
        }

        .nav-menu {
            list-style: none;
            display: flex;
            gap: 2rem;
            align-items: center;
            margin: 0;
            padding: 0;
        }

        .nav-menu a {
            text-decoration: none;
            color: var(--text-dark);
            font-weight: 500;
            transition: color 0.3s ease;
            position: relative;
            padding: 0.5rem 0;
        }

        .nav-menu a:hover {
            color: #0183AA;
        }

        .nav-menu a::after {
            content: '';
            position: absolute;
            bottom: -5px;
            right: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(180deg, #62B1C8 0%, #2494B5 50%, #0183AA 100%);
            transition: width 0.3s ease;
        }

        .nav-menu a:hover::after {
            width: 100%;
        }

        .nav-dropdown {
            position: relative;
        }

        .nav-dropdown .dropdown-content {
            display: flex;
            flex-direction: column;
            position: absolute;
            top: calc(100% - 2px);
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
            box-shadow: none;
            min-width: 220px;
            z-index: 1001;
            margin-top: 0;
            border-top: none;
            max-height: 0;
            opacity: 0;
            visibility: hidden;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease, visibility 0.3s ease;
        }

        .nav-dropdown .dropdown-content a {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background-color 0.3s ease;
            font-size: 14px;
            border-bottom: 1px solid #eee;
        }

        .nav-dropdown .dropdown-content a:hover {
            background-color: #f5f5f5;
            color: #0183AA;
        }

        .nav-dropdown .dropdown-content a:last-child {
            border-bottom: none;
        }

        .nav-dropdown .dropdown-content.show {
            max-height: 500px;
            opacity: 1;
            visibility: visible;
        }
        
        /* Desktop hover behavior - only when not using JavaScript */
        @media (min-width: 769px) {
            .nav-dropdown:hover .dropdown-content:not(.show) {
                max-height: 500px;
                opacity: 1;
                visibility: visible;
            }
        }

        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            gap: 4px;
        }

        .hamburger span {
            width: 25px;
            height: 3px;
            background: linear-gradient(180deg, #62B1C8 0%, #2494B5 50%, #0183AA 100%);
            transition: 0.3s;
            border-radius: 3px;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        .whatsapp-mobile {
            display: none;
        }
        
        .whatsapp-desktop {
            list-style: none;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .nav-container {
                padding: 0.5rem 1rem;
                flex-direction: row-reverse;
                justify-content: flex-start;
                align-items: center;
            }

            .logoimg {
                width: 120px;
            }

            .nav-menu {
                display: none;
                position: fixed;
                top: 70px;
                right: -100%;
                width: 100%;
                height: calc(100vh - 70px);
                background: white;
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                padding-top: 1rem;
                transition: right 0.3s ease;
                box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            }

            .nav-menu.active {
                display: flex;
                right: 0;
            }

            .hamburger {
                display: flex;
                order: 0;
                margin-right: auto;
                padding-right: 15px;
            }

            .nav-menu li {
                margin: 1rem 0;
                display: flex;
                justify-content: center;
            }
            
            .whatsapp-desktop {
                display: none !important;
            }

            .whatsapp-mobile {
                display: flex !important;
                align-items: center;
                order: 1;
                margin-left: 8px;
            }
            
            .whatsapp-mobile a {
                text-decoration: none !important;
            }
            
            .whatsapp-mobile a::before,
            .whatsapp-mobile a::after {
                display: none !important;
                content: none !important;
                width: 0 !important;
            }
            
            .whatsapp-mobile i {
                font-size: 1.6rem !important;
            }
            
            .logo {
                order: 3;
                margin-left: auto;
                padding-left: 15px;
            }

            .nav-menu a {
                font-size: 1.2rem;
            }

            .nav-dropdown {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .nav-dropdown .dropdown-content {
                position: relative;
                display: flex;
                flex-direction: column;
                min-width: auto;
                width: clamp(200px, 90vw, 270px);
                max-height: 0;
                opacity: 0;
                visibility: hidden;
                overflow: hidden;
                border: none;
                background: white;
                margin: 5px auto 0;
                top: auto;
                border-radius: 15px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                padding: 0;
                transition: max-height 0.3s ease, opacity 0.3s ease, visibility 0.3s ease;
            }

            .nav-dropdown .dropdown-content a {
                padding: 8px 16px;
                border-bottom: none;
                font-size: 1rem;
                text-align: center;
            }

            .nav-dropdown .dropdown-content.show {
                max-height: 500px;
                opacity: 1;
                visibility: visible;
                padding-top: 15px;
            }
            
            .page-header h1 {
                font-size: 1.8rem;
            }
            
            .steps-nav {
                flex-direction: column;
            }
            
            .step-btn {
                min-width: 100%;
            }
            
            .step-panel {
                padding: 20px;
            }
            
            .step-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            /* ×›×¤×ª×•×¨×™ ×‘×—×™×¨×ª ×¡×™×›×•×Ÿ ×œ××•×‘×™×™×œ */
            /* ×•×“× ×©×›×¨×˜×™×¡×™×™×ª ×”×¡×™×›×•×Ÿ ××•×¦×’×ª */
            .analysis-card {
                display: block !important;
            }
            
            #manualRiskSelection {
                padding: 15px !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                margin-bottom: 20px !important;
            }
            
            #manualRiskSelection > div {
                flex-direction: column !important;
                gap: 12px !important;
                display: flex !important;
            }
            
            #riskBtnLow,
            #riskBtnMedium,
            #riskBtnHigh {
                width: 100% !important;
                min-width: 100% !important;
                max-width: 100% !important;
                flex: 0 0 100% !important;
                padding: 20px 15px !important;
                font-size: 1.2rem !important;
                justify-content: center !important;
                display: flex !important;
                align-items: center !important;
                visibility: visible !important;
                opacity: 1 !important;
                box-sizing: border-box !important;
            }
            
            #manualRiskSelection label {
                font-size: 1rem !important;
                display: block !important;
                visibility: visible !important;
            }
        }
        
        /* ××¡×›×™× ×××© ×§×˜× ×™× - 480px ×•××˜×” */
        @media screen and (max-width: 480px) {
            #riskBtnLow,
            #riskBtnMedium,
            #riskBtnHigh {
                padding: 18px 10px !important;
                font-size: 1.1rem !important;
            }
            
            #riskBtnLow i,
            #riskBtnMedium i,
            #riskBtnHigh i {
                margin-left: 5px;
            }
        }
        
        /* Analysis Tab Buttons */
        .analysis-tab-btn {
            padding: 12px 24px;
            background: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            color: lightgray;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }
        
        .analysis-tab-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: white;
            transform: translateY(-2px);
        }
        
        .analysis-tab-btn.active {
            background: white;
            color: var(--primary);
            border-color: white;
        }
        
        .analysis-tab-btn i {
            font-size: 1.1rem;
        }
        
        @media (max-width: 768px) {
            .analysis-tab-btn {
                flex: 1;
                min-width: auto;
                padding: 10px 16px;
                font-size: 0.9rem;
                justify-content: center;
            }
        }
        
        /* Scroll to Top Button - Mobile Only */
        #scrollToTopBtn {
            display: none;
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 999;
            width: 45px;
            height: 45px;
            background: linear-gradient(180deg, #62B1C8 0%, #2494B5 50%, #0183AA 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 12px #0183AA;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }
        
        #scrollToTopBtn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px #0183AA;
        }
        
        #scrollToTopBtn.show {
            display: block;
        }
        
        @media (min-width: 769px) {
            #scrollToTopBtn {
                display: none !important;
            }
        }
        
        /* Risk Distribution Card Responsive Styles */
        @media (max-width: 768px) {
            .risk-distribution-card {
                padding: 20px 15px !important;
            }
            
            .risk-card-grid {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }
            
            .risk-chart-container {
                width: 200px !important;
                height: 200px !important;
                margin: 0 auto !important;
                padding: 15px !important;
            }
            
            .risk-card-title {
                font-size: 1.3rem !important;
            }
            
            .risk-stats-section [style*="font-size: 1.3rem"] {
                font-size: 1.1rem !important;
            }
            
            .risk-stats-section [style*="font-size: 1.1rem"] {
                font-size: 1rem !important;
            }
            
            .risk-distribution-card [style*="padding: 15px"] {
                padding: 12px !important;
            }
        }
        @media (max-width: 768px) {
        #qualityAnalysis, #gapAnalysis, .analysis-grid{
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
            }

            .analysis-card{
                position: static !important;
                display: block !important; 
                margin-left: auto !important;
                margin-right: auto !important;
            }
            
            /* ×”××œ×¦×•×ª ×‘××¡×›×™× ×§×˜× ×™× - ×¡×›×•× ×•×¢×“×™×¤×•×ª ×œ××¢×œ×”, ×˜×§×¡×˜ ×œ××˜×” */
            .recommendation-header {
                flex-direction: column !important;
            }
            
            .recommendation-meta {
                order: 1 !important;
                width: 100% !important;
                margin-bottom: 10px !important;
                text-align: right !important;
            }
            
            .recommendation-text {
                order: 2 !important;
                width: 100% !important;
            }
        }

        /* Floating Advice Button */
        #adviceBtnFloat {
            display: none;
            justify-content: center;
            align-items: center;
            position: fixed;
            background-color: white;
            color: #0a4512;
            font-weight: bold;
            border: 2px solid #0183AA;
            z-index: 999;
            bottom: 20vh;
            left: 50%;
            transform: translateX(-50%);
            width: clamp(150px, 30%, 200px);
            height: 45px;
            padding: 0;
            font-size: 1rem;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 12px #0183AA;
            transition: all 0.3s ease;
        }

        #adviceBtnFloat span {
            display: block;
            text-align: center;
        }

        #adviceBtnFloat:hover {
            transform: translateX(-50%) translateY(-3px);
            box-shadow: 0 6px 16px #0183AA;
        }

        #adviceBtnFloat.show {
            display: flex;
        }

        /* Top 3 Tracks Table Responsive Styles */
        .top3-tracks-table {
            font-size: clamp(0.75rem, 1.8vw, 0.85rem);
        }

        @media (max-width: 768px) {
            .top3-tracks-table {
                font-size: 0.75rem;
            }

            .top3-tracks-table th,
            .top3-tracks-table td {
                padding: 6px 5px !important;
                font-size: 0.75rem !important;
            }

            .top3-tracks-table th:first-child,
            .top3-tracks-table td:first-child {
                min-width: 50px !important;
            }

            .top3-tracks-table th:nth-child(2),
            .top3-tracks-table td:nth-child(2) {
                min-width: 120px !important;
            }

            .top3-tracks-table th:last-child,
            .top3-tracks-table td:last-child {
                min-width: 100px !important;
            }
        }

        @media (max-width: 480px) {
            .top3-tracks-table {
                display: block;
                width: 100% !important;
                min-width: 100% !important;
                border-collapse: separate;
                border-spacing: 0;
            }

            .top3-tracks-table thead {
                display: none;
            }

            .top3-tracks-table tbody {
                display: block;
                width: 100%;
            }

            .top3-tracks-table tr {
                display: block;
                width: 100%;
                margin-bottom: 10px;
                border: 1px solid #e0e0e0;
                border-radius: 6px;
                overflow: hidden;
                background: white;
            }

            .top3-tracks-table td {
                display: block;
                width: 100% !important;
                padding: 8px 10px !important;
                text-align: center !important;
                border: none !important;
                border-bottom: 1px solid #f0f0f0;
            }

            .top3-tracks-table td:first-child {
                background: #f8f9fa;
                font-weight: bold;
                border-bottom: 2px solid #ddd;
                text-align: center !important;
                font-size: 0.85rem !important;
            }

            .top3-tracks-table td:nth-child(2) {
                min-width: 100% !important;
                padding-top: 10px !important;
                font-size: 0.8rem !important;
            }

            .top3-tracks-table td:last-child {
                border-bottom: none;
                font-weight: 600;
                padding-bottom: 10px !important;
                padding-top: 5px !important;
                font-size: 0.9rem !important;
                color: var(--primary);
            }
        }

    </style>
</head>
<body>
    
    <!-- Scroll to Top Button (Mobile Only) -->
    <button id="scrollToTopBtn" onclick="scrollToTop()" title="×—×–×•×¨ ×œ××¢×œ×”">
        <i class="fas fa-arrow-up"></i>
    </button>
    
    <!-- Floating Advice Button (shown in step 2) -->
    <button id="adviceBtnFloat" onclick="openConsultationForm()" title="×§×‘×œ ×™×™×¢×•×¥ ×—×™× ×">
        <span>×§×‘×œ ×™×™×¢×•×¥ ×—×™× ×</span>
    </button>
    
    <!-- Header with Navigation -->
    <div class="nav-container">
        <nav class="nav-menu" id="navMenu">
          <li><a href="#" onclick="navigateToHome(); return false;"><i class="fa fa-home" style="font-size:2rem"></i></a></li>
          <li class="nav-dropdown">
            <a href="#" onclick="toggleAdvProductsDropdown(event)">××•×¦×¨×™× ×•×ª×©×•××•×ª â–¼</a>
            <div class="dropdown-content" id="advProductsDropdown">
              <a href="mozarim.html?product=hishtalmut">×§×¨× ×•×ª ×”×©×ª×œ××•×ª</a>
              <a href="mozarim.html?product=gemel">×§×•×¤×•×ª ×’××œ</a>
              <a href="mozarim.html?product=gemelHashkaa">×§×•×¤×•×ª ×’××œ ×œ×”×©×§×¢×”</a>
              <a href="mozarim.html?product=yeled">×—×¡×›×•×Ÿ ×œ×™×œ×“</a>
              <a href="mozarim.html?product=polisot">×¤×•×œ×™×¡×•×ª ×—×¡×›×•×Ÿ</a>
              <a href="mozarim.html?product=pensia">×§×¨× ×•×ª ×¤× ×¡×™×” ×—×“×©×•×ª</a>
              <a href="mozarim.html?product=pensiaKlalit">×§×¨× ×•×ª ×¤× ×¡×™×” ×›×œ×œ×™×•×ª</a>
            </div>
          </li>
          <li class="nav-dropdown">
            <a href="#" onclick="toggleAdvCalculatorDropdown(event)">××—×©×‘×•× ×™× â–¼</a>
            <div class="dropdown-content" id="advCalculatorDropdown">
              <a href="prisatMaanak.html">×¤×¨×™×¡×ª ××¢× ×§ ×¤×¨×™×©×”</a>
              <a href="calac.html">××—×©×‘×•×Ÿ ×“×—×™×™×ª ×§×¦×‘×”</a>
              <a href="ribitderibit.html">×—×™×©×•×‘ ×¢×¨×š ×¢×ª×™×“×™</a>
              <a href="loan.html">×¡×™××•×œ×˜×•×¨ ×”×œ×•×•××”</a>
              <a href="hafkada.html">××—×©×‘×•×Ÿ ×”×¤×§×“×” ×œ×¡×›×•× ××˜×¨×”</a>
              <a href="hashDmeyNihul.html">×”×©×•×•××ª ×“××™ × ×™×”×•×œ</a>
            </div>
          </li>
          <li class="nav-dropdown">
            <a href="#" onclick="toggleAdvToolsDropdown(event)">×›×œ×™ ×”×©×•×•××” â–¼</a>
            <div class="dropdown-content" id="advToolsDropdown">
              <a href="hashMenahalot.html">×”×©×•×•××ª ×—×‘×¨×•×ª ×× ×”×œ×•×ª</a>
              <a href="hasifotMeshulav.html">××—×•×œ×œ ×—×©×™×¤×•×ª</a>
              <a href="VirtualInvest.html">×”×©×•×•××ª ×ª×™×§ ××©×•×œ×‘ ××¡×œ×•×œ×™×</a>
            </div>
          </li>
          <li><a href="#" onclick="openAboutModal(); return false;">××•×“×•×ª</a></li>
          <li><a href="index.html#contact">×¦×•×¨ ×§×©×¨</a></li>
          <li class="whatsapp-desktop"><a href="https://wa.me/972545287184?text=×©×œ×•×, ×× ×™ ××¢×•× ×™×™×Ÿ ×‘×™×™×¢×•×¥ ×¤× ×¡×™×•× ×™" target="_blank" title="×¦×•×¨ ×§×©×¨ ×‘×•×•××˜×¡××¤"><i class="fab fa-whatsapp" style="font-size:2rem; color:#0183AA;display:none;"></i></a></li>
        </nav>
        <div class="whatsapp-mobile">
            <a href="https://wa.me/972545287184?text=×©×œ×•×, ×× ×™ ××¢×•× ×™×™×Ÿ ×‘×™×™×¢×•×¥ ×¤× ×¡×™×•× ×™" target="_blank" title="×¦×•×¨ ×§×©×¨ ×‘×•×•××˜×¡××¤">
                <i class="fab fa-whatsapp" style="font-size:2rem; color:#0183AA;display: none;"></i>
            </a>
        </div>
        <div class="logo"> <img class="logoimg" src="https://shaham-orlan.co.il/wp-content/uploads/2023/06/logo.png" onclick="navigateToHome();" style="cursor: pointer;" title="××¢×‘×¨ ×œ×“×£ ×”×‘×™×ª"/></div>
        <div class="hamburger" id="hamburger" style="padding: 10px;">
          <span></span>
          <span></span>
          <span></span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        
        <!-- Page Header -->
        <div class="page-header" style="position: relative;">
            <button onclick="closeAdvancedAnalysis()" style="position: absolute; top: 10px; left: 10px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3); transition: all 0.3s ease; z-index: 10;" onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(220, 53, 69, 0.5)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(220, 53, 69, 0.3)';">
                <i class="fas fa-times"></i>
            </button>
            <h1>ğŸ¯ × ×™×ª×•×— ×ª×™×§ ×”×©×§×¢×•×ª ××ª×§×“×</h1>
            <p>×§×‘×œ × ×™×ª×•×— ××§×¦×•×¢×™ ×•××•×ª×× ××™×©×™×ª ×©×œ ×ª×™×§ ×”×”×©×§×¢×•×ª ×”×¤× ×¡×™×•× ×™ ×©×œ×š</p>
            <div class="subtitle">
                <div class="feature-tag">
                    <i class="fas fa-chart-line"></i>
                    <span>× ×™×ª×•×— ××™×›×•×ª</span>
                </div>
                <div class="feature-tag">
                    <i class="fas fa-shield-alt"></i>
                    <span>×”×ª×××ª ×¡×™×›×•×Ÿ</span>
                </div>
                <div class="feature-tag">
                    <i class="fas fa-coins"></i>
                    <span>××•×¤×˜×™××™×–×¦×™×” ×¤×™× × ×¡×™×ª</span>
                </div>
                <div class="feature-tag">
                    <i class="fas fa-file-pdf"></i>
                    <span>×“×•×— ××¤×•×¨×˜</span>
                </div>
            </div>
        </div>
        
        <!-- Steps Navigation -->
        <div class="steps-nav">
            <button class="step-btn active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-title">×××¤×™×™× ×™ ×œ×§×•×—</div>
            </button>
            <button class="step-btn" id="step2Btn" data-step="2" disabled>
                <div class="step-number">2</div>
                <div class="step-title">× ×™×ª×•×— ××™×›×•×ª</div>
            </button>
            <button class="step-btn" data-step="3" id="step3Btn" disabled>
                <div class="step-number">3</div>   
                <div class="step-title">××™×ª×•×¨ ×¤×¢×¨×™×</div>
            </button>
            <button class="step-btn" data-step="4" id="step4Btn" disabled>
                <div class="step-number">4</div>
                <div class="step-title">×“×•×— ×”××œ×¦×•×ª</div>
            </button>
        </div>
        
        <!-- Step 1: Client Data -->
        <div class="step-panel active" id="step-1">
            <div class="panel-header">
                <h2>×©×œ×‘ 1: × ×ª×•× ×™ ×œ×§×•×—</h2>
                <p>×¡×§×™×¨×ª ×”××™×“×¢ ×”×‘×¡×™×¡×™ ×•×”× ×›×¡×™× ×”×¤× ×¡×™×•× ×™×™× ×©×œ×š</p>
            </div>
            
            <!-- × ×ª×•× ×™ ×œ×§×•×— ×‘×¡×™×¡×™×™× -->
            <div class="analysis-grid">
                <div class="analysis-card">
                    <h3><i class="fas fa-user"></i> ×¤×¨×˜×™× ××™×©×™×™×</h3>
                    <div class="metric">
                        <span class="metric-label">×’×™×œ × ×•×›×—×™:</span>
                        <span class="metric-value" id="displayAge">-</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">×’×™×œ ×¤×¨×™×©×”:</span>
                        <span class="metric-value">67</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">×©× ×™× ×¢×“ ×¤×¨×™×©×”:</span>
                        <span class="metric-value" id="displayYearsToRetirement">-</span>
                    </div>
                </div>
                
                <div class="analysis-card">
                    <h3><i class="fas fa-briefcase"></i> ××¦×‘ ×ª×¢×¡×•×§×ª×™</h3>
                    <div class="form-group">
                        <select id="employmentStatus" style="width: 100%;">
                            <option value="">×‘×—×¨ ××¦×‘ ×ª×¢×¡×•×§×ª×™</option>
                            <option value="×©×›×™×¨">×©×›×™×¨</option>
                            <option value="×¢×¦×××™">×¢×¦×××™</option>
                            <option value="×¤×¨×•×©">×¤×•×¨×©</option>
                            <option value="××—×¨" selected>××—×¨</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- ×—×œ×•×§×ª × ×›×¡×™× -->
            <h3 style="color: var(--primary); margin: 30px 0 20px 0;">
                <i class="fas fa-chart-pie"></i>
                ×—×œ×•×§×ª ×”× ×›×¡×™×
            </h3>
            
            <div class="analysis-grid">
                <div class="analysis-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                    <h3 style="color: white; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 10px;">
                        <i class="fas fa-coins"></i>
                        ××•×¦×¨×™× ×”×•× ×™×™×
                    </h3>
                    <div style="text-align: center; margin-top: 20px;">
                        <div style="font-size: 2.5rem; font-weight: bold;" id="displayEquityTotal">â‚ª0</div>
                        <div style="opacity: 0.9; font-size: 0.9rem; margin-top: 5px;">×’××œ ×”×©×§×¢×” + ×”×©×ª×œ××•×ª + ×—×¡×›×•×Ÿ</div>
                    </div>
                </div>
                
                <div class="analysis-card" style="background: linear-gradient(180deg, #62B1C8 0%, #2494B5 50%, #0183AA 100%); color: white;">
                    <h3 style="color: white; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 10px;">
                        <i class="fas fa-umbrella"></i>
                        ××•×¦×¨×™ ×§×¦×‘×”
                    </h3>
                    <div style="text-align: center; margin-top: 20px;">
                        <div style="font-size: 2.5rem; font-weight: bold;" id="displayPensionTotal">â‚ª0</div>
                        <div style="opacity: 0.9; font-size: 0.9rem; margin-top: 5px;">×¤× ×¡×™×” + ×‘×™×˜×•×— ×× ×”×œ×™× + ×’××œ</div>
                    </div>
                </div>
            </div>
            
            <!-- ×©××œ×•×Ÿ ×¡×™×›×•×Ÿ -->
            <div class="analysis-card" style="margin-top: 30px; border: 3px solid var(--primary); background: #f8f9fa;">
                <h3 style="color: var(--primary); margin-bottom: 15px;">
                    <i class="fas fa-chart-line"></i> ×”×¢×¨×›×ª ××•×¤×™ ×¡×™×›×•×Ÿ
                </h3>
                <p style="margin-bottom: 20px; color: var(--text); font-size: 1.05rem;">
                    <strong>×‘×—×¨ ×¨××ª ×¡×™×›×•×Ÿ ×™×“× ×™×ª ××• ××œ× ×©××œ×•×Ÿ ×œ×”×¢×¨×›×” ××“×•×™×§×ª</strong>
                </p>
                
                <!-- ×‘×—×™×¨×” ×™×“× ×™×ª -->
                <div id="manualRiskSelection" style="margin-bottom: 25px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <label style="display: block; margin-bottom: 15px; font-weight: 700; color: var(--text-dark); font-size: 1.1rem;">
                        <i class="fas fa-hand-pointer"></i>
                        ×‘×—×™×¨×” ×™×“× ×™×ª:
                    </label>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="btn" onclick="setManualRisk('× ××•×š')" id="riskBtnLow" 
                                style="flex: 1; min-width: 120px; padding: 18px 25px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); color: #1b5e20; border: 3px solid #4caf50; font-size: 1.1rem; font-weight: 700; box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3); transition: all 0.3s ease;">
                            <i class="fas fa-shield-alt"></i> × ××•×š
                        </button>
                        <button class="btn" onclick="setManualRisk('×‘×™× ×•× ×™')" id="riskBtnMedium"
                                style="flex: 1; min-width: 120px; padding: 18px 25px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); color: #e65100; border: 3px solid #ff9800; font-size: 1.1rem; font-weight: 700; box-shadow: 0 4px 10px rgba(255, 152, 0, 0.3); transition: all 0.3s ease;">
                            <i class="fas fa-chart-line"></i> ×‘×™× ×•× ×™
                        </button>
                        <button class="btn" onclick="setManualRisk('×’×‘×•×”')" id="riskBtnHigh"
                                style="flex: 1; min-width: 120px; padding: 18px 25px; background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); color: #b71c1c; border: 3px solid #f44336; font-size: 1.1rem; font-weight: 700; box-shadow: 0 4px 10px rgba(244, 67, 54, 0.3); transition: all 0.3s ease;">
                            <i class="fas fa-rocket"></i> ×’×‘×•×”
                        </button>
                    </div>
                </div>
                
                <div id="orDivider" style="text-align: center; margin: 25px 0; position: relative;">
                    <span style="background: #f8f9fa; padding: 0 15px; color: var(--text-light); font-weight: 600; font-size: 1.1rem; position: relative; z-index: 1;">
                        ××•
                    </span>
                    <div style="position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: linear-gradient(to right, transparent, #ddd, transparent); z-index: 0;"></div>
                </div>
                
                <!-- ×©××œ×•×Ÿ -->
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <button class="btn btn-primary" onclick="openRiskQuestModalAndReturn()" 
                            style="width: 100%; justify-content: center; padding: 18px 25px; font-size: 1.15rem; font-weight: 700; box-shadow: 0 4px 15px #0183AA;">
                        <i class="fas fa-clipboard-list"></i>
                        ××œ× ×©××œ×•×Ÿ ×¡×™×›×•×Ÿ ××§×¦×•×¢×™
                    </button>
                </div>
                
                <div id="riskResult" style="margin-top: 20px; padding: 15px; background: white; border-radius: 12px; border-right: 4px solid var(--primary); display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div class="metric">
                        <span class="metric-label" style="font-size: 1.1rem; font-weight: 600;">×¨××ª ×¡×™×›×•×Ÿ ×©× ×‘×—×¨×”:</span>
                        <span class="status-badge" id="riskBadge" style="font-size: 1.1rem; padding: 8px 16px;"></span>
                    </div>
                </div>
            </div>
            
            <div class="step-actions">
                <div></div>
                <button class="btn btn-primary" id="saveStep1AndContinueBtn" onclick="saveStep1AndContinue()" disabled>
                    ×”××©×š ×œ× ×™×ª×•×— ××™×›×•×ª
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>
        
        <!-- Step 2: Quality Analysis -->
        <div class="step-panel" id="step-2">
            <div class="panel-header">
                <h2>×©×œ×‘ 2: × ×™×ª×•×— ××™×›×•×ª ×”×©×§×¢×”</h2>
                <p>×”×©×•×•××ª ×”×‘×™×¦×•×¢×™× ×©×œ×š ×œ×××•×¦×¢ ×”×¢× ×£</p>
            </div>
            
            <!-- ×›×¤×ª×•×¨×™ × ×™×•×•×˜ ×œ××¢×œ×” -->
            <div class="step-actions" style="margin-bottom: 30px;">
                <button class="btn btn-secondary" onclick="goToStep(1)">
                    <i class="fas fa-arrow-right"></i>
                    ×—×–×•×¨ ×œ×©×œ×‘ 1
                </button>
                <button class="btn btn-primary" onclick="goToStep(3)">
                    ×”××©×š ×œ×©×œ×‘ 3
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
            
            <div id="qualityAnalysis">
                <!-- Will be populated dynamically -->
            </div>
            
            <!-- ×›×¤×ª×•×¨×™ × ×™×•×•×˜ ×œ××˜×” -->
            <div class="step-actions">
                <button class="btn btn-secondary" onclick="goToStep(1)">
                    <i class="fas fa-arrow-right"></i>
                    ×—×–×•×¨ ×œ×©×œ×‘ 1
                </button>
                <button class="btn btn-primary" onclick="goToStep(3)">
                    ×”××©×š ×œ×©×œ×‘ 3
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>
        
        <!-- Step 3: Gap Analysis -->
        <div class="step-panel" id="step-3">
            <div class="panel-header">
                <h2>×©×œ×‘ 3: ××™×ª×•×¨ ×¤×¢×¨×™× ×•×”×–×“×× ×•×™×•×ª</h2>
                <p>×–×™×”×•×™ ××–×•×¨×™× ×œ×©×™×¤×•×¨ ×•××•×¤×˜×™××™×–×¦×™×”</p>
            </div>
            
            <!-- ×›×¤×ª×•×¨×™ × ×™×•×•×˜ ×œ××¢×œ×” -->
            <div class="step-actions" style="margin-bottom: 30px;">
                <button class="btn btn-secondary" onclick="goToStep(2)">
                    <i class="fas fa-arrow-right"></i>
                    ×—×–×•×¨ ×œ×©×œ×‘ 2
                </button>
                <button class="btn btn-primary" onclick="goToStep(4)">
                    ×”××©×š ×œ×©×œ×‘ 4
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
            
            <div id="gapAnalysis">
                <!-- Will be populated dynamically -->
            </div>
            
            <!-- ×›×¤×ª×•×¨×™ × ×™×•×•×˜ ×œ××˜×” -->
            <div class="step-actions">
                <button class="btn btn-secondary" onclick="goToStep(2)">
                    <i class="fas fa-arrow-right"></i>
                    ×—×–×•×¨ ×œ×©×œ×‘ 2
                </button>
                <button class="btn btn-primary" onclick="goToStep(4)">
                    ×”××©×š ×œ×©×œ×‘ 4
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>
        
        <!-- Step 4: Recommendations Report -->
        <div class="step-panel" id="step-4">
            <div class="panel-header">
                <h2>×©×œ×‘ 4: ×“×•×— ×”××œ×¦×•×ª</h2>
                <p>×¡×™×›×•× ××§×™×£ ×•×”××œ×¦×•×ª ×¤×¢×•×œ×”</p>
            </div>
            
            <!-- ×›×¤×ª×•×¨×™ × ×™×•×•×˜ ×œ××¢×œ×” -->
            <div class="step-actions" style="margin-bottom: 30px;">
                <button class="btn btn-secondary" onclick="goToStep(3)">
                    <i class="fas fa-arrow-right"></i>
                    ×—×–×•×¨ ×œ×©×œ×‘ 3
                </button>
                <button class="btn btn-primary" onclick="generatePDFReport()">
                    <i class="fas fa-file-pdf"></i>
                    ×”×•×¨×“ ×“×•×— PDF
                </button>
            </div>
            
            <div id="recommendationsReport">
                <!-- Will be populated dynamically -->
            </div>
            
            <!-- ×›×¤×ª×•×¨×™ × ×™×•×•×˜ ×œ××˜×” -->
            <div class="step-actions">
                <button class="btn btn-secondary" onclick="goToStep(3)">
                    <i class="fas fa-arrow-right"></i>
                    ×—×–×•×¨ ×œ×©×œ×‘ 3
                </button>
                <button class="btn btn-primary" onclick="generatePDFReport()">
                    <i class="fas fa-file-pdf"></i>
                    ×”×•×¨×“ ×“×•×— PDF
                </button>
            </div>
        </div>
        
    </div>

    <!-- Modal Container -->
    <div id="modals-container"></div>

    <!-- External Modal Scripts -->
    <script src="about-modal.js"></script>
    <script src="consultation-form.js"></script>
    <script src="terms-modal.js"></script>
    <script src="risk-quest-modal.js"></script>
    <script src="accessibility.js"></script>
    
    <script>
        // Load Modal HTML files
        fetch('about-modal.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('modals-container').innerHTML += html;
            })
            .catch(err => console.error('Error loading about modal:', err));
        
        fetch('terms-modal.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('modals-container').innerHTML += html;
            })
            .catch(err => console.error('Error loading terms modal:', err));
        
        fetch('consultation-form.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('modals-container').innerHTML += html;
            })
            .catch(err => console.error('Error loading consultation form:', err));
        
        fetch('risk-quest-modal.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('modals-container').innerHTML += html;
            })
            .catch(err => console.error('Error loading risk quest modal:', err));
        
        // Load Footer
        fetch('footer.html')
            .then(response => response.text())
            .then(html => {
                document.body.insertAdjacentHTML('beforeend', html);
            })
            .catch(err => console.error('Error loading footer:', err));
        
        // Navigation functions
        function goToStep(stepNumber) {
            // ×‘×“×™×§×” ×× ×× ×¡×™× ×œ×¢×‘×•×¨ ×œ×©×œ×‘ 2 ×•××¢×œ×” ×œ×œ× ×¨××ª ×¡×™×›×•×Ÿ
            if (stepNumber >= 2 && (!clientAnalysisData.profile.riskProfile || clientAnalysisData.profile.riskProfile === "")) {
                Swal.fire({
                    title: '×¨××ª ×¡×™×›×•×Ÿ × ×“×¨×©×ª',
                    text: '× × ×œ×‘×—×•×¨ ×¨××ª ×¡×™×›×•×Ÿ ××• ×œ××œ× ×©××œ×•×Ÿ ×‘×©×œ×‘ 1 ×œ×¤× ×™ ×”××©×š',
                    icon: 'warning',
                    confirmButtonText: '×”×‘× ×ª×™'
                });
                // ×—×–×¨×” ×œ×©×œ×‘ 1
                stepNumber = 1;
            }
            
            // Hide all panels
            document.querySelectorAll('.step-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Remove active state from all buttons
            document.querySelectorAll('.step-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.step) < stepNumber) {
                    btn.classList.add('completed');
                } else {
                    btn.classList.remove('completed');
                }
            });
            
            // Show selected panel
            document.getElementById(`step-${stepNumber}`).classList.add('active');
            
            // Set active button
            document.querySelector(`.step-btn[data-step="${stepNumber}"]`).classList.add('active');
            
            // ×§×¨×™××” ×œ×¤×•× ×§×¦×™×•×ª ×¡×¤×¦×™×¤×™×•×ª ×œ×›×œ ×©×œ×‘
            if (stepNumber === 2) {
                analyzeQuality();
            } else if (stepNumber === 3) {
                analyzeGaps();
            } else if (stepNumber === 4) {
                generateRecommendations();
            }
            
            // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨ ×”×™×™×¢×•×¥ - ×™×•×¤×™×¢ ×¨×§ ×‘×©×œ×‘ 2
            setTimeout(updateAdviceButton, 100);
            
            // Scroll to top
            window.scrollTo({
  top: (document.body.scrollHeight - window.innerHeight) / 5,
  behavior: 'smooth'
});   }
        
        // Step buttons click handler
        document.querySelectorAll('.step-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const step = parseInt(this.dataset.step);
                goToStep(step);
            });
        });
        
        // Dropdown functions for mobile menu
        function toggleAdvProductsDropdown(event) {
            if (!event) event = window.event;
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            const dropdown = document.getElementById('advProductsDropdown');
            if (!dropdown) return false;
            // Find the link - could be event.target or its parent
            let link = null;
            if (event && event.target) {
                link = event.target.closest ? event.target.closest('a') : null;
                if (!link && event.target.tagName === 'A') link = event.target;
            }
            if (!link) link = dropdown.closest('.nav-dropdown')?.querySelector('a');
            
            // ×‘××¡×›×™× ×’×“×•×œ×™×, ×”×ª×¤×¨×™×˜ × ×¤×ª×— ×‘-hover (CSS), ××– ×œ× ×¦×¨×™×š ×œ×¢×©×•×ª ×›×œ×•×
            if (window.innerWidth > 768) {
                return false;
            }
            
            document.querySelectorAll('.dropdown-content.show').forEach(d => {
                if (d !== dropdown) {
                    d.classList.remove('show');
                    const parentLi = d.closest('.nav-dropdown');
                    const parentLink = parentLi?.querySelector('a');
                    if (parentLink) {
                        if (d.id === 'advCalculatorDropdown') {
                            parentLink.innerHTML = '××—×©×‘×•× ×™× â–¼';
                        } else if (d.id === 'advToolsDropdown') {
                            parentLink.innerHTML = '×›×œ×™ ×”×©×•×•××” â–¼';
                        }
                    }
                }
            });
            
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                if (link) link.innerHTML = '××•×¦×¨×™× ×•×ª×©×•××•×ª â–¼';
            } else {
                dropdown.classList.add('show');
                if (link) link.innerHTML = '××•×¦×¨×™× ×•×ª×©×•××•×ª â–²';
            }
            
            return false;
        }
        
        function toggleAdvCalculatorDropdown(event) {
            if (!event) event = window.event;
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            const dropdown = document.getElementById('advCalculatorDropdown');
            if (!dropdown) return false;
            // Find the link - could be event.target or its parent
            let link = null;
            if (event && event.target) {
                link = event.target.closest ? event.target.closest('a') : null;
                if (!link && event.target.tagName === 'A') link = event.target;
            }
            if (!link) link = dropdown.closest('.nav-dropdown')?.querySelector('a');
            
            // ×‘××¡×›×™× ×’×“×•×œ×™×, ×”×ª×¤×¨×™×˜ × ×¤×ª×— ×‘-hover (CSS), ××– ×œ× ×¦×¨×™×š ×œ×¢×©×•×ª ×›×œ×•×
            if (window.innerWidth > 768) {
                return false;
            }
            
            document.querySelectorAll('.dropdown-content.show').forEach(d => {
                if (d !== dropdown) {
                    d.classList.remove('show');
                    const parentLi = d.closest('.nav-dropdown');
                    const parentLink = parentLi?.querySelector('a');
                    if (parentLink) {
                        if (d.id === 'advProductsDropdown') {
                            parentLink.innerHTML = '××•×¦×¨×™× ×•×ª×©×•××•×ª â–¼';
                        } else if (d.id === 'advToolsDropdown') {
                            parentLink.innerHTML = '×›×œ×™ ×”×©×•×•××” â–¼';
                        }
                    }
                }
            });
            
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                if (link) link.innerHTML = '××—×©×‘×•× ×™× â–¼';
            } else {
                dropdown.classList.add('show');
                if (link) link.innerHTML = '××—×©×‘×•× ×™× â–²';
            }
            
            return false;
        }

        function toggleAdvToolsDropdown(event) {
            if (!event) event = window.event;
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            const dropdown = document.getElementById('advToolsDropdown');
            if (!dropdown) return false;
            // Find the link - could be event.target or its parent
            let link = null;
            if (event && event.target) {
                link = event.target.closest ? event.target.closest('a') : null;
                if (!link && event.target.tagName === 'A') link = event.target;
            }
            if (!link) link = dropdown.closest('.nav-dropdown')?.querySelector('a');
            
            // ×‘××¡×›×™× ×’×“×•×œ×™×, ×”×ª×¤×¨×™×˜ × ×¤×ª×— ×‘-hover (CSS), ××– ×œ× ×¦×¨×™×š ×œ×¢×©×•×ª ×›×œ×•×
            if (window.innerWidth > 768) {
                return false;
            }
            
            document.querySelectorAll('.dropdown-content.show').forEach(d => {
                if (d !== dropdown) {
                    d.classList.remove('show');
                    const parentLi = d.closest('.nav-dropdown');
                    const parentLink = parentLi?.querySelector('a');
                    if (parentLink) {
                        if (d.id === 'advProductsDropdown') {
                            parentLink.innerHTML = '××•×¦×¨×™× ×•×ª×©×•××•×ª â–¼';
                        } else if (d.id === 'advCalculatorDropdown') {
                            parentLink.innerHTML = '××—×©×‘×•× ×™× â–¼';
                        }
                    }
                }
            });
            
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                if (link) link.innerHTML = '×›×œ×™ ×”×©×•×•××” â–¼';
            } else {
                dropdown.classList.add('show');
                if (link) link.innerHTML = '×›×œ×™ ×”×©×•×•××” â–²';
            }
            
            return false;
        }
        
        // Close nav dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            document.querySelectorAll('.dropdown-content.show').forEach(d => {
                if (!d.contains(event.target)) {
                    const parentLi = d.closest('.nav-dropdown');
                    const parentLink = parentLi?.querySelector('a');
                    if (parentLink && !parentLink.contains(event.target)) {
                        d.classList.remove('show');
                        if (d.id === 'advProductsDropdown') {
                            parentLink.innerHTML = '××•×¦×¨×™× ×•×ª×©×•××•×ª â–¼';
                        } else if (d.id === 'advCalculatorDropdown') {
                            parentLink.innerHTML = '××—×©×‘×•× ×™× â–¼';
                        } else if (d.id === 'advToolsDropdown') {
                            parentLink.innerHTML = '×›×œ×™ ×”×©×•×•××” â–¼';
                        }
                    }
                }
            });
        });

        // Close nav dropdown when clicking on links
        document.addEventListener('click', function(event) {
            if (event.target.closest('#advProductsDropdown a')) {
                const navDropdown = document.getElementById('advProductsDropdown');
                const navLink = navDropdown?.closest('.nav-dropdown')?.querySelector('a');
                
                if (navDropdown) navDropdown.classList.remove('show');
                if (navLink) navLink.innerHTML = '××•×¦×¨×™× ×•×ª×©×•××•×ª â–¼';
            }
            
            if (event.target.closest('#advCalculatorDropdown a')) {
                const navDropdown = document.getElementById('advCalculatorDropdown');
                const navLink = navDropdown?.closest('.nav-dropdown')?.querySelector('a');
                
                if (navDropdown) navDropdown.classList.remove('show');
                if (navLink) navLink.innerHTML = '××—×©×‘×•× ×™× â–¼';
            }
            
            if (event.target.closest('#advToolsDropdown a')) {
                const navDropdown = document.getElementById('advToolsDropdown');
                const navLink = navDropdown?.closest('.nav-dropdown')?.querySelector('a');
                
                if (navDropdown) navDropdown.classList.remove('show');
                if (navLink) navLink.innerHTML = '×›×œ×™ ×”×©×•×•××” â–¼';
            }
        });

            // Ensure nav dropdown links work properly
        document.querySelectorAll('#advProductsDropdown a, #advCalculatorDropdown a, #advToolsDropdown a').forEach(link => {
            link.addEventListener('click', function(e) {
                // Don't prevent default - let the link work normally
                e.stopPropagation();
                
                // Close dropdown after a short delay to allow navigation
                setTimeout(() => {
                    const allDropdowns = ['advProductsDropdown', 'advCalculatorDropdown', 'advToolsDropdown'];
                    allDropdowns.forEach(dropdownId => {
                        const dropdown = document.getElementById(dropdownId);
                        const dropdownLink = dropdown?.closest('.nav-dropdown')?.querySelector('a');
                        
                        if (dropdown) {
                            dropdown.classList.remove('show');
                        }
                        if (dropdownLink) {
                            if (dropdownId.includes('Products')) {
                                dropdownLink.innerHTML = '××•×¦×¨×™× ×•×ª×©×•××•×ª â–¼';
                            } else if (dropdownId.includes('Calculator')) {
                                dropdownLink.innerHTML = '××—×©×‘×•× ×™× â–¼';
                            } else if (dropdownId.includes('Tools')) {
                                dropdownLink.innerHTML = '×›×œ×™ ×”×©×•×•××” â–¼';
                            }
                        }
                    });
                }, 100);
            });
        });

        // Hamburger menu functionality
        document.addEventListener('DOMContentLoaded', function() {
            // ×˜×¢×™× ×ª ×›×œ ×”× ×ª×•× ×™× ×”×’×œ×•×‘×œ×™×™× (dataIndicators)
            if (typeof loadalldata === 'function') {
                loadalldata().then(() => {
                });
            }
            
            const hamburger = document.getElementById('hamburger');
            const navMenu = document.getElementById('navMenu');
            
            if (hamburger && navMenu) {
                hamburger.addEventListener('click', function() {
                    this.classList.toggle('active');
                    navMenu.classList.toggle('active');
                });

                document.addEventListener('click', function(e) {
                    if (!hamburger.contains(e.target) && !navMenu.contains(e.target)) {
                        navMenu.classList.remove('active');
                        hamburger.classList.remove('active');
                    }
                });

                document.querySelectorAll('.nav-menu a').forEach(link => {
                    link.addEventListener('click', function(e) {
                        if (window.innerWidth <= 768 && !this.hasAttribute('onclick')) {
                            navMenu.classList.remove('active');
                            hamburger.classList.remove('active');
                        }
                    });
                });
            }
            
            // × ×™×ª×•×— ××•×˜×•××˜×™ ×©×œ × ×ª×•× ×™× ×§×™×™××™× ×‘×¢×ª ×˜×¢×™× ×ª ×”×“×£
            setTimeout(function() {
                // ×§×¨×™××ª × ×ª×•× ×™× ×-sessionStorage
                const importedData = importAndClearSessionData();
                // ×¢×“×›×•×Ÿ ×‘-clientAnalysisData
                if (importedData.age) {
                    clientAnalysisData.profile.age = importedData.age;
                    clientAnalysisData.profile.yearsToRetirement = importedData.yearsToRetirement;
                    clientAnalysisData.portfolio.equityTotal = importedData.equityTotal;
                    clientAnalysisData.portfolio.pensionTotal = importedData.pensionTotal;
                    clientAnalysisData.portfolio.totalValue = importedData.equityTotal + importedData.pensionTotal;
                    
                    // ×©××™×¨×ª ×”× ×ª×•× ×™× ×”××¤×•×¨×˜×™×
                    clientAnalysisData.detailedData = importedData.detailedData;
                    
                    // ×˜×¢×™× ×ª ×¨××ª ×¡×™×›×•×Ÿ ×× ×§×™×™××ª
                    if (importedData.riskProfile) {
                        clientAnalysisData.profile.riskProfile = importedData.riskProfile;
                        clientAnalysisData.profile.riskScore = importedData.riskScore;
                        clientAnalysisData.profile.riskSource = importedData.riskSource || "";
                        
                        // ×”×¦×’×ª ×¨××ª ×”×¡×™×›×•×Ÿ ×©× ×˜×¢× ×”
                        const riskResult = document.getElementById('riskResult');
                        const riskBadge = document.getElementById('riskBadge');
                        if (riskResult && riskBadge) {
                            riskResult.style.display = 'block';
                            riskBadge.textContent = importedData.riskProfile;
                            
                            // ×¦×‘×™×¢×” ×œ×¤×™ ×¨××”
                            if (importedData.riskProfile === '× ××•×š') {
                                riskBadge.className = 'status-badge status-good';
                            } else if (importedData.riskProfile === '×‘×™× ×•× ×™') {
                                riskBadge.className = 'status-badge status-warning';
                            } else {
                                riskBadge.className = 'status-badge status-danger';
                            }
                        }
                        
                        // ×”×“×’×©×ª ×”×›×¤×ª×•×¨ ×”× ×›×•×Ÿ ×× ×–×” ×‘×—×™×¨×” ×™×“× ×™×ª
                        if (importedData.riskSource === 'manual') {
                            setTimeout(() => {
                                document.querySelectorAll('#riskBtnLow, #riskBtnMedium, #riskBtnHigh').forEach(btn => {
                                    btn.style.opacity = '0.4';
                                    btn.style.transform = 'scale(0.95)';
                                    btn.style.filter = 'grayscale(0.5)';
                                });
                                
                                const selectedBtn = document.getElementById(
                                    importedData.riskProfile === '× ××•×š' ? 'riskBtnLow' : 
                                    importedData.riskProfile === '×‘×™× ×•× ×™' ? 'riskBtnMedium' : 
                                    'riskBtnHigh'
                                );
                                if (selectedBtn) {
                                    selectedBtn.style.opacity = '1';
                                    selectedBtn.style.transform = 'scale(1.1)';
                                    selectedBtn.style.filter = 'grayscale(0)';
                                    selectedBtn.style.boxShadow = '0 8px 20px #0183AA';
                                }
                            }, 100);
                        }
                    }
                    
                    AnalysisStorage.save();
                    
                    
                    // ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
                    updateStep1Display();
                    
                    // ×•×“× ×©×›×¤×ª×•×¨×™ ×”×¡×™×›×•×Ÿ ××•×¦×’×™× (×‘××™×•×—×“ ×‘××•×‘×™×™×œ)
                    setTimeout(() => {
                        const manualRiskDiv = document.getElementById('manualRiskSelection');
                        const riskBtnLow = document.getElementById('riskBtnLow');
                        const riskBtnMedium = document.getElementById('riskBtnMedium');
                        const riskBtnHigh = document.getElementById('riskBtnHigh');
                        
                        // ×•×“× ×©×”× ××•×¦×’×™×
                        if (manualRiskDiv && clientAnalysisData.profile.riskSource !== 'questionnaire') {
                            manualRiskDiv.style.display = 'block';
                            manualRiskDiv.style.visibility = 'visible';
                            manualRiskDiv.style.opacity = '1';
                        }
                    }, 100);
                } else {
                    console.log('â„¹ï¸ ×œ× × ××¦××• × ×ª×•× ×™× - × × ×œ×”×¢×œ×•×ª ×§×‘×¦×™ ××¡×œ×§×” ×‘×“×£ ×”×‘×™×ª');
                }
            }, 500);
        });
        
        // ×¢×“×›×•×Ÿ ×ª×¦×•×’×ª ×©×œ×‘ 1 ×¢× × ×ª×•× ×™× ×§×™×™××™×
        function updateStep1Display() {
            // ×”×¦×’×ª ×’×™×œ
            if (clientAnalysisData.profile.age) {
                const ageEl = document.getElementById('displayAge');
                if (ageEl) {
                    ageEl.textContent = clientAnalysisData.profile.age;
                }
                
                // ×”×¦×’×ª ×©× ×™× ×¢×“ ×¤×¨×™×©×”
                const yearsEl = document.getElementById('displayYearsToRetirement');
                if (yearsEl && clientAnalysisData.profile.yearsToRetirement !== undefined) {
                    yearsEl.textContent = clientAnalysisData.profile.yearsToRetirement + ' ×©× ×™×';
                }
            }
            
            // ×”×¦×’×ª ×¡×›×•××™ ××•×¦×¨×™×
            if (clientAnalysisData.portfolio.equityTotal !== undefined) {
                const equityEl = document.getElementById('displayEquityTotal');
                if (equityEl) {
                    equityEl.textContent = AnalysisUtils.formatCurrency(clientAnalysisData.portfolio.equityTotal);
                }
            }
            
            if (clientAnalysisData.portfolio.pensionTotal !== undefined) {
                const pensionEl = document.getElementById('displayPensionTotal');
                if (pensionEl) {
                    pensionEl.textContent = AnalysisUtils.formatCurrency(clientAnalysisData.portfolio.pensionTotal);
                }
            }
            
            // ×”×¡×ª×¨×ª ×‘×—×™×¨×” ×™×“× ×™×ª ×× ××•×œ× ×©××œ×•×Ÿ
            if (clientAnalysisData.profile.riskSource === 'questionnaire') {
                const manualSelectionDiv = document.getElementById('manualRiskSelection');
                const orDivider = document.getElementById('orDivider');
                if (manualSelectionDiv) {
                    manualSelectionDiv.style.display = 'none';
                }
                if (orDivider) {
                    orDivider.style.display = 'none';
                }
            }
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×§×‘×™×¢×ª ×¨××ª ×¡×™×›×•×Ÿ ×™×“× ×™×ª
        function setManualRisk(riskLevel) {
            // ×©××™×¨×ª ×¨××ª ×”×¡×™×›×•×Ÿ
            clientAnalysisData.profile.riskProfile = riskLevel;
            clientAnalysisData.profile.riskScore = null; // ××™×Ÿ ×¦×™×•×Ÿ ×›×™ ×–×” ×™×“× ×™
            clientAnalysisData.profile.riskSource = 'manual'; // ××§×•×¨: ×‘×—×™×¨×” ×™×“× ×™×ª
            document.getElementById('saveStep1AndContinueBtn').disabled = false;
            document.getElementById('step2Btn').disabled = false;
            document.getElementById('step3Btn').disabled = false;
            document.getElementById('step4Btn').disabled = false;
            AnalysisStorage.save();
            
            // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨×™× - ××™×¤×•×¡ ×›×œ ×”×›×¤×ª×•×¨×™×
            document.querySelectorAll('#riskBtnLow, #riskBtnMedium, #riskBtnHigh').forEach(btn => {
                btn.style.opacity = '0.4';
                btn.style.transform = 'scale(0.95)';
                btn.style.filter = 'grayscale(0.5)';
            });
            
            const selectedBtn = document.getElementById(
                riskLevel === '× ××•×š' ? 'riskBtnLow' : 
                riskLevel === '×‘×™× ×•× ×™' ? 'riskBtnMedium' : 
                'riskBtnHigh'
            );
            if (selectedBtn) {
                selectedBtn.style.opacity = '1';
                selectedBtn.style.transform = 'scale(1.1)';
                selectedBtn.style.filter = 'grayscale(0)';
                selectedBtn.style.boxShadow = '0 8px 20px #0183AA';
                
                // ×× ×™××¦×™×” ×©×œ "pulse"
                selectedBtn.style.animation = 'pulse 0.5s ease-in-out';
            }
            
            // ×”×¦×’×ª ×”×ª×•×¦××”
            const riskResult = document.getElementById('riskResult');
            const riskBadge = document.getElementById('riskBadge');
            
            if (riskResult && riskBadge) {
                riskResult.style.display = 'block';
                riskBadge.textContent = riskLevel + ' (×‘×—×™×¨×” ×™×“× ×™×ª)';
                
                // ×¦×‘×™×¢×” ×œ×¤×™ ×¨××”
                if (riskLevel === '× ××•×š') {
                    riskBadge.className = 'status-badge status-good';
                } else if (riskLevel === '×‘×™× ×•× ×™') {
                    riskBadge.className = 'status-badge status-warning';
                } else {
                    riskBadge.className = 'status-badge status-danger';
                }
            }
            
            // ×”×•×“×¢×ª ×”×¦×œ×—×”
            Swal.fire({
                title: '× ×©××¨!',
                text: `×¨××ª ×”×¡×™×›×•×Ÿ ×©×œ×š × ×§×‘×¢×” ×œ: ${riskLevel}`,
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            });
        }
        
        // ×¤×ª×™×—×ª ×©××œ×•×Ÿ ×¡×™×›×•×Ÿ ×•×”×—×–×¨×ª ×ª×•×¦××”
        function openRiskQuestModalAndReturn() {
            const ageEl = document.getElementById('displayAge');
            if(!ageEl || !ageEl.textContent || ageEl.textContent === '-') {
                Swal.fire({
                    title: '×—×¡×¨×™× × ×ª×•× ×™×',
                    text: '× × ×œ×”×¢×œ×•×ª ×§×‘×¦×™ ××¡×œ×§×” ×‘×“×£ ×”×‘×™×ª ×ª×—×™×œ×”',
                    icon: 'warning'
                });
                return;
            }
            if (typeof openRiskQuestModal === 'function') {
                openRiskQuestModal();
                
                // ×”××–× ×” ×œ×¡×™×•× ×”×©××œ×•×Ÿ
                window.addEventListener('riskQuestComplete', function(event) {
                    if (event.detail && event.detail.riskLevel) {
                        const riskLevel = event.detail.riskLevel;
                        
                        // ×©××™×¨×ª ×¨××ª ×”×¡×™×›×•×Ÿ
                        clientAnalysisData.profile.riskProfile = riskLevel;
                        clientAnalysisData.profile.riskScore = event.detail.score || 0;
                        clientAnalysisData.profile.riskSource = 'questionnaire'; // ××§×•×¨: ×©××œ×•×Ÿ
                        AnalysisStorage.save();
                        
                        // ×©××™×¨×” ×’× ×‘-sessionStorage ×œ××§×¨×” ×©×œ ××¢×‘×¨ ×‘×™×Ÿ ×“×¤×™×
                        sessionStorage.setItem('riskProfile', riskLevel);
                        sessionStorage.setItem('riskScore', event.detail.score || 0);
                        sessionStorage.setItem('riskSource', 'questionnaire');
                        
                        // ×”×¡×ª×¨×ª ×”×‘×—×™×¨×” ×”×™×“× ×™×ª ××—×¨×™ ×©××œ×•×Ÿ
                        const manualSelectionDiv = document.getElementById('manualRiskSelection');
                        const orDivider = document.getElementById('orDivider');
                        if (manualSelectionDiv) {
                            manualSelectionDiv.style.display = 'none';
                        }
                        if (orDivider) {
                            orDivider.style.display = 'none';
                        }
                        
                        // ×”×¦×’×ª ×”×ª×•×¦××”
                        const riskResult = document.getElementById('riskResult');
                        const riskBadge = document.getElementById('riskBadge');
                        
                        if (riskResult && riskBadge) {
                            riskResult.style.display = 'block';
                            document.getElementById('saveStep1AndContinueBtn').disabled = false;
                            document.getElementById('step2Btn').disabled = false;
                            document.getElementById('step3Btn').disabled = false;
                            document.getElementById('step4Btn').disabled = false;  
                            riskBadge.textContent = riskLevel + ' (×©××œ×•×Ÿ ××§×¦×•×¢×™)';
                            
                            // ×¦×‘×™×¢×” ×œ×¤×™ ×¨××”
                            if (riskLevel === '× ××•×š') {
                                riskBadge.className = 'status-badge status-good';
                            } else if (riskLevel === '×‘×™× ×•× ×™') {
                                riskBadge.className = 'status-badge status-warning';
                            } else {
                                riskBadge.className = 'status-badge status-danger';
                            }
                        }
                        
                    }
                }, { once: true });
            } else {
                Swal.fire({
                    title: '×©××œ×•×Ÿ ×¡×™×›×•×Ÿ',
                    text: '×©××œ×•×Ÿ ×”×¡×™×›×•×Ÿ ×œ× ×–××™×Ÿ ×›×¨×’×¢',
                    icon: 'warning'
                });
            }
        }
        
        // ×©××™×¨×ª × ×ª×•× ×™ ×©×œ×‘ 1 ×•×”××©×š
        function saveStep1AndContinue() {
            const employmentStatus = document.getElementById('employmentStatus').value;
            
            // ×‘×“×™×§×ª ×©×“×•×ª ×—×•×‘×”
            if (!employmentStatus) {
                Swal.fire({
                    title: '×©×“×” ×—×•×‘×”',
                    text: '× × ×œ×‘×—×•×¨ ××¦×‘ ×ª×¢×¡×•×§×ª×™',
                    icon: 'warning',
                    confirmButtonText: '×”×‘× ×ª×™'
                });
                return;
            }
            
            // ×‘×“×™×§×” ×× ××™×œ× ×©××œ×•×Ÿ ×¡×™×›×•×Ÿ - ×—×•×‘×”!
            if (!clientAnalysisData.profile.riskProfile || clientAnalysisData.profile.riskProfile === "") {
                Swal.fire({
                    title: '×¨××ª ×¡×™×›×•×Ÿ × ×“×¨×©×ª',
                    text: '×œ× × ×™×ª×Ÿ ×œ×”××©×™×š ×œ×œ× ××™×œ×•×™ ×©××œ×•×Ÿ ×¡×™×›×•×Ÿ ××• ×‘×—×™×¨×ª ×¨××ª ×”×¡×™×›×•×Ÿ',
                    icon: 'warning',
                    confirmButtonText: '×”×‘× ×ª×™',
                    allowOutsideClick: false
                });
                return;
            }
            
            proceedToStep2();
        }
        
        function proceedToStep2() {
            // ×©××™×¨×ª ×”× ×ª×•× ×™×
            const employmentStatus = document.getElementById('employmentStatus').value;
            ClientProfile.updateProfile({
                employmentStatus
            });
            
            
            // ×”×—×–×¨×ª ×¨××ª ×¡×™×›×•×Ÿ (×× ×§×™×™××ª)
            const riskLevel = clientAnalysisData.profile.riskProfile || "";
            
            // ××¢×‘×¨ ×œ×©×œ×‘ ×”×‘×
            goToStep(2);
            
            return riskLevel;
        }
        
        // ×¤×•× ×§×¦×™×” ×œ× ×™×ª×•×— ××™×›×•×ª
        function analyzeQuality() {
            const container = document.getElementById('qualityAnalysis');
            
            // ×‘×“×™×§×” ×× ×™×© ×¨××ª ×¡×™×›×•×Ÿ
            if (!clientAnalysisData.profile.riskProfile || clientAnalysisData.profile.riskProfile === "") {
                container.innerHTML = `
                    <div class="analysis-card" style="text-align: center; padding: 40px; background: #fff8e1; border-right: 4px solid #ff9800;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ff9800; margin-bottom: 20px;"></i>
                        <h3 style="color: #e65100; margin-bottom: 15px;">×¨××ª ×¡×™×›×•×Ÿ × ×“×¨×©×ª</h3>
                        <p style="color: var(--text-light); margin: 20px 0;">
                            ×œ× × ×™×ª×Ÿ ×œ×”××©×™×š ×œ× ×™×ª×•×— ××™×›×•×ª ×œ×œ× ×‘×—×™×¨×ª ×¨××ª ×¡×™×›×•×Ÿ ××• ××™×œ×•×™ ×©××œ×•×Ÿ
                        </p>
                        <button class="btn btn-primary" onclick="goToStep(1)">
                            <i class="fas fa-arrow-right"></i>
                            ×—×–×•×¨ ×œ×©×œ×‘ 1
                        </button>
                    </div>
                `;
                return;
            }
            
            // ×©×™××•×© ×‘× ×ª×•× ×™× ×©×›×‘×¨ × ×˜×¢× ×• ×œ-clientAnalysisData
            const detailedData = clientAnalysisData.detailedData;
            
            // ×‘×“×™×§×” ×× ×™×© × ×ª×•× ×™×
            if (!detailedData || !detailedData.pirteiHeshbon) {
                container.innerHTML = `
                    <div class="analysis-card" style="text-align: center;">
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: var(--warning);"></i>
                        <h3>××™×Ÿ × ×ª×•× ×™× ×–××™× ×™×</h3>
                        <p style="color: var(--text-light); margin: 20px 0;">
                            × × ×œ×”×¢×œ×•×ª ×§×‘×¦×™ ××¡×œ×§×” ×‘×“×£ ×”×‘×™×ª ×ª×—×™×œ×”
                        </p>
                        <button class="btn btn-primary" onclick="window.location.href='index.html#fileUpload'">
                            <i class="fas fa-upload"></i>
                            ×¢×‘×•×¨ ×œ×”×¢×œ××ª ×§×‘×¦×™×
                        </button>
                    </div>
                `;
                return;
            }
            
            const pirteiHeshbon = detailedData.pirteiHeshbon;
            const clientRisk = clientAnalysisData.profile.riskProfile;
            
            if (pirteiHeshbon && pirteiHeshbon[0]) {
                if (pirteiHeshbon[0].mafyenMaslulim && pirteiHeshbon[0].mafyenMaslulim[0]) {
                }
            }
            
            // ×™×¦×™×¨×ª ×›×•×ª×¨×ª ×¢× ×›×¤×ª×•×¨×™ × ×™×ª×•×—
            let html = `
                <div class="analysis-card" style="background: linear-gradient(180deg, #62B1C8 0%, #2494B5 50%, #0183AA 100%); color: white; margin-bottom: 30px;">
                    <h3 style="color: white; margin-bottom: 20px;">
                        <i class="fas fa-chart-line"></i>
                        × ×™×ª×•×— ××™×›×•×ª ×ª×™×§
                    </h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="analysis-tab-btn active" onclick="switchAnalysisTab('risk')" id="riskAnalysisBtn">
                            <i class="fas fa-shield-alt"></i>
                            ×¨××ª ×¡×™×›×•×Ÿ
                        </button>
                        <button class="analysis-tab-btn" onclick="switchAnalysisTab('fees')" id="feesAnalysisBtn">
                            <i class="fas fa-money-bill-wave"></i>
                            ×“××™ × ×™×”×•×œ
                        </button>
                        <button class="analysis-tab-btn" onclick="switchAnalysisTab('returns')" id="returnsAnalysisBtn">
                            <i class="fas fa-chart-bar"></i>
                            ×ª×©×•××•×ª
                        </button>
                    </div>
                </div>
                
                <!-- ×›×œ ×”× ×™×ª×•×—×™× ×‘××§×‘×™×œ, ×¨×§ ××—×“ ××•×¦×’ ×‘×›×œ ×¤×¢× -->
                <div id="riskAnalysisContent" class="analysis-content-tab" style="display: block;"></div>
                <div id="feesAnalysisContent" class="analysis-content-tab" style="display: none;"></div>
                <div id="returnsAnalysisContent" class="analysis-content-tab" style="display: none;"></div>
            `;
            
            container.innerHTML = html;
            
            // ×”×¦×’ loading ×œ×›×œ ×”×˜××‘×™×
            document.getElementById('riskAnalysisContent').innerHTML = `
                <div class="analysis-card" style="text-align: center; padding: 60px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
                    <h3 style="color: var(--primary);">××—×©×‘ × ×™×ª×•×— ×¡×™×›×•×Ÿ...</h3>
                </div>
            `;
            document.getElementById('feesAnalysisContent').innerHTML = `
                <div class="analysis-card" style="text-align: center; padding: 60px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
                    <h3 style="color: var(--primary);">××—×©×‘ ×“××™ × ×™×”×•×œ...</h3>
                </div>
            `;
            document.getElementById('returnsAnalysisContent').innerHTML = `
                <div class="analysis-card" style="text-align: center; padding: 60px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
                    <h3 style="color: var(--primary);">××—×©×‘ ×ª×©×•××•×ª...</h3>
                </div>
            `;
            
            // ×”×¨×¥ ××ª ×›×œ 3 ×”× ×™×ª×•×—×™× ××™×“ (××¡×™× ×›×¨×•× ×™)
            Promise.all([
                showRiskAnalysis(),
                showFeesAnalysis(),
                showReturnsAnalysis()
            ]).then(() => {
                // ×’× ×œ×”×¨×™×¥ ××ª × ×™×ª×•×— ×”×¤×¢×¨×™× ××•×˜×•××˜×™×ª
                analyzeGaps();
            }).catch(error => {
                console.error('âŒ ×©×’×™××” ×‘×—×™×©×•×‘ ×”× ×™×ª×•×—×™×:', error);
            });
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×”×—×œ×¤×ª ×˜××‘×™× (×¨×§ ×”×—×œ×¤×ª ×ª×¦×•×’×”, ×œ×œ× ×—×™×©×•×‘×™×)
        function switchAnalysisTab(tabName) {
            // ×”×¡×ª×¨ ××ª ×›×œ ×”×˜××‘×™×
            document.querySelectorAll('.analysis-content-tab').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // ×”×¡×¨ active ××›×œ ×”×›×¤×ª×•×¨×™×
            document.querySelectorAll('.analysis-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ×”×¦×’ ××ª ×”×˜××‘ ×”××‘×•×§×©
            if (tabName === 'risk') {
                document.getElementById('riskAnalysisContent').style.display = 'block';
                document.getElementById('riskAnalysisBtn').classList.add('active');
            } else if (tabName === 'fees') {
                document.getElementById('feesAnalysisContent').style.display = 'block';
                document.getElementById('feesAnalysisBtn').classList.add('active');
            } else if (tabName === 'returns') {
                document.getElementById('returnsAnalysisContent').style.display = 'block';
                document.getElementById('returnsAnalysisBtn').classList.add('active');
            }
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª × ×™×ª×•×— ×¡×™×›×•×Ÿ
        async function showRiskAnalysis() {
            // ×‘×“×™×§×” ×× ×™×© ×¨××ª ×¡×™×›×•×Ÿ
            if (!clientAnalysisData.profile.riskProfile || clientAnalysisData.profile.riskProfile === "") {
                const analysisContainer = document.getElementById('riskAnalysisContent');
                if (analysisContainer) {
                    analysisContainer.innerHTML = `
                        <div class="analysis-card" style="text-align: center; padding: 40px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ff9800;"></i>
                            <h3 style="color: #e65100;">×¨××ª ×¡×™×›×•×Ÿ × ×“×¨×©×ª</h3>
                            <p>× × ×œ×—×–×•×¨ ×œ×©×œ×‘ 1 ×•×œ×‘×—×•×¨ ×¨××ª ×¡×™×›×•×Ÿ</p>
                        </div>
                    `;
                }
                return;
            }
            
            const analysisContainer = document.getElementById('riskAnalysisContent');
            if (!analysisContainer) return;
            
            const detailedData = clientAnalysisData.detailedData;
            const pirteiHeshbon = detailedData.pirteiHeshbon;
            const clientRisk = clientAnalysisData.profile.riskProfile;
            
            let html = `
                <div class="analysis-card" style="background: #f8f9fa; margin-bottom: 20px; padding: 20px;">
                    <h4 style="color: var(--primary); margin: 0 0 10px 0;">
                        <i class="fas fa-info-circle"></i>
                        ××™×“×¢
                    </h4>
                    <p style="color: var(--text); margin: 0;">
                        ×‘×“×™×§×ª ×”×ª×××ª ××¡×œ×•×œ×™ ×”×”×©×§×¢×” ×œ×¤×¨×•×¤×™×œ ×”×¡×™×›×•×Ÿ ×©×œ×š
                    </p>
                    ${clientRisk ? 
                        `<div style="margin-top: 15px; padding: 12px; background: white; border-radius: 8px; border-right: 4px solid var(--primary);">
                            <strong>×¨××ª ×”×¡×™×›×•×Ÿ ×©×œ×š:</strong> ${clientRisk}
                        </div>` : 
                        `<div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 8px; border-right: 4px solid #ffc107;">
                            âš ï¸ ×œ× ××•×œ× ×©××œ×•×Ÿ ×¡×™×›×•×Ÿ - ×œ× × ×™×ª×Ÿ ×œ×‘×“×•×§ ×”×ª×××”
                        </div>`
                    }
                </div>
                
                <div class="analysis-card" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); margin-bottom: 20px; padding: 20px; border-right: 4px solid #2196f3;">
                    <h4 style="color: #1976d2; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-chart-bar"></i>
                        <span>×©×™×˜×ª ×—×™×©×•×‘ ×¨××ª ×”×¡×™×›×•×Ÿ</span>
                    </h4>
                    <div style="background: white; padding: 15px; border-radius: 8px; line-height: 1.8;">
                        <p style="margin: 0 0 10px 0; color: var(--text-dark);">
                            <i class="fas fa-calculator" style="color: #2196f3; margin-left: 8px;"></i>
                            <strong>×¨××ª ×”×¡×™×›×•×Ÿ × ×§×‘×¢×ª ×‘×©×ª×™ ×©×™×˜×•×ª:</strong>
                        </p>
                        <ul style="margin: 10px 0 0 20px; padding-right: 20px; color: var(--text);">
                            <li style="margin-bottom: 8px;">
                                <strong>×©×™×˜×” ×¢×™×§×¨×™×ª:</strong> ×¡×™×›×•×Ÿ × ×§×‘×¢ ×‘×”×ª×× ×œ<strong>×¡×˜×™×™×ª ×”×ª×§×Ÿ</strong> (×ª× ×•×“×ª×™×•×ª) ×©×œ ×”×ª×©×•××•×ª ×‘×™×—×¡ ×œ×××•×¦×¢ ×”×¢× ×¤×™ ×©×œ ×”××•×¦×¨
                            </li>
                            <li>
                                <strong>×©×™×˜×” ××©× ×™×ª:</strong> ×‘××™×“×” ×•×œ× ×§×™×™× × ×ª×•×Ÿ ×¡×˜×˜×™×¡×˜×™, ×”×¡×™×›×•×Ÿ × ×§×‘×¢ ×‘×”×ª×× ×œ<strong>××“×™× ×™×•×ª ×”×”×©×§×¢×•×ª</strong> ×©×œ ×”××¡×œ×•×œ
                            </li>
                        </ul>
                    </div>
                </div>
            `;
            
            // ×¨×™×›×•×– × ×ª×•× ×™× ×œ×¤×™ ××•×¦×¨ + ××¡×œ×•×œ
            const productMaslulMap = {};
            
            // ×©×œ×‘ 1: ×¨×›×– ××ª ×›×œ ×”× ×ª×•× ×™× ×œ×¤×™ ××•×¦×¨ + ××¡×œ×•×œ
            pirteiHeshbon.forEach((heshbon) => {
                const maslulim = heshbon.mafyenMaslulim || [];
                const productName = heshbon.shemTochnit || heshbon.sugMutzar || '×œ× ×™×“×•×¢';
                
                // ×–×™×”×•×™ ×¡×•×’ ×”××•×¦×¨
                const mozarType = getMozarType(heshbon.sugMutzar);
                
                maslulim.forEach(maslul => {
                    const pathwayName = maslul.shemMaslulHashkaa || maslul.shemMaslul || '';
                    const pathwayAmount = parseFloat(maslul.schumTzvira || 0);
                    
                    if (pathwayAmount <= 0) return; // ×“×œ×’ ×¢×œ ××¡×œ×•×œ×™× ×œ×œ× ×›×¡×£
                    
                    // ×–×™×”×•×™ ×¡×•×’ ×”××¡×œ×•×œ
                    let maslulType = '×›×œ×œ×™'; // ×‘×¨×™×¨×ª ××—×“×œ
                    if (pathwayName && typeof getMaslulType === 'function') {
                        const detectedType = getMaslulType(pathwayName);
                        if (detectedType && detectedType !== '×œ× ×™×“×•×¢') {
                            maslulType = detectedType;
                        }
                    }
                    
                    // ×™×¦×™×¨×ª ××¤×ª×— ×™×™×—×•×“×™
                    const key = `${productName}__${maslulType}`;
                    
                    if (!productMaslulMap[key]) {
                        productMaslulMap[key] = {
                            productName: productName,
                            mozarType: mozarType, // ×¡×•×’ ×”××•×¦×¨ ×”×××•×¤×”
                            maslulType: maslulType,
                            totalAmount: 0,
                            examples: []
                        };
                    }
                    
                    productMaslulMap[key].totalAmount += pathwayAmount;
                    productMaslulMap[key].examples.push({
                        provider: heshbon.shemMaasik,
                        pathwayName: pathwayName,
                        amount: pathwayAmount
                    });
                });
            });
            
            // ×©×œ×‘ 2: ×—×™×©×•×‘ ×—×œ×•×§×” ×œ×¤×™ ×¨××ª ×¡×™×›×•×Ÿ
            const riskDistribution = {
                '×’×‘×•×”': 0,
                '×‘×™× ×•× ×™': 0,
                '× ××•×š': 0
            };
            
            Object.values(productMaslulMap).forEach((entry) => {
                // ×©×™××•×© ×‘×¤×•× ×§×¦×™×” ×”××ª×§×“××ª ×œ×—×™×©×•×‘ ×¡×™×›×•×Ÿ ×œ×¤×™ ×¡×˜×™×•×ª ×¡×˜×˜×™×¡×˜×™×•×ª
                // ××¢×‘×™×¨×™× ××ª ×¡×•×’ ×”××•×¦×¨ (mozarType) ×•×œ× ××ª ×©× ×”×ª×•×›× ×™×ª
                const mozarForCalc = entry.mozarType || entry.productName;
                const pathwayRisk = calculateRiskByStandardDeviation(mozarForCalc, entry.maslulType);
                
                if (pathwayRisk === '×’×‘×•×”' || pathwayRisk === '×‘×™× ×•× ×™' || pathwayRisk === '× ××•×š') {
                    riskDistribution[pathwayRisk] += entry.totalAmount;
                }
            });
            
            const totalAmount = riskDistribution['×’×‘×•×”'] + riskDistribution['×‘×™× ×•× ×™'] + riskDistribution['× ××•×š'];
            
            // ×™×¦×™×¨×ª ×›×¨×˜×™×¡×™×” ××¨×›×–×ª ×¢× ×’×¨×£ ×¢×•×’×”
            const riskChartId = 'riskDistributionChart_' + Date.now();
            
            html += `
                <div class="analysis-card risk-distribution-card" style="background: linear-gradient(180deg, #62B1C8 0%, #2494B5 50%, #0183AA 100%); color: white; margin-bottom: 30px; padding: 25px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);">
                    <h3 class="risk-card-title" style="color: white; margin: 0 0 20px 0; text-align: center; font-size: 1.6rem;">
                        <i class="fas fa-chart-pie"></i>
                        ×—×œ×•×§×ª ×”×ª×™×§ ×œ×¤×™ ×¨××•×ª ×¡×™×›×•×Ÿ
                    </h3>
                    
                    <div class="risk-card-grid" style="display: grid; grid-template-columns: 1fr auto; gap: 30px; align-items: center;">
                        <!-- Statistics Section -->
                        <div class="risk-stats-section" style="display: flex; flex-direction: column; gap: 15px;">
            `;
            
            // ×”×¦×’×ª ×›×œ ×¨××ª ×¡×™×›×•×Ÿ ×©×™×© ×‘×” ×›×¡×£
            const riskColors = {
                '×’×‘×•×”': '#dc3545',
                '×‘×™× ×•× ×™': '#ffc107',
                '× ××•×š': '#28a745'
            };
            
            Object.keys(riskDistribution).forEach(risk => {
                if (riskDistribution[risk] > 0) {
                    const percentage = ((riskDistribution[risk] / totalAmount) * 100).toFixed(1);
                    html += `
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 12px; backdrop-filter: blur(10px);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 20px; height: 20px; border-radius: 50%; background: ${riskColors[risk]}; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"></div>
                                    <span style="font-weight: 600; font-size: 1.1rem;">×¡×™×›×•×Ÿ ${risk}</span>
                                </div>
                                <span style="font-weight: bold; font-size: 1.3rem;">â‚ª${riskDistribution[risk].toLocaleString('he-IL', {maximumFractionDigits: 0})}</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: ${riskColors[risk]}; height: 100%; width: ${percentage}%; border-radius: 4px; transition: width 0.3s ease;"></div>
                            </div>
                            <div style="text-align: left; margin-top: 5px; font-size: 0.95rem; opacity: 0.9;">
                                ${percentage}% ××¡×š ×”×ª×™×§
                            </div>
                        </div>
                    `;
                }
            });
            
            html += `
                        </div>
                        
                        <!-- Chart Section -->
                        <div class="risk-chart-container" style="width: 250px; height: 250px; background: rgba(255,255,255,0.1); border-radius: 50%; padding: 20px; backdrop-filter: blur(10px); box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                            <canvas id="${riskChartId}" style="max-width: 100%; max-height: 100%;"></canvas>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                        <div style="font-size: 0.95rem; opacity: 0.9;">
                            <strong>×¡×š ×›×œ ×”×—×™×¡×›×•×Ÿ:</strong> â‚ª${totalAmount.toLocaleString('he-IL', {maximumFractionDigits: 0})}
                            <div class="small-text" style="font-size: 0.7rem; opacity: 0.9;">×œ× ×›×•×œ×œ ×§×¨× ×•×ª ×•×ª×™×§×•×ª</div>
                        </div>
                    </div>
                </div>
            `;
            
            // ×©××™×¨×ª ID ×©×œ ×”×’×¨×£ ×œ×™×¦×™×¨×” ×××•×—×¨ ×™×•×ª×¨
            setTimeout(() => {
                const ctx = document.getElementById(riskChartId);
                if (ctx) {
                    const chartData = [];
                    const chartLabels = [];
                    const chartColors = [];
                    
                    if (riskDistribution['×’×‘×•×”'] > 0) {
                        chartData.push(riskDistribution['×’×‘×•×”']);
                        chartLabels.push('×¡×™×›×•×Ÿ ×’×‘×•×”');
                        chartColors.push('#dc3545');
                    }
                    if (riskDistribution['×‘×™× ×•× ×™'] > 0) {
                        chartData.push(riskDistribution['×‘×™× ×•× ×™']);
                        chartLabels.push('×¡×™×›×•×Ÿ ×‘×™× ×•× ×™');
                        chartColors.push('#ffc107');
                    }
                    if (riskDistribution['× ××•×š'] > 0) {
                        chartData.push(riskDistribution['× ××•×š']);
                        chartLabels.push('×¡×™×›×•×Ÿ × ××•×š');
                        chartColors.push('#28a745');
                    }
                    
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: chartLabels,
                            datasets: [{
                                data: chartData,
                                backgroundColor: chartColors,
                                borderColor: 'white',
                                borderWidth: 3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return `â‚ª${value.toLocaleString('he-IL', {maximumFractionDigits: 0})} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }, 100);
            
            // ×©×œ×‘ 3: ×§×™×‘×•×¥ ×”××¡×œ×•×œ×™× ×œ×¤×™ ×¨××ª ×”×¡×™×›×•×Ÿ
            const entriesByRisk = {
                '× ××•×š': [],
                '×‘×™× ×•× ×™': [],
                '×’×‘×•×”': [],
                '×œ× ×™×“×•×¢': []
            };
            
            // ×—×™×©×•×‘ ×¨××ª ×”×¡×™×›×•×Ÿ ×œ×›×œ ××¡×œ×•×œ ×•×§×™×‘×•×¥
            Object.values(productMaslulMap).forEach((entry) => {
                const mozarForCalc = entry.mozarType || entry.productName;
                const pathwayRisk = calculateRiskByStandardDeviation(mozarForCalc, entry.maslulType);
                entry.pathwayRisk = pathwayRisk;
                entry.mozarForCalc = mozarForCalc;
                
                if (pathwayRisk === '×’×‘×•×”' || pathwayRisk === '×‘×™× ×•× ×™' || pathwayRisk === '× ××•×š') {
                    entriesByRisk[pathwayRisk].push(entry);
                } else {
                    entriesByRisk['×œ× ×™×“×•×¢'].push(entry);
                }
            });
            
            // ××™×•×Ÿ ×›×œ ×§×‘×•×¦×” ×œ×¤×™ ×¡×›×•× (×’×‘×•×” ×œ× ××•×š)
            Object.keys(entriesByRisk).forEach(risk => {
                entriesByRisk[risk].sort((a, b) => b.totalAmount - a.totalAmount);
            });
            
            // ×”×¦×’×ª ×”××¡×œ×•×œ×™× ×œ×¤×™ ×§×‘×•×¦×•×ª ×¡×™×›×•×Ÿ (×¡×“×¨: × ××•×š, ×‘×™× ×•× ×™, ×’×‘×•×”, ×œ× ×™×“×•×¢)
            const riskOrder = ['× ××•×š', '×‘×™× ×•× ×™', '×’×‘×•×”', '×œ× ×™×“×•×¢'];
            const riskTitles = {
                '× ××•×š': '××¡×œ×•×œ×™× ×‘×¡×™×›×•×Ÿ × ××•×š',
                '×‘×™× ×•× ×™': '××¡×œ×•×œ×™× ×‘×¡×™×›×•×Ÿ ×‘×™× ×•× ×™',
                '×’×‘×•×”': '××¡×œ×•×œ×™× ×‘×¡×™×›×•×Ÿ ×’×‘×•×”',
                '×œ× ×™×“×•×¢': '××¡×œ×•×œ×™× ×œ×œ× ×¡×™×•×•×’ ×¡×™×›×•×Ÿ'
            };
            
            riskOrder.forEach(riskLevel => {
                const entries = entriesByRisk[riskLevel];
                if (entries.length === 0) return;
                
                // ×›×•×ª×¨×ª ×§×‘×•×¦×”
                const riskColor = riskColors[riskLevel] || '#6c757d';
                const totalInGroup = entries.reduce((sum, entry) => sum + entry.totalAmount, 0);
                
                html += `
                    <div class="analysis-card" style="background: linear-gradient(135deg, ${riskColor}15 0%, ${riskColor}08 100%); border-right: 4px solid ${riskColor}; margin-bottom: 30px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                            <h3 style="color: ${riskColor}; margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px;">
                                <div style="width: 30px; height: 30px; border-radius: 50%; background: ${riskColor}; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas ${riskLevel === '×’×‘×•×”' ? 'fa-exclamation-triangle' : riskLevel === '×‘×™× ×•× ×™' ? 'fa-equals' : riskLevel === '× ××•×š' ? 'fa-check-circle' : 'fa-question-circle'}" style="color: white; font-size: 0.9rem;"></i>
                                </div>
                                ${riskTitles[riskLevel]}
                            </h3>
                            <div style="text-align: left;">
                                <div style="font-size: 1.3rem; font-weight: bold; color: ${riskColor};">
                                    â‚ª${totalInGroup.toLocaleString('he-IL', {maximumFractionDigits: 0})}
                                </div>
                                <div style="color: var(--text-light); font-size: 0.9rem;">
                                    ×¡×š ×”×›×œ ×‘×§×‘×•×¦×”
                                </div>
                            </div>
                        </div>
                `;
                
                // ×”×¦×’×ª ×›×œ ×”××¡×œ×•×œ×™× ×‘×§×‘×•×¦×”
                entries.forEach((entry) => {
                    const match = clientRisk ? checkRiskMatch(clientRisk, entry.pathwayRisk) : null;
                    
                    html += `
                        <div class="analysis-card" style="background: white; border-right: 3px solid ${match ? match.color : riskColor}; margin-bottom: 15px; padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; flex-wrap: wrap; gap: 15px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <h4 style="color: var(--primary); margin: 0 0 10px 0; font-size: 1.2rem;">
                                        <i class="fas fa-layer-group"></i>
                                        ${entry.productName}
                                    </h4>
                                    <div style="color: var(--text-light); font-size: 0.95rem;">
                                        <i class="fas fa-route"></i> ${entry.maslulType}
                                    </div>
                                </div>
                                <div style="text-align: left;">
                                    <div style="font-size: 1.4rem; font-weight: bold; color: var(--success);">
                                        â‚ª${entry.totalAmount.toLocaleString('he-IL', {maximumFractionDigits: 0})}
                                    </div>
                                    <div style="color: var(--text-light); font-size: 0.9rem;">
                                        ×¡×š ×”×›×œ
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                                    <small style="color: var(--text-light);">×¨××ª ×¡×™×›×•×Ÿ ××¡×œ×•×œ:</small><br>
                                    <span class="status-badge ${entry.pathwayRisk === '×’×‘×•×”' ? 'status-danger' : entry.pathwayRisk === '×‘×™× ×•× ×™' ? 'status-warning' : 'status-good'}">
                                        ${entry.pathwayRisk}
                                    </span>
                                </div>
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 6px;">
                                    <small style="color: var(--text-light);">×¨××ª ×¡×™×›×•×Ÿ ×œ×§×•×—:</small><br>
                                    <span class="status-badge ${clientRisk === '×’×‘×•×”' ? 'status-danger' : clientRisk === '×‘×™× ×•× ×™' ? 'status-warning' : clientRisk === '× ××•×š' ? 'status-good' : 'status-warning'}" style="${!clientRisk ? 'background: #fff3cd; color: #856404;' : ''}">
                                        ${clientRisk || '×œ× ×‘×•×¦×¢ ×©××œ×•×Ÿ ×¡×™×›×•×Ÿ'}
                                    </span>
                                </div>
                            </div>
                            
                            ${match ? 
                                `<div style="margin-top: 15px; padding: 10px; background: white; border-radius: 6px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas ${match.icon}" style="color: ${match.color}; font-size: 1.2rem;"></i>
                                        <span style="color: ${match.color}; font-weight: 500;">${match.message}</span>
                                    </div>
                                </div>` : 
                                `<div style="margin-top: 15px; padding: 15px; background: #fff8e1; border-radius: 8px; border-right: 4px solid #ff9800;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                        <i class="fas fa-exclamation-circle" style="color: #ff9800; font-size: 1.2rem;"></i>
                                        <span style="color: #e65100; font-weight: 600;">×œ× × ×™×ª×Ÿ ×œ×”×—×œ×™×˜ ×œ×œ× ××•×¤×™ ×¡×™×›×•×Ÿ</span>
                                    </div>
                                    <button class="btn btn-primary" onclick="goToStep(1); setTimeout(openRiskQuestModalAndReturn, 300);" style="width: 100%; justify-content: center;">
                                        <i class="fas fa-clipboard-list"></i>
                                        ××œ× ×©××œ×•×Ÿ ×¡×™×›×•×Ÿ
                                    </button>
                                </div>`
                            }
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            analysisContainer.innerHTML = html;
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª × ×™×ª×•×— ×“××™ × ×™×”×•×œ
        async function showFeesAnalysis() {
            // ×‘×“×™×§×” ×× ×™×© ×¨××ª ×¡×™×›×•×Ÿ
            if (!clientAnalysisData.profile.riskProfile || clientAnalysisData.profile.riskProfile === "") {
                const analysisContainer = document.getElementById('feesAnalysisContent');
                if (analysisContainer) {
                    analysisContainer.innerHTML = `
                        <div class="analysis-card" style="text-align: center; padding: 40px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ff9800;"></i>
                            <h3 style="color: #e65100;">×¨××ª ×¡×™×›×•×Ÿ × ×“×¨×©×ª</h3>
                            <p>× × ×œ×—×–×•×¨ ×œ×©×œ×‘ 1 ×•×œ×‘×—×•×¨ ×¨××ª ×¡×™×›×•×Ÿ</p>
                        </div>
                    `;
                }
                return;
            }
            
            const analysisContainer = document.getElementById('feesAnalysisContent');
            if (!analysisContainer) return;
            
            const detailedData = clientAnalysisData.detailedData;
            const pirteiHeshbon = detailedData.pirteiHeshbon;
            
            let html = `
                <div class="analysis-card" style="background: #f8f9fa; margin-bottom: 20px; padding: 20px;">
                    <h4 style="color: var(--primary); margin: 0 0 10px 0;">
                        <i class="fas fa-info-circle"></i>
                        ××™×“×¢
                    </h4>
                    <p style="color: var(--text); margin: 0;">
                        ×‘×“×™×§×” ×”×× ×“××™ ×”× ×™×”×•×œ ×©×œ×š × ××•×›×™×, ×‘×××•×¦×¢, ××• ×’×‘×•×”×™× ×‘×™×—×¡ ×œ×××•×¦×¢ ×”×©×•×§
                    </p>
                    <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 8px; border-right: 4px solid var(--primary);">
                        <strong>× ×•×¡×—×”:</strong> ×“××™ × ×™×”×•×œ ××©×•×§×œ×œ = (×“××™ × ×™×”×•×œ ××”×¤×§×“×” Ã· 10) + ×“××™ × ×™×”×•×œ ××¦×‘×™×¨×”
                    </div>
                </div>
            `;
            
            // ×¢×‘×•×¨ ×¢×œ ×›×œ ×—×©×‘×•×Ÿ ×•××¡×œ×•×œ×™×•
            for (let heshbonIndex = 0; heshbonIndex < pirteiHeshbon.length; heshbonIndex++) {
                let ifmifheshbonIndex=false;
                const heshbon = pirteiHeshbon[heshbonIndex];
                if (heshbon.mafyenMaslulim[0]){
                const kod =Number(heshbon.mafyenMaslulim[0].kodMaslolHashkaa.slice(19,23)).toString();
                const ifmifheshbon=datanetunimKlaliXM.filter(item=>item.mh===kod);
                if(ifmifheshbon.length!==0 ){
                    if(ifmifheshbon[0].ochlosiyayaad!=='×›×œ×œ ×”××•×›×œ×•×¡×™×”'){
                        ifmifheshbonIndex=true;
                    }
                }
                }
                const maslulim = heshbon.mafyenMaslulim || [];
                
                if (maslulim.length === 0) continue;
                
                html += `
                    <div class="analysis-card" style="border-right: 4px solid var(--primary); margin-bottom: 20px;">
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--primary); margin: 0 0 5px 0; font-size: clamp(1rem, 3vw, 1.2rem); word-wrap: break-word; overflow-wrap: break-word;">
                                <i class="fas fa-briefcase"></i>
                                ${heshbon.shemTochnit || '×—×©×‘×•×Ÿ #' + (heshbonIndex + 1)}
                            </h4>
                            <div style="color: var(--text-light); font-size: clamp(0.8rem, 2vw, 0.9rem); word-wrap: break-word;">
                                <i class="fas fa-building"></i> ${heshbon.shemMaasik || '×œ× ×¦×•×™×Ÿ'}
                            </div>
                        </div>
                `;
                
                for (let maslulIndex = 0; maslulIndex < maslulim.length; maslulIndex++) {
                    const maslul = maslulim[maslulIndex];
                    const pathwayName = maslul.shemMaslulHashkaa || maslul.shemMaslul || '××¡×œ×•×œ ' + (maslulIndex + 1);
                    const pathwayAmount = parseFloat(maslul.schumTzvira || 0);
                    
                    if (pathwayAmount <= 0) continue;
                    
                    // ×“××™ × ×™×”×•×œ ×©×œ ×”×œ×§×•×—
                    const feeFromDeposit = parseFloat(maslul.sheurDmeyNihulHafkadMivne || 0);
                    const feeFromBalance = parseFloat(maslul.sheurDmeyNihulHisachonMivne || 0);
                    const weightedFee = (feeFromDeposit / 10) + feeFromBalance;
                    
                    // ×–×™×”×•×™ ×¡×•×’ ×”××¡×œ×•×œ ×œ××¦×™××ª ×××•×¦×¢×™×
                    let maslulType = '×›×œ×œ×™';
                    if (pathwayName && typeof getMaslulType === 'function') {
                        const detectedType = getMaslulType(pathwayName);
                        
                        if (detectedType && detectedType !== '×œ× ×™×“×•×¢') {
                            maslulType = detectedType;
                        }
                    }
            switch(heshbon.sugMutzar) {
                case '4':
                case 4:
                    productName = '×§×¨× ×•×ª ×”×©×ª×œ××•×ª';  // ×¨×‘×™×!
                    break;
                case '3':
                case 3:
                    productName = '×ª×’××•×œ×™× ×•××™×©×™×ª ×œ×¤×™×¦×•×™×™×';
                    break;
                case '9':
                case 9:
                    productName = '×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×”';
                    break;
                case '10':
                case 10:
                    productName = '×—×¡×›×•×Ÿ ×œ×™×œ×“';
                    break;
                case '2':
                case 2:
                case '2_1':
                case '2_2':
                    productName = '×§×¨× ×•×ª ×—×“×©×•×ª';
                    avgDeposit = 1.6;
                    avgBalance = 0.16;
                    avgWeighted = 0.25;
                    break;
                case '1':
                case 1:
                productName = '×¤×•×œ×™×¡×ª ×‘×™×˜×•×— ×—×™×™× ××©×•×œ×‘ ×—×™×¡×›×•×Ÿ';
                break;
                case '5':
                case 5:
                    productName = '×¤×•×œ×™×¡×ª ×—×¡×›×•×Ÿ';
                    avgDeposit = 0;
                    avgBalance = 0.85;
                    avgWeighted = 0.85;
                    break;
            }       
                    // ××¦×™××ª ×“××™ × ×™×”×•×œ ×××•×¦×¢×™× - ×©×™××•×© ×‘×¤×•× ×§×¦×™×” ×”××•×ª×××ª ××™×©×™×ª
                    if(ifmifheshbonIndex===false){
                    const avgFeesResult = await indicationsforadvancedanalysis(productName, maslulType);
                    
                    // ×§×¨×™××” ×™×©×™×¨×” ××”××•×‘×™×™×§×˜ - ×¨×§ ×× ×™×© ×ª×•×¦××”
                    if(avgFeesResult && (parseFloat(avgFeesResult.dmeyNihulHafkad)!==0 || parseFloat(avgFeesResult.dmeyNihul)!==0)){
                        avgDeposit = parseFloat(avgFeesResult.dmeyNihulHafkad)
                        avgBalance = parseFloat(avgFeesResult.dmeyNihul)
                        avgWeighted = parseFloat(avgFeesResult.dmeyNihulMeshuklal)
                    } 
                    else{
                        avgDeposit = productName ==='×§×¨× ×•×ª ×—×“×©×•×ª' ? 0.16 : 0;
                        avgBalance = productName ==='×§×¨× ×•×ª ×—×“×©×•×ª' ? 1.6 : productName ==='×¤×•×œ×™×¡×ª ×—×¡×›×•×Ÿ' ? 0.85 : 0.7;
                        avgWeighted = productName ==='×§×¨× ×•×ª ×—×“×©×•×ª' ? 0.25 : productName ==='×¤×•×œ×™×¡×ª ×—×¡×›×•×Ÿ' ? 0.85 : 0.7;
                    }
                    }
                    else{
                        avgDeposit = '×§×•×¤×” ××¤×¢×œ×™×ª'
                        avgBalance = '×§×•×¤×” ××¤×¢×œ×™×ª'
                        avgWeighted = '×§×•×¤×” ××¤×¢×œ×™×ª'
                    }
                    // ×”×©×•×•××”
                    const comparison = compareFees(weightedFee,  avgWeighted);
                    

                    html += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-right: 4px solid ${comparison.color};">
                            <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                                <div style="flex: 1; min-width: 150px; max-width: 100%; word-wrap: break-word; overflow-wrap: break-word;">
                                    <div style="font-weight: bold; color: var(--text-dark); margin-bottom: 5px; word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;">
                                        ${pathwayName}
                                    </div>
                                    <div style="color: var(--text-light); font-size: 0.9rem;">
                                        <i class="fas fa-route"></i> ${maslulType}
                                    </div>
                                </div>
                                <div style="text-align: left; min-width: 100px;">
                                    <div style="font-weight: bold; color: var(--primary); font-size: 1.1rem; white-space: nowrap;">
                                        â‚ª${pathwayAmount.toLocaleString('he-IL', {maximumFractionDigits: 0})}
                                    </div>
                                    <div style="color: var(--text-light); font-size: 0.85rem;">
                                        ×¦×‘×™×¨×”
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 15px;">
                                <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e0e0e0;">
                                    <small style="color: var(--text-light); display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem;">××”×¤×§×“×”</small>
                                    <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px; flex-wrap: wrap; gap: 5px;">
                                        <strong style="color: var(--text-dark); font-size: clamp(1rem, 3vw, 1.3rem);">${feeFromDeposit.toFixed(2)}%</strong>
                                        <small style="color: var(--text-light); font-size: 0.75rem;">×©×œ×š</small>
                                    </div>
                                    <div style="padding-top: 5px; border-top: 1px dashed #e0e0e0;">
                                        <div style="display: flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; gap: 5px;">
                                            <strong style="color: var(--primary); font-size: clamp(0.9rem, 2.5vw, 1.1rem);">${avgDeposit==='×§×•×¤×” ××¤×¢×œ×™×ª' ? '×§×•×¤×” ××¤×¢×œ×™×ª' : avgDeposit.toFixed(2)}${avgDeposit==='×§×•×¤×” ××¤×¢×œ×™×ª' ? '' : '%'}</strong>
                                            <small style="color: var(--text-light); font-size: 0.75rem;">×××•×¦×¢</small>
                                        </div>
                                    </div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e0e0e0;">
                                    <small style="color: var(--text-light); display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem;">××¦×‘×™×¨×”</small>
                                    <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px; flex-wrap: wrap; gap: 5px;">
                                        <strong style="color: var(--text-dark); font-size: clamp(1rem, 3vw, 1.3rem);">${feeFromBalance.toFixed(2)}%</strong>
                                        <small style="color: var(--text-light); font-size: 0.75rem;">×©×œ×š</small>
                                    </div>
                                    <div style="padding-top: 5px; border-top: 1px dashed #e0e0e0;">
                                        <div style="display: flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; gap: 5px;">
                                            <strong style="color: var(--primary); font-size: clamp(0.9rem, 2.5vw, 1.1rem);">${avgBalance==='×§×•×¤×” ××¤×¢×œ×™×ª' ? '×§×•×¤×” ××¤×¢×œ×™×ª' : avgBalance.toFixed(2)}${avgBalance==='×§×•×¤×” ××¤×¢×œ×™×ª' ? '' : '%'}</strong>
                                            <small style="color: var(--text-light); font-size: 0.75rem;">×××•×¦×¢</small>
                                        </div>
                                    </div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 6px; border: 2px solid ${comparison.color};">
                                    <small style="color: var(--text-light); display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem;">××©×•×§×œ×œ</small>
                                    <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px; flex-wrap: wrap; gap: 5px;">
                                        <strong style="color: ${comparison.color}; font-size: clamp(1rem, 3vw, 1.3rem);">${weightedFee.toFixed(2)}%</strong>
                                        <small style="color: var(--text-light); font-size: 0.75rem;">×©×œ×š</small>
                                    </div>
                                    <div style="padding-top: 5px; border-top: 1px dashed #e0e0e0;">
                                        <div style="display: flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; gap: 5px;">
                                            <strong style="color: var(--primary); font-size: clamp(0.9rem, 2.5vw, 1.1rem);">${avgWeighted==='×§×•×¤×” ××¤×¢×œ×™×ª' ? '×§×•×¤×” ××¤×¢×œ×™×ª' : avgWeighted.toFixed(2)}${avgWeighted==='×§×•×¤×” ××¤×¢×œ×™×ª' ? '' : '%'}</strong>
                                            <small style="color: var(--text-light); font-size: 0.75rem;">×××•×¦×¢</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="padding: 10px; background: white; border-radius: 6px;">
                                <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                    <i class="fas ${comparison.icon}" style="color: ${comparison.color}; font-size: 1.2rem; flex-shrink: 0;"></i>
                                    <span style="color: ${comparison.color}; font-weight: 500; font-size: clamp(0.85rem, 2vw, 1rem); word-break: break-word;">${avgWeighted==='×§×•×¤×” ××¤×¢×œ×™×ª' ? '×§×•×¤×” ××¤×¢×œ×™×ª' : comparison.message}</span>
                                </div>
                                ${heshbon.mekademGilPrishaTzafuy ? `
                                    <div style="margin-top: 8px; padding: 8px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 6px; border-right: 3px solid #4caf50;">
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <i class="fas fa-shield-alt" style="color: #4caf50; font-size: 1rem;"></i>
                                            <span style="color: #2e7d32; font-weight: 600; font-size: clamp(0.8rem, 2vw, 0.9rem);">××§×“× ××•×‘×˜×—: ${heshbon.mekademGilPrishaTzafuy}%</span>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                html += `</div>`;
            }
            
            analysisContainer.innerHTML = html;
        }
        
        // ×¤×•× ×§×¦×™×” ×œ××¦×™××ª ×“××™ × ×™×”×•×œ ×××•×¦×¢×™×
        function getAverageFees(maslulType, sugMutzar) {
            
            // ×‘×¨×™×¨×•×ª ××—×“×œ
            let avgDeposit = 0;
            let avgBalance = 0.7;
            let avgWeighted = 0.7;
            
            // ××™×¤×•×™ sugMutzar ×œ×©× ×”××•×¦×¨ ×‘-dataIndicators
            let productName = '';
            switch(sugMutzar) {
                case '4':
                case 4:
                    productName = '×§×¨× ×•×ª ×”×©×ª×œ××•×ª';  // ×¨×‘×™×!
                    break;
                case '3':
                case 3:
                    productName = '×ª×’××•×œ×™× ×•××™×©×™×ª ×œ×¤×™×¦×•×™×™×';
                    break;
                case '9':
                case 9:
                    productName = '×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×”';
                    break;
                case '10':
                case 10:
                    productName = '×—×¡×›×•×Ÿ ×œ×™×œ×“';
                    break;
                case '2':
                case 2:
                case '2_1':
                case '2_2':
                    productName = '×§×¨× ×•×ª ×—×“×©×•×ª';
                    avgDeposit = 1.6;
                    avgBalance = 0.16;
                    avgWeighted = 0.25;
                    break;
                case '1':
                case 1:
                    productName = '×¤×•×œ×™×¡×ª ×‘×™×˜×•×— ×—×™×™× ××©×•×œ×‘ ×—×™×¡×›×•×Ÿ';
                case '5':
                case 5:
                    productName = '×¤×•×œ×™×¡×ª ×—×¡×›×•×Ÿ';
                    avgDeposit = 0;
                    avgBalance = 0.85;
                    avgWeighted = 0.85;
                    break;
            }
            
            // ×—×™×¤×•×© ×‘-dataIndicators - ×¨×§ ×× ×–×” ×œ× ×§×¨×Ÿ ×¤× ×¡×™×” ××• ×¤×•×œ×™×¡×” (×›×™ ×œ×”×Ÿ ×™×© ×‘×¨×™×¨×•×ª ××—×“×œ ×§×‘×•×¢×•×ª)
            const isPensionFund = sugMutzar === '2' || sugMutzar === 2 || 
                                  sugMutzar === '2_1' || sugMutzar === '2_2';
            const isPolisa = sugMutzar === '1' || sugMutzar === 1 || 
                            sugMutzar === '3' || sugMutzar === '3';
            
            if (!isPensionFund && !isPolisa && typeof dataIndicators !== 'undefined' && Array.isArray(dataIndicators)) {
                // ×¡×™× ×•×Ÿ ×œ×¤×™ ×’× ××•×¦×¨ ×•×’× ××¡×œ×•×œ
                const indicator = dataIndicators.find(item => 
                    item.mozar && productName && item.mozar === productName &&
                    item.maslul && maslulType && 
                    item.maslul.toLowerCase() === maslulType.toLowerCase()
                );
                
                if (indicator) {
                    if (indicator.dmeyNihul) avgBalance = parseFloat(indicator.dmeyNihul);
                    if (indicator.dmeyNihulHafkad) avgDeposit = parseFloat(indicator.dmeyNihulHafkad);
                    if (indicator.dmeyNihulMeshuklal && parseFloat(indicator.dmeyNihulMeshuklal) > 0) {
                        avgWeighted = parseFloat(indicator.dmeyNihulMeshuklal);
                    } else {
                        // ×× ××©×•×§×œ×œ = 0, ×—×©×‘ ××—×“×©
                        avgWeighted = (avgDeposit / 10) + avgBalance;
                    }
                }
            }
            
            return {
                deposit: avgDeposit,
                balance: avgBalance,
                weighted: avgWeighted
            };
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×”×©×•×•××ª ×“××™ × ×™×”×•×œ
        function compareFees(clientFee, avgFee) {
            const diff = clientFee - avgFee;
            const diffPercent = avgFee > 0 ? (diff / avgFee) * 100 : 0;
            
            let color, icon, message;
            
            if (diffPercent <= -10) {
                // × ××•×š ××©××¢×•×ª×™×ª ××”×××•×¦×¢ - ××¦×•×™×Ÿ!
                color = '#28a745';
                icon = 'fa-check-circle';
                message = `××¦×•×™×Ÿ! ×“××™ ×”× ×™×”×•×œ × ××•×›×™× ×‘-${Math.abs(diffPercent).toFixed(0)}% ××”×××•×¦×¢`;
            } else if (diffPercent < 5) {
                // ×‘×××•×¦×¢ ××• ××¢×˜ ××ª×—×ª
                color = '#28a745';
                icon = 'fa-check';
                message = '×“××™ × ×™×”×•×œ ×¡×‘×™×¨×™× - ×§×¨×•×‘ ×œ×××•×¦×¢ ×”×©×•×§';
            } else if (diffPercent < 15) {
                // ××¢×˜ ××¢×œ ×”×××•×¦×¢
                color = '#ffc107';
                icon = 'fa-exclamation-circle';
                message = `×“××™ × ×™×”×•×œ ××¢×˜ ×’×‘×•×”×™× (${diffPercent.toFixed(0)}% ××¢×œ ×”×××•×¦×¢)`;
            } else {
                // ×’×‘×•×” ××©××¢×•×ª×™×ª
                color = '#dc3545';
                icon = 'fa-exclamation-triangle';
                message = `×“××™ × ×™×”×•×œ ×’×‘×•×”×™×! ${diffPercent.toFixed(0)}% ××¢×œ ×”×××•×¦×¢ - ××•××œ×¥ ×œ×‘×“×•×§ ××¤×©×¨×•×™×•×ª`;
            }
            
            return { color, icon, message, diff, diffPercent };
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª × ×™×ª×•×— ×ª×©×•××•×ª
        async function showReturnsAnalysis() {
            // ×‘×“×™×§×” ×× ×™×© ×¨××ª ×¡×™×›×•×Ÿ
            if (!clientAnalysisData.profile.riskProfile || clientAnalysisData.profile.riskProfile === "") {
                const analysisContainer = document.getElementById('returnsAnalysisContent');
                if (analysisContainer) {
                    analysisContainer.innerHTML = `
                        <div class="analysis-card" style="text-align: center; padding: 40px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ff9800;"></i>
                            <h3 style="color: #e65100;">×¨××ª ×¡×™×›×•×Ÿ × ×“×¨×©×ª</h3>
                            <p>× × ×œ×—×–×•×¨ ×œ×©×œ×‘ 1 ×•×œ×‘×—×•×¨ ×¨××ª ×¡×™×›×•×Ÿ</p>
                        </div>
                    `;
                }
                return;
            }
            
            const analysisContainer = document.getElementById('returnsAnalysisContent');
            if (!analysisContainer) return;
            
            const detailedData = clientAnalysisData.detailedData;
            const pirteiHeshbon = detailedData.pirteiHeshbon;
            
            let html = `
                <div class="analysis-card" style="background: #f8f9fa; margin-bottom: 20px; padding: 20px;">
                    <h4 style="color: var(--primary); margin: 0 0 10px 0;">
                        <i class="fas fa-info-circle"></i>
                        ××™×“×¢
                    </h4>
                    <p style="color: var(--text); margin: 0;">
                        ×‘×“×™×§×” ×©×œ ×”×ª×©×•××•×ª ×©×œ×š ×‘×™×—×¡ ×œ×ª×©×•××•×ª ××¡×œ×•×œ×™× ××§×‘×™×œ×™× ×‘×ª×§×•×¤×•×ª ×©×•× ×•×ª
                    </p>
                    <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 8px; border-right: 4px solid var(--primary);">
                        <strong>×ª×§×•×¤×•×ª ×”×©×•×•××”:</strong> ××ª×—×™×œ×ª ×©× ×”, ×©× ×”, 3 ×©× ×™×, 5 ×©× ×™×
                    </div>
                </div>
            `;
            
            // ×§×™×‘×•×¥ ×ª×›× ×™×•×ª ×•××¡×œ×•×œ×™×
            const tochnitMap = {};
            
            // ×©×œ×‘ 1: ×§×™×‘×•×¥ ×œ×¤×™ ×ª×›× ×™×ª ×•××¡×œ×•×œ
            for (let heshbonIndex = 0; heshbonIndex < pirteiHeshbon.length; heshbonIndex++) {
                const heshbon = pirteiHeshbon[heshbonIndex];
                const maslulim = heshbon.mafyenMaslulim || [];
                
                if (maslulim.length === 0) continue;
                
                const tochnitKey = heshbon.shemTochnit || `×—×©×‘×•×Ÿ_${heshbonIndex}`;
                const isPensionFund = heshbon.sugMutzar === '2' || heshbon.sugMutzar === 2 || 
                                     heshbon.sugMutzar === '2_1' || heshbon.sugMutzar === '2_2';
                
                if (!tochnitMap[tochnitKey]) {
                    tochnitMap[tochnitKey] = {
                        shemTochnit: heshbon.shemTochnit,
                        shemMaasik: heshbon.shemMaasik,
                        sugMutzar: heshbon.sugMutzar,
                        isPension: isPensionFund,
                        maslulim: {}
                    };
                }
                
                for (let maslulIndex = 0; maslulIndex < maslulim.length; maslulIndex++) {
                    const maslul = maslulim[maslulIndex];
                    const pathwayAmount = parseFloat(maslul.schumTzvira || 0);
                    
                    if (pathwayAmount <= 0) continue;
                    
                    const kodMaslul = Number(maslul.kodMaslolHashkaa.slice(23,30)).toString();
                    
                    if (isPensionFund) {
                        // ×§×¨× ×•×ª ×¤× ×¡×™×” - ××™×—×•×“ ×œ×¤×™ ×§×•×“ ××¡×œ×•×œ ×ª×—×ª ××•×ª×” ×ª×›× ×™×ª
                        if (!tochnitMap[tochnitKey].maslulim[kodMaslul]) {
                            tochnitMap[tochnitKey].maslulim[kodMaslul] = {
                                kodMaslul: kodMaslul,
                                pathwayName: maslul.shemMaslulHashkaa || maslul.shemMaslul,
                                totalAmount: 0
                            };
                        }
                        tochnitMap[tochnitKey].maslulim[kodMaslul].totalAmount += pathwayAmount;
                    } else {
                        // ××•×¦×¨×™× ××—×¨×™× - ×›×œ ××¡×œ×•×œ ×‘× ×¤×¨×“
                        const uniqueKey = `${kodMaslul}_${maslulIndex}`;
                        tochnitMap[tochnitKey].maslulim[uniqueKey] = {
                            kodMaslul: kodMaslul,
                            pathwayName: maslul.shemMaslulHashkaa || maslul.shemMaslul,
                            totalAmount: pathwayAmount
                        };
                    }
                }
            }
            
            // ×©×œ×‘ 2: ×”×¦×’×ª ×”×ª×›× ×™×•×ª ×•×”××¡×œ×•×œ×™×
            for (const [tochnitKey, tochnitData] of Object.entries(tochnitMap)) {
                html += `
                    <div class="analysis-card" style="border-right: 4px solid var(--primary); margin-bottom: 20px;">
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--primary); margin: 0 0 5px 0; font-size: clamp(1rem, 3vw, 1.2rem); word-wrap: break-word; overflow-wrap: break-word;">
                                <i class="fas fa-briefcase"></i>
                                ${tochnitData.shemTochnit || '×ª×›× ×™×ª'}
                            </h4>
                            <div style="color: var(--text-light); font-size: clamp(0.8rem, 2vw, 0.9rem); word-wrap: break-word;">
                                <i class="fas fa-building"></i> ${tochnitData.shemMaasik || '×œ× ×¦×•×™×Ÿ'}
                            </div>
                        </div>
                `;
                
                // ×”×¦×’×ª ×›×œ ×”××¡×œ×•×œ×™× ×ª×—×ª ×”×ª×›× ×™×ª
                for (const [maslulKey, maslulData] of Object.entries(tochnitData.maslulim)) {
                    const kodMaslul = maslulData.kodMaslul;
                    const pathwayName = maslulData.pathwayName;
                    const pathwayAmount = maslulData.totalAmount;
                    
                    // ×–×™×”×•×™ ×¡×•×’ ×”××¡×œ×•×œ
                    const maslulType = getMaslulType(pathwayName);
                    
                    // ×–×™×”×•×™ ×©× ×”××•×¦×¨
                    let productName = '';
                    
                    switch(tochnitData.sugMutzar) {
                        case '4':
                        case 4:
                            productName = '×§×¨× ×•×ª ×”×©×ª×œ××•×ª';
                            break;
                        case '3':
                        case 3:
                            productName = '×ª×’××•×œ×™× ×•××™×©×™×ª ×œ×¤×™×¦×•×™×™×';
                            break;
                        case '9':
                        case 9:
                            productName = '×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×”';
                            break;
                        case '10':
                        case 10:
                            productName = '×—×¡×›×•×Ÿ ×œ×™×œ×“';
                            break;
                        case '2':
                        case 2:
                        case '2_1':
                        case '2_2':
                            productName = '×§×¨× ×•×ª ×—×“×©×•×ª';
                            break;
                        case '1':
                        case 1:
                            productName = '×¤×•×œ×™×¡×ª ×‘×™×˜×•×— ×—×™×™× ××©×•×œ×‘ ×—×™×¡×›×•×Ÿ';
                            break;
                        case '5':
                        case 5:
                            productName = '×¤×•×œ×™×¡×ª ×—×¡×›×•×Ÿ';
                            break;
                    }

                    let getMaslul=null;
                    getMaslul=datanetunimKlaliXM.filter(item=>item.mh===kodMaslul.toString());
                    if(getMaslul.length===0){
                        getMaslul=datanetunimKlaliXP.filter(item=>item.mh===kodMaslul.toString());
                    }
                    if(getMaslul.length===0){
                        getMaslul=datanetunimKlaliXB.filter(item=>item.mh===kodMaslul.toString());
                    }
                    
                    
                     // ×—×™×¤×•×© ×”×ª×©×•××•×ª ×©×œ ×”××¡×œ×•×œ ×‘× ×ª×•× ×™× ×”×’×œ×•×‘×œ×™×™×
                    let clientReturnYTD = 0, clientReturn = 0, clientReturn3Y = 0, clientReturn5Y = 0;
                    clientReturnYTD=parseFloat(getMaslul[0].tesuaMitchilatshana);
                    clientReturn=parseFloat(getMaslul[0].tesuam);
                    clientReturn3Y=parseFloat(getMaslul[0].tesuam36);
                    clientReturn5Y=parseFloat(getMaslul[0].tesuam60);
                    
                    
                    // ××¦×™××ª ×ª×©×•××•×ª ×××•×¦×¢×•×ª - ×©×™××•×© ×‘×¤×•× ×§×¦×™×” ×”××•×ª×××ª ××™×©×™×ª
                    
                    const avgReturnsResult = await indicationsforadvancedanalysis(productName, maslulType);
                    
                    // ×ª×©×•××•×ª ×××•×¦×¢×•×ª
                    let avgYTD = 0, avgYear = 0, avg3Years = 0, avg5Years = 0;
                    
                    if (avgReturnsResult) {
                        avgYTD = parseFloat(avgReturnsResult.tesuaMitchilatshana || 0);
                        avgYear = parseFloat(avgReturnsResult.tesuam || 0);
                        avg3Years = parseFloat(avgReturnsResult.tesuam36 || 0);
                        avg5Years = parseFloat(avgReturnsResult.tesuam60 || 0);
                    }
                    
                    // ×”×©×•×•××•×ª ×œ×›×œ ×ª×§×•×¤×”
                    const comparisonYTD = compareReturns(clientReturnYTD, avgYTD);
                    const comparisonYear = compareReturns(clientReturn, avgYear);
                    const comparison3Y = compareReturns(clientReturn3Y, avg3Years);
                    const comparison5Y = compareReturns(clientReturn5Y, avg5Years);
                    
                    // ×¦×‘×¢ ×›×œ×œ×™ ×œ×¤×™ ×ª×©×•××” ×©× ×ª×™×ª
                    const overallColor = comparisonYear.color;
                    
                    // ×§×‘×œ×ª 3 ×”××¡×œ×•×œ×™× ×”××•×‘×™×œ×™×
                    let top3TableHtml = '';
                    if (typeof getTop3TracksByYield === 'function') {
                        const clientTrackNameForSearch = getMaslul && getMaslul[0] && getMaslul[0].shemkupa ? getMaslul[0].shemkupa : pathwayName;
                        
                        // ×‘×“×™×§×” ×× ×–×” ×ª×’××•×œ×™× ×•×œ×¤×™×¦×•×™×™× ×¢× ××•×›×œ×•×¡×™×™×ª ×™×¢×“ ×œ× ×›×œ×œ ×”××•×›×œ×•×¡×™×”
                        const isTagmulimNonKlali = productName === '×ª×’××•×œ×™× ×•××™×©×™×ª ×œ×¤×™×¦×•×™×™×' && 
                                                    getMaslul && getMaslul[0] && 
                                                    getMaslul[0].ochlosiyayaad && 
                                                    getMaslul[0].ochlosiyayaad !== '×›×œ×œ ×”××•×›×œ×•×¡×™×”';
                        
                        // ×× ×–×” ×”××§×¨×” ×”××™×•×—×“ - × ×©×•×•×” ×œ××¡×œ×•×œ 50-60
                        const maslulTypeForComparison = isTagmulimNonKlali ? '50-60' : maslulType;
                        
                        const top3Data = await getTop3TracksByYield(productName, maslulTypeForComparison, isTagmulimNonKlali ? null : clientTrackNameForSearch);
                        
                        if (top3Data && top3Data.top3 && top3Data.top3.length > 0) {
                            top3TableHtml = `
                                <div style="margin-top: 15px; background: white; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0;">
                                    <div style="font-weight: bold; color: var(--text-dark); margin-bottom: 10px; font-size: clamp(0.75rem, 2vw, 0.9rem);">
                                        <i class="fas fa-trophy" style="color: #ffc107; margin-left: 6px; font-size: 0.9em;"></i>
                                        3 ×”××¡×œ×•×œ×™× ×”××•×‘×™×œ×™× ×œ×¤×™ ×ª×©×•××” ×œ-12 ×—×•×“×©×™×
                                        ${isTagmulimNonKlali ? '<span style="font-size: 0.75em; color: var(--text-light); font-weight: normal; margin-right: 6px;">(××¡×œ×•×œ 50-60)</span>' : ''}
                                    </div>
                                    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                                        <table class="top3-tracks-table" style="width: 100%; min-width: 280px; border-collapse: collapse;">
                                            <thead>
                                                <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                                                    <th style="padding: clamp(6px, 1.5vw, 10px); text-align: center; font-weight: 600; color: var(--text-dark); min-width: 55px; white-space: nowrap; font-size: clamp(0.7rem, 1.8vw, 0.85rem);">××™×§×•×</th>
                                                    <th style="padding: clamp(6px, 1.5vw, 10px); text-align: right; font-weight: 600; color: var(--text-dark); min-width: 140px; font-size: clamp(0.7rem, 1.8vw, 0.85rem);">×©× ×”××¡×œ×•×œ</th>
                                                    <th style="padding: clamp(6px, 1.5vw, 10px); text-align: right; font-weight: 600; color: var(--text-dark); min-width: 110px; white-space: nowrap; font-size: clamp(0.7rem, 1.8vw, 0.85rem);">×ª×©×•××” (12 ×—×•×“×©×™×)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                            `;
                            
                            // ×”×•×¡×¤×ª 3 ×”×¨××©×•× ×™× (××‘×œ ×œ× ××ª ×”××¡×œ×•×œ ×©×œ ×”×œ×§×•×— ×× ×–×” ×”××§×¨×” ×”××™×•×—×“)
                            top3Data.top3.forEach(track => {
                                // ×× ×–×” ×”××§×¨×” ×”××™×•×—×“ - ×œ× × ×¦×™×’ ××ª ×”××¡×œ×•×œ ×©×œ ×”×œ×§×•×—
                                if (isTagmulimNonKlali && track.isClientTrack) {
                                    return; // ×“×™×œ×•×’ ×¢×œ ×”××¡×œ×•×œ ×©×œ ×”×œ×§×•×—
                                }
                                
                                const isClient = track.isClientTrack;
                                const rowStyle = isClient ? 'background: #e8f5e9; font-weight: bold; border-right: 3px solid #4caf50;' : '';
                                const medal = track.position === 1 ? 'ğŸ¥‡' : track.position === 2 ? 'ğŸ¥ˆ' : 'ğŸ¥‰';
                                top3TableHtml += `
                                    <tr style="${rowStyle}">
                                        <td style="padding: clamp(6px, 1.5vw, 10px); text-align: center; color: ${isClient ? '#4caf50' : 'var(--text-dark)'}; white-space: nowrap; font-size: clamp(0.7rem, 1.8vw, 0.85rem);">
                                            ${medal} ${track.position}
                                        </td>
                                        <td style="padding: clamp(6px, 1.5vw, 10px); text-align: right; color: ${isClient ? '#2e7d32' : 'var(--text-dark)'}; word-wrap: break-word; overflow-wrap: break-word; font-size: clamp(0.7rem, 1.8vw, 0.85rem);">
                                            ${track.name} ${isClient ? '<span style="color: #4caf50; margin-right: 4px; white-space: nowrap; font-size: 0.85em;">(×”××¡×œ×•×œ ×©×œ×š)</span>' : ''}
                                        </td>
                                        <td style="padding: clamp(6px, 1.5vw, 10px); text-align: right; color: ${isClient ? '#2e7d32' : 'var(--text-dark)'}; font-weight: ${isClient ? 'bold' : 'normal'}; white-space: nowrap; font-size: clamp(0.7rem, 1.8vw, 0.85rem);">
                                            ${track.yield.toFixed(2)}%
                                        </td>
                                    </tr>
                                `;
                            });
                            
                            // ×× ×”××¡×œ×•×œ ×©×œ ×”×œ×§×•×— ×œ× ×‘-3 ×”×¨××©×•× ×™×, × ×•×¡×™×£ ××•×ª×• ×‘×©×•×¨×” × ×•×¡×¤×ª (×¨×§ ×× ×–×” ×œ× ×”××§×¨×” ×”××™×•×—×“)
                            if (!isTagmulimNonKlali && top3Data.clientTrack && !top3Data.clientTrack.isInTop3) {
                                top3TableHtml += `
                                    <tr style="background: #fff3cd; border-top: 2px dashed #ffc107; border-right: 3px solid #ffc107;">
                                        <td style="padding: clamp(6px, 1.5vw, 10px); text-align: center; color: #856404; font-weight: bold; white-space: nowrap; font-size: clamp(0.7rem, 1.8vw, 0.85rem);">
                                            ${top3Data.clientPosition}
                                        </td>
                                        <td style="padding: clamp(6px, 1.5vw, 10px); text-align: right; color: #856404; font-weight: bold; word-wrap: break-word; overflow-wrap: break-word; font-size: clamp(0.7rem, 1.8vw, 0.85rem);">
                                            ${top3Data.clientTrack.name} <span style="color: #ff9800; margin-right: 4px; white-space: nowrap; font-size: 0.85em;">(×”××¡×œ×•×œ ×©×œ×š)</span>
                                        </td>
                                        <td style="padding: clamp(6px, 1.5vw, 10px); text-align: right; color: #856404; font-weight: bold; white-space: nowrap; font-size: clamp(0.7rem, 1.8vw, 0.85rem);">
                                            ${top3Data.clientTrack.yield.toFixed(2)}%
                                        </td>
                                    </tr>
                                `;
                            }
                            
                            top3TableHtml += `
                                        </tbody>
                                    </table>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    html += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-right: 4px solid ${overallColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                                <div style="flex: 1; min-width: 150px; max-width: 100%; word-wrap: break-word; overflow-wrap: break-word;">
                                    <div style="font-weight: bold; color: var(--text-dark); margin-bottom: 5px; word-wrap: break-word; overflow-wrap: break-word; hyphens: auto;">
                                        ${pathwayName}
                                    </div>
                                    <div style="color: var(--text-light); font-size: 0.9rem;">
                                        <i class="fas fa-route"></i> ${maslulType}
                                    </div>
                                </div>
                                <div style="text-align: left; min-width: 100px;">
                                    <div style="font-weight: bold; color: var(--primary); font-size: 1.1rem; white-space: nowrap;">
                                        â‚ª${pathwayAmount.toLocaleString('he-IL', {maximumFractionDigits: 0})}
                                    </div>
                                    <div style="color: var(--text-light); font-size: 0.85rem;">
                                        ×¦×‘×™×¨×”
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ×ª×©×•××” × ×•×›×—×™×ª ×©×œ ×”×œ×§×•×— -->
                            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center; border: 2px solid ${overallColor};">
                                <small style="color: var(--text-light); display: block; margin-bottom: 5px; font-weight: 600;">×”×ª×©×•××” ×©×œ×š (×©× ×”)</small>
                                <div style="font-size: clamp(1.5rem, 4vw, 2rem); font-weight: bold; color: ${overallColor};">
                                    ${clientReturn && clientReturn !== 0 ? clientReturn.toFixed(2) + '%' : 'N/A'}
                                </div>
                            </div>
                            
                            <!-- ×”×©×•×•××ª ×ª×§×•×¤×•×ª -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 15px;">
                                <div style="background: white; padding: 12px; border-radius: 6px; border: 2px solid ${comparisonYTD.color};">
                                    <small style="color: var(--text-light); display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem;">××ª×—×™×œ×ª ×©× ×”</small>
                                    <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px; flex-wrap: wrap; gap: 5px;">
                                        <strong style="color: ${comparisonYTD.color}; font-size: clamp(1rem, 3vw, 1.3rem);">
                                            ${clientReturnYTD && clientReturnYTD !== 0 ? clientReturnYTD.toFixed(2) + '%' : '-'}
                                        </strong>
                                        <small style="color: var(--text-light); font-size: 0.75rem;">×©×œ×š</small>
                                    </div>
                                    <div style="padding-top: 5px; border-top: 1px dashed #e0e0e0; margin-bottom: 8px;">
                                        <div style="display: flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; gap: 5px;">
                                            <strong style="color: var(--primary); font-size: clamp(0.9rem, 2.5vw, 1.1rem);">
                                                ${avgYTD && avgYTD !== 0 ? avgYTD.toFixed(2) + '%' : '-'}
                                            </strong>
                                            <small style="color: var(--text-light); font-size: 0.75rem;">×××•×¦×¢</small>
                                        </div>
                                    </div>
                                    <div style="padding: 6px 8px; background: ${comparisonYTD.color}15; border-radius: 4px; border-right: 3px solid ${comparisonYTD.color};">
                                        <small style="color: ${comparisonYTD.color}; font-weight: 600; font-size: 0.75rem; display: block; line-height: 1.3;">
                                            ${comparisonYTD.shortMessage || comparisonYTD.message}
                                        </small>
                                    </div>
                                </div>
                                
                                <div style="background: white; padding: 12px; border-radius: 6px; border: 2px solid ${comparisonYear.color};">
                                    <small style="color: var(--text-light); display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem;">×©× ×”</small>
                                    <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px; flex-wrap: wrap; gap: 5px;">
                                        <strong style="color: ${comparisonYear.color}; font-size: clamp(1rem, 3vw, 1.3rem);">
                                            ${clientReturn && clientReturn !== 0 ? clientReturn.toFixed(2) + '%' : '-'}
                                        </strong>
                                        <small style="color: var(--text-light); font-size: 0.75rem;">×©×œ×š</small>
                                    </div>
                                    <div style="padding-top: 5px; border-top: 1px dashed #e0e0e0; margin-bottom: 8px;">
                                        <div style="display: flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; gap: 5px;">
                                            <strong style="color: var(--primary); font-size: clamp(0.9rem, 2.5vw, 1.1rem);">
                                                ${avgYear && avgYear !== 0 ? avgYear.toFixed(2) + '%' : '-'}
                                            </strong>
                                            <small style="color: var(--text-light); font-size: 0.75rem;">×××•×¦×¢</small>
                                        </div>
                                    </div>
                                    <div style="padding: 6px 8px; background: ${comparisonYear.color}15; border-radius: 4px; border-right: 3px solid ${comparisonYear.color};">
                                        <small style="color: ${comparisonYear.color}; font-weight: 600; font-size: 0.75rem; display: block; line-height: 1.3;">
                                            ${comparisonYear.shortMessage || comparisonYear.message}
                                        </small>
                                    </div>
                                </div>
                                
                                <div style="background: white; padding: 12px; border-radius: 6px; border: 2px solid ${comparison3Y.color};">
                                    <small style="color: var(--text-light); display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem;">3 ×©× ×™×</small>
                                    <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px; flex-wrap: wrap; gap: 5px;">
                                        <strong style="color: ${comparison3Y.color}; font-size: clamp(1rem, 3vw, 1.3rem);">
                                            ${clientReturn3Y && clientReturn3Y !== 0 ? clientReturn3Y.toFixed(2) + '%' : '-'}
                                        </strong>
                                        <small style="color: var(--text-light); font-size: 0.75rem;">×©×œ×š</small>
                                    </div>
                                    <div style="padding-top: 5px; border-top: 1px dashed #e0e0e0; margin-bottom: 8px;">
                                        <div style="display: flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; gap: 5px;">
                                            <strong style="color: var(--primary); font-size: clamp(0.9rem, 2.5vw, 1.1rem);">
                                                ${avg3Years && avg3Years !== 0 ? avg3Years.toFixed(2) + '%' : '-'}
                                            </strong>
                                            <small style="color: var(--text-light); font-size: 0.75rem;">×××•×¦×¢</small>
                                        </div>
                                    </div>
                                    <div style="padding: 6px 8px; background: ${comparison3Y.color}15; border-radius: 4px; border-right: 3px solid ${comparison3Y.color};">
                                        <small style="color: ${comparison3Y.color}; font-weight: 600; font-size: 0.75rem; display: block; line-height: 1.3;">
                                            ${comparison3Y.shortMessage || comparison3Y.message}
                                        </small>
                                    </div>
                                </div>
                                
                                <div style="background: white; padding: 12px; border-radius: 6px; border: 2px solid ${comparison5Y.color};">
                                    <small style="color: var(--text-light); display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.85rem;">5 ×©× ×™×</small>
                                    <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px; flex-wrap: wrap; gap: 5px;">
                                        <strong style="color: ${comparison5Y.color}; font-size: clamp(1rem, 3vw, 1.3rem);">
                                            ${clientReturn5Y && clientReturn5Y !== 0 ? clientReturn5Y.toFixed(2) + '%' : '-'}
                                        </strong>
                                        <small style="color: var(--text-light); font-size: 0.75rem;">×©×œ×š</small>
                                    </div>
                                    <div style="padding-top: 5px; border-top: 1px dashed #e0e0e0; margin-bottom: 8px;">
                                        <div style="display: flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; gap: 5px;">
                                            <strong style="color: var(--primary); font-size: clamp(0.9rem, 2.5vw, 1.1rem);">
                                                ${avg5Years && avg5Years !== 0 ? avg5Years.toFixed(2) + '%' : '-'}
                                            </strong>
                                            <small style="color: var(--text-light); font-size: 0.75rem;">×××•×¦×¢</small>
                                        </div>
                                    </div>
                                    <div style="padding: 6px 8px; background: ${comparison5Y.color}15; border-radius: 4px; border-right: 3px solid ${comparison5Y.color};">
                                        <small style="color: ${comparison5Y.color}; font-weight: 600; font-size: 0.75rem; display: block; line-height: 1.3;">
                                            ${comparison5Y.shortMessage || comparison5Y.message}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ×˜×‘×œ×ª 3 ×”××¡×œ×•×œ×™× ×”××•×‘×™×œ×™× -->
                            ${top3TableHtml}
                        </div>
                    `;
                }
                
                html += `</div>`;
            }
            
            analysisContainer.innerHTML = html;
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×”×©×•×•××ª ×ª×©×•××•×ª
        // ×¡×•×œ× ×“×™×¨×•×’ ×œ×¤×™ ×¡×˜×™×™×” ××”×××•×¦×¢ (%)
        function compareReturns(clientReturn, avgReturn) {
            // ×‘×“×™×§×” ×× ××—×“ ××”× ×ª×•× ×™× ×—×¡×¨
            if (!clientReturn || clientReturn === 0 || !avgReturn || avgReturn === 0) {
                return {
                    color: '#9e9e9e',
                    icon: 'fa-minus',
                    message: '×œ× × ×™×ª×Ÿ ×œ×”×©×•×•××”',
                    shortMessage: '×œ× × ×™×ª×Ÿ ×œ×”×©×•×•××”',
                    diff: 0,
                    diffPercent: 0,
                    noData: true
                };
            }
            
            const diff = clientReturn - avgReturn;
            const diffPercent = avgReturn !== 0 ? (diff / avgReturn) * 100 : 0;
            
            let color, icon, message, shortMessage, rating;
            
            // ×¡×•×œ× ×“×™×¨×•×’ ×œ×¤×™ ×¡×˜×™×™×” ××”×××•×¦×¢ (%)
            if (diffPercent <= -10) {
                // D â‰¤ -10% â†’ ×—×œ×©
                color = '#dc3545';
                icon = 'fa-times-circle';
                rating = '×—×œ×©';
                message = `${rating} - ×ª×©×•××” × ××•×›×” ××©××¢×•×ª×™×ª ××”×××•×¦×¢ ×‘×¢× ×£ (${diff.toFixed(2)}%)`;
                shortMessage = `${rating} (${diff.toFixed(2)}%)`;
            } else if (diffPercent <= -5) {
                // -10% < D â‰¤ -5% â†’ ×˜×¢×•×Ÿ ×©×™×¤×•×¨
                color = '#ff5722';
                icon = 'fa-exclamation-triangle';
                rating = '×˜×¢×•×Ÿ ×©×™×¤×•×¨';
                message = `${rating} - ×‘×™×¦×•×¢×™× ××¢×˜ ××ª×—×ª ×œ×¨××ª ×”×©×•×§ (${diff.toFixed(2)}%)`;
                shortMessage = `${rating} (${diff.toFixed(2)}%)`;
            } else if (diffPercent <= 5) {
                // -5% < D â‰¤ +5% â†’ ×¡×‘×™×¨
                color = '#ffc107';
                icon = 'fa-check';
                rating = '×¡×‘×™×¨';
                message = `${rating} - ×ª×©×•××” ×“×•××” ×œ×××•×¦×¢, ×ª×•×××ª ×©×•×§ (${diff.toFixed(2)}%)`;
                shortMessage = `${rating} (${diff > 0 ? '+' : ''}${diff.toFixed(2)}%)`;
            } else if (diffPercent <= 10) {
                // +5% < D â‰¤ +10% â†’ ×˜×•×‘
                color = '#9ccc65';
                icon = 'fa-check-circle';
                rating = '×˜×•×‘';
                message = `${rating} - ×ª×©×•××” ×¢×•×“×¤×ª ×‘×™×—×¡ ×œ×¢× ×£ (+${diff.toFixed(2)}%)`;
                shortMessage = `${rating} (+${diff.toFixed(2)}%)`;
            } else {
                // D > +10% â†’ ×˜×•×‘ ×××•×“
                color = '#28a745';
                icon = 'fa-trophy';
                rating = '×˜×•×‘ ×××•×“';
                message = `${rating} - ×‘×™×¦×•×¢×™× ×¢×•×“×¤×™× ××©××¢×•×ª×™×ª, × ×™×”×•×œ ××™×›×•×ª×™ (+${diff.toFixed(2)}%)`;
                shortMessage = `${rating} (+${diff.toFixed(2)}%)`;
            }
            
            return { color, icon, message, shortMessage, rating, diff, diffPercent, noData: false };
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×–×™×”×•×™ ×¡×•×’ ××•×¦×¨ ×œ×¤×™ sugMutzar
        function getMozarType(sugMutzar) {
            const sugMutzarStr = String(sugMutzar || '');

            // 1 = ×¤×•×œ×™×¡×ª ×‘×™×˜×•×— ×—×™×™× ××©×•×œ×‘ ×—×™×¡×›×•×Ÿ - × ×‘×“×§ ××•×œ ×¤×•×œ×™×¡×•×ª ×—×¡×›×•×Ÿ
            if (sugMutzarStr === '1' || sugMutzarStr.includes('×‘×™×˜×•×— ×—×™×™×') || sugMutzarStr.includes('×‘×™×˜×•×— ×× ×”×œ×™×')) {
                return '×‘×™×˜×•×— ×—×™×™× ×¢× ×—×¡×›×•×Ÿ';
            }

            // 2 = ×§×¨×Ÿ ×¤× ×¡×™×”
            // 2_1 = ×§×¨× ×•×ª ×•×ª×™×§×•×ª
            if (sugMutzarStr === '2_1' || sugMutzarStr.includes('×§×¨×Ÿ ×¤× ×¡×™×” ×•×ª×™×§×”')) {
                return '×§×¨×Ÿ ×•×ª×™×§×”';
            }
            // 2_2 = ×§×¨× ×•×ª ×—×“×©×•×ª
            if (sugMutzarStr === '2_2' || sugMutzarStr.includes('×§×¨×Ÿ ×¤× ×¡×™×” ×—×“×©×”')) {
                return '×§×¨× ×•×ª ×—×“×©×•×ª';
            }
            // 2 = ×§×¨×Ÿ ×¤× ×¡×™×” (×›×œ×œ×™)
            if (sugMutzarStr === '2') {
                return '×§×¨× ×•×ª ×—×“×©×•×ª'; // ×‘×¨×™×¨×ª ××—×“×œ
            }

            // 3 = ×§×•×¤×ª ×’××œ
            if (sugMutzarStr === '3' || sugMutzarStr.includes('×§×•×¤×ª ×’××œ') || sugMutzarStr.includes('×’××œ')) {
                return '×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×”';
            }

            // 4 = ×§×¨×Ÿ ×”×©×ª×œ××•×ª
            if (sugMutzarStr === '4' || sugMutzarStr.includes('×”×©×ª×œ××•×ª')) {
                return '×§×¨× ×•×ª ×”×©×ª×œ××•×ª';
            }

            // 5 = ×¤×•×œ×™×¡×ª ×—×¡×›×•×Ÿ ×˜×”×•×¨
            if (sugMutzarStr === '5' || sugMutzarStr.includes('×¤×•×œ×™×¡')) {
                return '×¤×•×œ×™×¡×•×ª ×—×¡×›×•×Ÿ';
            }

            // 9 = ×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×”
            if (sugMutzarStr === '9' || sugMutzarStr.includes('×’××œ ×œ×”×©×§×¢×”')) {
                return '×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×”';
            }

            // 10 = ×—×¡×›×•×Ÿ ×œ×›×œ ×™×œ×“
            if (sugMutzarStr === '10' || sugMutzarStr.includes('×œ×›×œ ×™×œ×“') || sugMutzarStr.includes('×—×¡×›×•×Ÿ ×œ×™×œ×“')) {
                return '×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×” - ×—×¡×›×•×Ÿ ×œ×™×œ×“';
            }

            // ×§×¨× ×•×ª ×•×ª×™×§×•×ª - ×œ× × ×‘×“×§ ×›×œ×œ (×¨×§ ×œ×¤×™ ×©×)
            if (sugMutzarStr.includes('×•×ª×™×§')) {
                return '×§×¨×Ÿ ×•×ª×™×§×”';
            }

            // ×ª×’××•×œ×™× ×•××™×©×™×ª ×œ×¤×™×¦×•×™×™×
            if (sugMutzarStr.includes('×ª×’××•×œ×™×') || sugMutzarStr.includes('×¤×™×¦×•×™×™×')) {
                return '×ª×’××•×œ×™× ×•××™×©×™×ª ×œ×¤×™×¦×•×™×™×';
            }

            // ××¨×›×–×™×ª ×œ×¤×™×¦×•×™×™×
            if (sugMutzarStr.includes('××¨×›×–×™×ª')) {
                return '××¨×›×–×™×ª ×œ×¤×™×¦×•×™×™×';
            }

            // ×¤×•×œ×™×¡×•×ª ×¡×™×›×•×Ÿ - ×œ× ××˜×•×¤×œ×•×ª ×‘×©×œ×‘ ×–×”
            if (sugMutzarStr === '6' || sugMutzarStr === '7' || sugMutzarStr === '8' || 
                sugMutzarStr.includes('×¡×™×›×•×Ÿ') || sugMutzarStr.includes('×¨×™×¡×§') || 
                sugMutzarStr.includes('××©×›× ×ª×') || sugMutzarStr.includes('×§×•×œ×§×˜×™×‘')) {
                return null;
            }

            return null;
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×—×™×¤×•×© ramatsikon ×œ×¤×™ ×©× ×”××¡×œ×•×œ
        // ××©×ª××©×ª ×‘-sikonData ×©× ×˜×¢×Ÿ ×-ofihashkaa.xml ×‘×¢×œ×™×™×ª ×”××ª×¨
        function findRamatsikonByName(shemMaslul) {
            if (!shemMaslul) return null;
            
            // ×‘×“×™×§×” ×× sikonData ×–××™×Ÿ
            if (typeof sikonData === 'undefined' || !Array.isArray(sikonData) || sikonData.length === 0) {
                console.warn('âš ï¸ sikonData ×œ× ×–××™×Ÿ ××• ×¨×™×§');
                return null;
            }
            
            const shemLower = shemMaslul.toLowerCase().trim();
            
            // × ×™×¡×™×•×Ÿ 1: ×—×™×¤×•×© ×”×ª×××” ×™×©×™×¨×” ×©×œ ×©× ×”××¡×œ×•×œ ×”××œ×
            let sikonItem = sikonData.find(item => 
                item.name && item.name.toLowerCase().trim() === shemLower
            );
            
            if (sikonItem && sikonItem.risk) {
                return sikonItem.risk;
            }
            
            // × ×™×¡×™×•×Ÿ 2: ×—×™×¤×•×© ×”×ª×××” ×—×œ×§×™×ª - ×× ×©× ×”××¡×œ×•×œ ××›×™×œ ××ª ×”×©× ×-sikonData
            sikonItem = sikonData.find(item => 
                item.name && shemLower.includes(item.name.toLowerCase().trim())
            );
            
            if (sikonItem && sikonItem.risk) {
                return sikonItem.risk;
            }
            
            // × ×™×¡×™×•×Ÿ 3: ×–×™×”×•×™ ×¡×•×’ ×”××¡×œ×•×œ ×¢"×™ getMaslulType ×•×—×™×¤×•×© ×œ×¤×™ ×”×¡×•×’
            const maslulType = typeof getMaslulType === 'function' ? getMaslulType(shemMaslul) : null;
            
            if (maslulType && maslulType !== '×œ× ×™×“×•×¢') {
                sikonItem = sikonData.find(item => 
                    item.name && item.name.toLowerCase() === maslulType.toLowerCase()
                );
                
                if (sikonItem && sikonItem.risk) {
                    return sikonItem.risk;
                }
            }
            
            return null;
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×–×™×”×•×™ ×¨××ª ×¡×™×›×•×Ÿ ×-ramatsikon
        function getRiskLevel(ramatsikon) {
            if (!ramatsikon || ramatsikon === '×œ× ×™×“×•×¢') return '×œ× ×™×“×•×¢';
            
            const text = ramatsikon.toLowerCase();
            
            // ×× ×–×” ×›×‘×¨ ×˜×§×¡×˜ ×‘×¨×•×¨
            if (text.includes('× ××•×›×”') || text.includes('× ××•×š')) return '× ××•×š';
            if (text.includes('×‘×™× ×•× ×™×ª') || text.includes('×‘×™× ×•× ×™')) return '×‘×™× ×•× ×™';
            if (text.includes('×’×‘×•×”×”') || text.includes('×’×‘×•×”')) return '×’×‘×•×”';
            
            // ×× ×–×” ××¡×¤×¨ ××—×•×–×™×
            const percent = parseFloat(text.replace(/[^0-9.]/g, ''));
            if (!isNaN(percent)) {
                if (percent < 25) return '× ××•×š';
                if (percent <= 60) return '×‘×™× ×•× ×™';
                return '×’×‘×•×”';
            }
            
            return '×œ× ×™×“×•×¢';
        }
        
        // ×¤×•× ×§×¦×™×” ××ª×§×“××ª ×œ×—×™×©×•×‘ ×¨××ª ×¡×™×›×•×Ÿ ×œ×¤×™ ×¡×˜×™×•×ª ×¡×˜×˜×™×¡×˜×™×•×ª
        function calculateRiskByStandardDeviation(productName, maslulType) {
            // ××§×¨×” ××™×•×—×“: ×§×¨×Ÿ ×•×ª×™×§×” - ×œ× × ×‘×“×§ ×›×œ×œ
            if (productName === '×§×¨×Ÿ ×•×ª×™×§×”') {
                return '×œ× ×™×“×•×¢';
            }
            
            // ××§×¨×” ××™×•×—×“: ×‘×™×˜×•×— ×—×™×™× ×¢× ×—×¡×›×•×Ÿ - × ×‘×“×§ ××•×œ ×¤×•×œ×™×¡×•×ª ×—×¡×›×•×Ÿ
            let productToCheck = productName;
            if (productName === '×‘×™×˜×•×— ×—×™×™× ×¢× ×—×¡×›×•×Ÿ') {
                productToCheck = '×¤×•×œ×™×¡×•×ª ×—×¡×›×•×Ÿ';
            }
            
            // ×‘×“×™×§×” ×©×™×© ×’×™×©×” ×œ-dataIndicators ×•-dataIndicatorsSikon
            if (typeof dataIndicators === 'undefined' || !Array.isArray(dataIndicators) || dataIndicators.length === 0) {
                console.warn('âš ï¸ dataIndicators ×œ× ×–××™×Ÿ - × ×•×¤×œ ×œ×©×™×˜×” ×”×™×©× ×”');
                // × ×¤×™×œ×” ×œ×©×™×˜×” ×”×™×©× ×”
                const foundRamatsikon = findRamatsikonByName(maslulType);
                return getRiskLevel(foundRamatsikon || '×œ× ×™×“×•×¢');
            }
            
            if (typeof dataIndicatorsSikon === 'undefined' || !Array.isArray(dataIndicatorsSikon) || dataIndicatorsSikon.length === 0) {
                console.warn('âš ï¸ dataIndicatorsSikon ×œ× ×–××™×Ÿ - × ×•×¤×œ ×œ×©×™×˜×” ×”×™×©× ×”');
                const foundRamatsikon = findRamatsikonByName(maslulType);
                return getRiskLevel(foundRamatsikon || '×œ× ×™×“×•×¢');
            }
            
            // ×©×œ×‘ 1: ×—×™×¤×•×© ×”××¡×œ×•×œ ×‘-dataIndicators (×¢× ×”××•×¦×¨ ×”× ×›×•×Ÿ ×œ×‘×“×™×§×”)
            const maslulData = dataIndicators.find(item => 
                item.mozar === productToCheck && item.maslul === maslulType
            );
            
            if (!maslulData) {
                console.warn(`âš ï¸ ×œ× × ××¦× ××¡×œ×•×œ "${maslulType}" ×‘××•×¦×¨ "${productToCheck}" ×‘-dataIndicators`);
                // × ×¤×™×œ×” ×œ×©×™×˜×” ×”×™×©× ×”
                const foundRamatsikon = findRamatsikonByName(maslulType);
                return getRiskLevel(foundRamatsikon || '×œ× ×™×“×•×¢');
            }
            
            // ×©×œ×‘ 2: ×—×™×©×•×‘ ×”×¡×˜×™×™×” ×”××©×•×§×œ×œ×ª ×©×œ ×”××¡×œ×•×œ
            const stiya36 = parseFloat(maslulData.stiya36 || 0);
            const stiya60 = parseFloat(maslulData.stiya60 || 0);
            
            let calculatedStiya;
            
            // ×œ×¤×™ ×”×œ×•×’×™×§×” ×©×”××©×ª××© ×‘×™×§×©:
            if (stiya36 > 0 && stiya60 > 0) {
                // ×× ×™×© ×’× 3 ×©× ×™× ×•×’× 5 ×©× ×™×: 60% ×œ-5 ×©× ×™× ×•-40% ×œ-3 ×©× ×™×
                calculatedStiya = (stiya60 * 0.6) + (stiya36 * 0.4);
            } else if (stiya36 > 0) {
                // ×× ×™×© ×¨×§ 3 ×©× ×™×
                calculatedStiya = stiya36;
            } else if (stiya60 > 0) {
                // ×× ×™×© ×¨×§ 5 ×©× ×™× (××§×¨×” ×œ× ×¦×¤×•×™ ××‘×œ × ×˜×¤×œ ×‘×•)
                calculatedStiya = stiya60;
            } else {
                // ××™×Ÿ × ×ª×•× ×™ ×¡×˜×™×™×” - × ×•×¤×œ ×œ×©×™×˜×” ×”×™×©× ×” (SIKON ××”××¡×œ×•×œ ×¢×¦××•)
                const foundRamatsikon = findRamatsikonByName(maslulType);
                return getRiskLevel(foundRamatsikon || '×œ× ×™×“×•×¢');
            }
            
            // ×©×œ×‘ 3: ×—×™×¤×•×© ×˜×•×•×—×™ ×”×¡×™×›×•×Ÿ ×©×œ ×”××•×¦×¨ (××©×ª××© ×‘-productToCheck)
            const productSikonData = dataIndicatorsSikon.find(item => item.mozar === productToCheck);
            
            if (!productSikonData) {
                console.warn(`âš ï¸ ×œ× × ××¦× ××•×¦×¨ "${productToCheck}" ×‘-dataIndicatorsSikon`);
                // × ×¤×™×œ×” ×œ×©×™×˜×” ×”×™×©× ×”
                const foundRamatsikon = findRamatsikonByName(maslulType);
                return getRiskLevel(foundRamatsikon || '×œ× ×™×“×•×¢');
            }
            
            const stiyaCombinedMin = parseFloat(productSikonData.stiyaCombinedMin || 0);
            const stiyaCombinedMax = parseFloat(productSikonData.stiyaCombinedMax || 0);
            
            // ×©×œ×‘ 4: ×§×‘×™×¢×ª ×¨××ª ×”×¡×™×›×•×Ÿ ×œ×¤×™ ×”×˜×•×•×—×™×
            let riskLevel;
            if (calculatedStiya < stiyaCombinedMin) {
                riskLevel = '× ××•×š';
            } else if (calculatedStiya <= stiyaCombinedMax) {
                riskLevel = '×‘×™× ×•× ×™';
            } else {
                riskLevel = '×’×‘×•×”';
            }
            
            return riskLevel;
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×ª ×”×ª×××”
        function checkRiskMatch(clientRisk, pathwayRisk) {
            if (!clientRisk || !pathwayRisk || pathwayRisk === '×œ× ×™×“×•×¢') {
                return null;
            }
            
            const isMatch = clientRisk === pathwayRisk;
            
            let message, color, icon;
            
            if (isMatch) {
                message = '××ª××™× ×œ×¤×¨×•×¤×™×œ ×”×¡×™×›×•×Ÿ ×©×œ×š';
                color = '#28a745';
                icon = 'fa-check-circle';
            } else {
                if (clientRisk === '× ××•×š' && pathwayRisk === '×’×‘×•×”') {
                    message = '×¡×™×›×•×Ÿ ×’×‘×•×” ××“×™ ×¢×‘×•×¨×š';
                    color = '#dc3545';
                    icon = 'fa-exclamation-triangle';
                } else if (clientRisk === '×’×‘×•×”' && pathwayRisk === '× ××•×š') {
                    message = '×¡×™×›×•×Ÿ × ××•×š ××“×™ - ×¤×•×˜× ×¦×™××œ ×¦××™×—×” ××•×’×‘×œ';
                    color = '#ffc107';
                    icon = 'fa-info-circle';
                } else {
                    message = '××™-×”×ª×××” ×—×œ×§×™×ª';
                    color = '#ff9800';
                    icon = 'fa-exclamation-circle';
                }
            }
            
            return { isMatch, message, color, icon };
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×–×™×”×•×™ ×¤×¢×¨×™×
        function analyzeGaps() {
            const container = document.getElementById('gapAnalysis');
            container.innerHTML = '<div class="analysis-card" style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--primary);"></i><p style="margin-top: 20px; color: var(--text-light);">××–×”×” ×¤×¢×¨×™× ×•×”×–×“×× ×•×™×•×ª...</p></div>';
            
            // ×›××Ÿ ×™×‘×•× ×”×§×•×“ ×œ×–×™×”×•×™ ×¤×¢×¨×™×
            setTimeout(() => {
                container.innerHTML = '<div class="analysis-card"><h3><i class="fas fa-check"></i> × ×™×ª×•×— ×¤×¢×¨×™× ×”×•×©×œ×</h3><p>×ª×•×¦××•×ª ×™×•×¦×’×• ×›××Ÿ ×‘×§×¨×•×‘</p></div>';
            }, 500);
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ×”××œ×¦×•×ª
        function generateRecommendations() {
            const container = document.getElementById('recommendationsReport');
            container.innerHTML = '<div class="analysis-card" style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--primary);"></i><p style="margin-top: 20px; color: var(--text-light);">××™×™×¦×¨ ×”××œ×¦×•×ª ××•×ª×××•×ª ××™×©×™×ª...</p></div>';
            
            // ×§×¨×™××ª × ×ª×•× ×™ ×”×¤×¢×¨×™× ××©×œ×‘ 3
            const gapsData = window.gapsData || {
                riskGaps: [],
                feeGaps: [],
                returnGaps: []
            };
            
            const riskGaps = gapsData.riskGaps || [];
            const feeGaps = gapsData.feeGaps || [];
            const returnGaps = gapsData.returnGaps || [];
            
            // ×™×¦×™×¨×ª ×”××œ×¦×•×ª
            const recommendations = [];
            
            // ×”××œ×¦×•×ª ×œ×¤×¢×¨×™ ×¡×™×›×•×Ÿ
            if (riskGaps.length > 0) {
                riskGaps.forEach(gap => {
                    recommendations.push({
                        category: '×¡×™×›×•×Ÿ',
                        priority: '×’×‘×•×”×”',
                        icon: 'âš ï¸',
                        text: `××•××œ×¥ ×œ×‘×“×•×§ ××ª ×”××¡×œ×•×œ "${gap.maslul}" ×‘×ª×•×›× ×™×ª "${gap.tochnit}" - ×”××¡×œ×•×œ ×œ× ××ª××™× ×œ×¤×¨×•×¤×™×œ ×”×¡×™×›×•×Ÿ ×©×œ×š (${gap.clientRisk}). ${gap.gap}`,
                        amount: gap.amount
                    });
                });
            }
            
            // ×”××œ×¦×•×ª ×œ×“××™ × ×™×”×•×œ ×’×‘×•×”×™×
            if (feeGaps.length > 0) {
                feeGaps.forEach(gap => {
                    const feeTypeText = gap.feeType === '×“××™ × ×™×”×•×œ ×©× ×ª×™×™×' ? '×“××™ × ×™×”×•×œ ×©× ×ª×™×™×' : '×“××™ × ×™×”×•×œ ×”×¤×§×“×”';
                    recommendations.push({
                        category: '×“××™ × ×™×”×•×œ',
                        priority: '×’×‘×•×”×”',
                        icon: 'ğŸ’°',
                        text: `××•××œ×¥ ×œ×‘×“×•×§ ××ª ${feeTypeText} ×‘××¡×œ×•×œ "${gap.maslulType}" ×‘×ª×•×›× ×™×ª "${gap.tochnit}" - ×“××™ ×”× ×™×”×•×œ ×©×œ×š (${gap.clientFee.toFixed(2)}%) ×’×‘×•×”×™× ××”×××•×¦×¢ ×‘×¢× ×£ (${gap.avgFee.toFixed(2)}%)`,
                        amount: gap.amount,
                        diff: gap.diff
                    });
                });
            }
            
            // ×”××œ×¦×•×ª ×œ×¤×¢×¨×™ ×ª×©×•××•×ª
            if (returnGaps.length > 0) {
                returnGaps.forEach(gap => {
                    recommendations.push({
                        category: '×‘×™×¦×•×¢×™×',
                        priority: gap.rating === '×—×œ×©' ? '×’×‘×•×”×”' : '×‘×™× ×•× ×™×ª',
                        icon: 'ğŸ“ˆ',
                        text: `××•××œ×¥ ×œ×‘×“×•×§ ××ª ×‘×™×¦×•×¢×™ ×”××¡×œ×•×œ "${gap.maslulType}" ×‘×ª×•×›× ×™×ª "${gap.tochnit}" - ×”×ª×©×•××” ×©×œ×š (${gap.clientReturn.toFixed(2)}%) × ××•×›×” ××©××¢×•×ª×™×ª ××”×××•×¦×¢ ×‘×¢× ×£ (${gap.avgReturn.toFixed(2)}%)`,
                        amount: gap.amount,
                        rating: gap.rating
                    });
                });
            }
            
            // ×× ××™×Ÿ ×”××œ×¦×•×ª
            if (recommendations.length === 0) {
                container.innerHTML = `
                    <div class="analysis-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 40px; text-align: center; margin-bottom: 30px;">
                        <h2 style="margin: 0 0 20px 0; font-size: clamp(1.2rem, 4vw, 2rem);">
                            <i class="fas fa-trophy"></i>
                            ×›×œ ×”×›×‘×•×“!
                        </h2>
                        <p style="margin: 0; font-size: clamp(0.9rem, 2.5vw, 1.2rem); line-height: 1.8;">
                            ×œ× × ××¦××• ×¤×¢×¨×™× ××©××¢×•×ª×™×™× ×‘×ª×™×§ ×”×”×©×§×¢×•×ª ×©×œ×š.<br>
                            ×”×ª×™×§ ×× ×•×”×œ ×‘×¦×•×¨×” ×˜×•×‘×” ×•××ª××™× ×œ×¤×¨×•×¤×™×œ ×©×œ×š!
                        </p>
                    </div>
                    <div class="analysis-card" style="border-right: 4px solid #28a745; padding: 30px;">
                        <h3 style="color: #28a745; margin: 0 0 15px 0; font-size: clamp(1rem, 3vw, 1.2rem);">
                            <i class="fas fa-check-circle"></i>
                            ×¡×™×›×•×
                        </h3>
                        <p style="color: var(--text); line-height: 1.8; margin: 0; font-size: clamp(0.85rem, 2.5vw, 1rem);">
                            ×”×ª×™×§ ×©×œ×š ×××•×–×Ÿ ×•××ª××™× ×œ×¤×¨×•×¤×™×œ ×”×¡×™×›×•×Ÿ ×©×œ×š. ×”××©×š ×œ×¢×§×•×‘ ××—×¨×™ ×”×‘×™×¦×•×¢×™× ×•×œ×”×ª×¢×“×›×Ÿ ×‘××•×¦×¨×™× ×—×“×©×™× ×‘×©×•×§.
                        </p>
                    </div>
                `;
                return;
            }
            
            // ××™×•×Ÿ ×œ×¤×™ ×¢×“×™×¤×•×ª
            const priorityOrder = { '×’×‘×•×”×”': 1, '×‘×™× ×•× ×™×ª': 2, '× ××•×›×”': 3 };
            recommendations.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
            
            // ×‘× ×™×™×ª HTML ×œ×”××œ×¦×•×ª
            let html = `
                <div class="analysis-card" style="background: linear-gradient(180deg, #62B1C8 0%, #2494B5 50%, #0183AA 100%); color: white; margin-bottom: 30px; padding: 30px; text-align: center;">
                    <h2 style="margin: 0 0 10px 0; font-size: clamp(1.2rem, 4vw, 2rem);">
                        <i class="fas fa-lightbulb"></i>
                        ×“×•×— ×”××œ×¦×•×ª ××•×ª×××•×ª ××™×©×™×ª
                    </h2>
                    <p style="margin: 0; opacity: 0.9; font-size: clamp(0.8rem, 2.5vw, 1.1rem);">
                        ×”××œ×¦×•×ª ×œ×¤×¢×•×œ×” ×‘×”×ª×× ×œ× ×™×ª×•×— ×”×ª×™×§ ×©×œ×š
                    </p>
                </div>
                <div class="analysis-card" style="background: ${recommendations.length > 0 ? '#fff3cd' : '#d4edda'}; border-right: 4px solid ${recommendations.length > 0 ? '#ffc107' : '#28a745'}; margin-bottom: 30px;">
                    <h3 style="color: ${recommendations.length > 0 ? '#856404' : '#155724'}; margin: 0 0 15px 0; font-size: clamp(1rem, 3vw, 1.2rem);">
                        <i class="fas ${recommendations.length > 0 ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i>
                        ×¡×™×›×•× ×›×œ×œ×™
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div style="background: white; padding: clamp(10px, 2.5vw, 15px); border-radius: 8px; text-align: center;">
                            <div style="font-size: clamp(1.5rem, 5vw, 2rem); font-weight: bold; color: var(--primary);">
                                ${recommendations.length}
                            </div>
                            <div style="color: var(--text-light); font-size: clamp(0.75rem, 2vw, 0.9rem);">×”××œ×¦×•×ª ×œ×¤×¢×•×œ×”</div>
                        </div>
                    </div>
                </div>
            `;
            
            // ×§×™×‘×•×¥ ×œ×¤×™ ×§×˜×’×•×¨×™×•×ª
            const byCategory = {};
            recommendations.forEach(rec => {
                if (!byCategory[rec.category]) {
                    byCategory[rec.category] = [];
                }
                byCategory[rec.category].push(rec);
            });
            
            // ×”×¦×’×” ×œ×¤×™ ×§×˜×’×•×¨×™×•×ª
            const categoryColors = {
                '×¡×™×›×•×Ÿ': { bg: '#ffebee', border: '#dc3545', icon: '#dc3545' },
                '×“××™ × ×™×”×•×œ': { bg: '#fff3e0', border: '#ff5722', icon: '#ff5722' },
                '×‘×™×¦×•×¢×™×': { bg: '#fff9c4', border: '#ffc107', icon: '#f57c00' }
            };
            
            Object.entries(byCategory).forEach(([category, recs]) => {
                const colors = categoryColors[category] || { bg: '#f5f5f5', border: '#666', icon: '#666' };
                
                html += `
                    <div class="analysis-card" style="border-right: 4px solid ${colors.border}; margin-bottom: 30px;">
                        <h3 style="color: ${colors.icon}; margin: 0 0 20px 0; font-size: clamp(1rem, 3vw, 1.3rem);">
                            ${recs[0].icon} ${category} (${recs.length})
                        </h3>
                `;
                
                recs.forEach(rec => {
                    html += `
                        <div class="recommendation-item" style="background: ${colors.bg}; padding: clamp(12px, 3vw, 20px); border-radius: 8px; margin-bottom: 15px; border-right: 3px solid ${colors.border}; overflow: hidden;">
                            <div class="recommendation-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                                <div class="recommendation-text" style="flex: 1; min-width: 0; max-width: 100%; word-wrap: break-word; overflow-wrap: break-word;">
                                    <div style="font-weight: bold; color: var(--text-dark); margin-bottom: 8px; font-size: clamp(0.85rem, 2.5vw, 1.05rem); line-height: 1.5; word-wrap: break-word; overflow-wrap: break-word;">
                                        ${rec.text}
                                    </div>
                                </div>
                                <div class="recommendation-meta" style="text-align: left; flex-shrink: 0; min-width: fit-content;">
                                    ${rec.amount ? `<div style="font-weight: bold; color: var(--primary); font-size: clamp(0.9rem, 2.5vw, 1.1rem); white-space: nowrap;">
                                        â‚ª${rec.amount.toLocaleString('he-IL', {maximumFractionDigits: 0})}
                                    </div>` : ''}
                                    <div style="margin-top: 5px;">
                                        <span style="background: ${rec.priority === '×’×‘×•×”×”' ? '#dc3545' : '#ffc107'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: clamp(0.7rem, 2vw, 0.8rem); font-weight: bold; white-space: nowrap; display: inline-block;">
                                            ${rec.priority}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
        }
        
        // Placeholder function for PDF generation
        function generatePDFReport() {
            Swal.fire({
                title: '×”×•×¨×“×ª ×“×•×—',
                text: '×”×“×•×— ×‘×ª×”×œ×™×š ×”×›× ×”...',
                icon: 'info'
            });
        }
        
        // Scroll to Top functionality
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
        
        // Show/Hide scroll to top button on scroll (mobile only)
        function updateScrollButton() {
            const scrollBtn = document.getElementById('scrollToTopBtn');
            if (scrollBtn && window.innerWidth <= 768) {
                if (window.pageYOffset > 300) {
                    scrollBtn.classList.add('show');
                } else {
                    scrollBtn.classList.remove('show');
                }
            } else if (scrollBtn) {
                scrollBtn.classList.remove('show');
            }
        }
        
        window.addEventListener('scroll', updateScrollButton);
        window.addEventListener('resize', updateScrollButton);
        
        // Show/Hide advice button on scroll (only in step 2)
        function updateAdviceButton() {
            const adviceBtn = document.getElementById('adviceBtnFloat');
            if (!adviceBtn) return;
            
            // ×‘×“×™×§×” ×× ×× ×—× ×• ×‘×©×œ×‘ 2
            const step2Panel = document.getElementById('step-2');
            const isStep2Visible = step2Panel && (step2Panel.classList.contains('active') || step2Panel.style.display !== 'none');
            
            if (!isStep2Visible) {
                adviceBtn.classList.remove('show');
                return;
            }
            
            if (window.innerWidth <= 768) {
                if (window.pageYOffset > 300) {
                    adviceBtn.classList.add('show');
                } else {
                    adviceBtn.classList.remove('show');
                }
            } else if (window.innerWidth > 768) {
                if (window.pageYOffset > 600) {
                    adviceBtn.classList.add('show');
                } else {
                    adviceBtn.classList.remove('show');
                }
            }
        }
        
        window.addEventListener('scroll', updateAdviceButton);
        window.addEventListener('resize', updateAdviceButton);
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(updateScrollButton, 100);
            setTimeout(updateAdviceButton, 100);
        });
        
        // ×¤×•× ×§×¦×™×” ×œ×¡×’×™×¨×ª × ×™×ª×•×— ××ª×§×“× ×•××—×™×§×ª × ×ª×•× ×™×
        function closeAdvancedAnalysis() {
            Swal.fire({
                title: '<strong style="color: #dc3545;">×”×× ×œ×¡×’×•×¨ ××ª ×”× ×™×ª×•×—?</strong>',
                html: '<p style="color: #666; font-size: 1rem;">×›×œ ×”× ×ª×•× ×™× ×©×œ ×”× ×™×ª×•×— ×”××ª×§×“× ×™×™××—×§×•</p>' +
                      '<p style="color: #999; font-size: 0.9rem; margin-top: 10px;">×ª×•×›×œ ×œ×‘×¦×¢ × ×™×ª×•×— ×—×“×© ×‘×›×œ ×¢×ª ××“×£ ×”×‘×™×ª</p>',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="fas fa-check"></i> ×›×Ÿ, ×¡×’×•×¨ ×•××—×§',
                cancelButtonText: '<i class="fas fa-times"></i> ×‘×™×˜×•×œ',
                reverseButtons: true,
                customClass: {
                    popup: 'swal2-rtl'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // ××—×™×§×ª ×›×œ × ×ª×•× ×™ ×”× ×™×ª×•×— ×-sessionStorage
                    sessionStorage.removeItem('gilForAdvancedAnalysis');
                    sessionStorage.removeItem('sumHonForAdvancedAnalysis');
                    sessionStorage.removeItem('sumKitzvaForAdvancedAnalysis');
                    sessionStorage.removeItem('ageToRetirementForAdvancedAnalysis');
                    sessionStorage.removeItem('riskProfile');
                    sessionStorage.removeItem('riskScore');
                    sessionStorage.removeItem('advancedAnalysisData');
                    
                    // ×”×¦×’×ª ×”×•×“×¢×ª ××™×©×•×¨
                    Swal.fire({
                        title: '×”× ×ª×•× ×™× × ××—×§×•',
                        text: '×—×•×–×¨ ×œ×“×£ ×”×‘×™×ª...',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.href = 'index.html';
                    });
                }
            });
        }
        
        // ========================================
        // ×“×•×— ×¤×¢×¨×™× - ××™×¡×•×£ ×›×œ ×”×‘×¢×™×•×ª ×-3 ×”×˜××‘×™×
        // ========================================
        async function analyzeGaps() {
            
            const gapsContainer = document.getElementById('gapAnalysis');
            if (!gapsContainer) return;
            
            const detailedData = clientAnalysisData.detailedData;
            const pirteiHeshbon = detailedData.pirteiHeshbon;
            const clientRisk = clientAnalysisData.profile.riskProfile;
            
            // ××¢×¨×›×™× ×œ××™×¡×•×£ ×”×¤×¢×¨×™×
            const riskGaps = [];
            const feeGaps = [];
            const returnGaps = [];
            
            // ========================================
            // 1. ××™×¡×•×£ ×¤×¢×¨×™ ×¡×™×›×•×Ÿ
            // ========================================
            if (clientRisk && clientRisk !== "") {
                // ×§×™×‘×•×¥ ×ª×›× ×™×•×ª ×•××¡×œ×•×œ×™× (×›××• ×‘-showRiskAnalysis)
                const tochnitMap = {};
                
                for (let heshbonIndex = 0; heshbonIndex < pirteiHeshbon.length; heshbonIndex++) {
                    const heshbon = pirteiHeshbon[heshbonIndex];
                    const maslulim = heshbon.mafyenMaslulim || [];
                    
                    if (maslulim.length === 0) continue;
                    
                    const tochnitKey = heshbon.shemTochnit || `×—×©×‘×•×Ÿ_${heshbonIndex}`;
                    const isPensionFund = heshbon.sugMutzar === '2' || heshbon.sugMutzar === 2 || 
                                         heshbon.sugMutzar === '2_1' || heshbon.sugMutzar === '2_2';
                    
                    if (!tochnitMap[tochnitKey]) {
                        tochnitMap[tochnitKey] = {
                            shemTochnit: heshbon.shemTochnit,
                            shemMaasik: heshbon.shemMaasik,
                            sugMutzar: heshbon.sugMutzar,
                            mozarType: getMozarType(heshbon.sugMutzar), // ×¡×•×’ ×”××•×¦×¨ ×”×××•×¤×”
                            isPension: isPensionFund,
                            maslulim: {}
                        };
                    }
                    
                    for (let maslulIndex = 0; maslulIndex < maslulim.length; maslulIndex++) {
                        const maslul = maslulim[maslulIndex];
                        const pathwayAmount = parseFloat(maslul.schumTzvira || 0);
                        
                        if (pathwayAmount <= 0) continue;
                        
                        const pathwayName = maslul.shemMaslulHashkaa || maslul.shemMaslul || '';
                        const maslulType = getMaslulType(pathwayName);
                        
                        if (isPensionFund) {
                            const kodMaslul = Number(maslul.kodMaslolHashkaa.slice(23,30)).toString();
                            if (!tochnitMap[tochnitKey].maslulim[kodMaslul]) {
                                tochnitMap[tochnitKey].maslulim[kodMaslul] = {
                                    pathwayName: pathwayName,
                                    maslulType: maslulType,
                                    totalAmount: 0
                                };
                            }
                            tochnitMap[tochnitKey].maslulim[kodMaslul].totalAmount += pathwayAmount;
                        } else {
                            const uniqueKey = `${maslulIndex}`;
                            tochnitMap[tochnitKey].maslulim[uniqueKey] = {
                                pathwayName: pathwayName,
                                maslulType: maslulType,
                                totalAmount: pathwayAmount
                            };
                        }
                    }
                }
                
                // ×‘×“×™×§×ª ×”×ª×××•×ª ×¡×™×›×•×Ÿ
                for (const [tochnitKey, tochnitData] of Object.entries(tochnitMap)) {
                    for (const [maslulKey, maslulData] of Object.entries(tochnitData.maslulim)) {
                        // ×©×™××•×© ×‘×¤×•× ×§×¦×™×” ×”××ª×§×“××ª ×œ×—×™×©×•×‘ ×¡×™×›×•×Ÿ ×œ×¤×™ ×¡×˜×™×•×ª ×¡×˜×˜×™×¡×˜×™×•×ª
                        // ××¢×‘×™×¨×™× ××ª ×¡×•×’ ×”××•×¦×¨ (mozarType) ×•×œ× ××ª ×©× ×”×ª×•×›× ×™×ª
                        const mozarForCalc = tochnitData.mozarType || tochnitData.shemTochnit;
                        const pathwayRisk = calculateRiskByStandardDeviation(mozarForCalc, maslulData.maslulType);
                        const match = checkRiskMatch(clientRisk, pathwayRisk);
                        
                        // ×× ×œ× ××ª××™× - ×”×•×¡×£ ×œ×¨×©×™××ª ×¤×¢×¨×™× (×¨×§ ××™-×”×ª×××•×ª!)
                        if (match && !match.isMatch) {
                            riskGaps.push({
                                tochnit: tochnitData.shemTochnit,
                                maslul: maslulData.maslulType,
                                clientRisk: clientRisk,
                                pathwayRisk: pathwayRisk,
                                gap: match.message,
                                amount: maslulData.totalAmount
                            });
                        }
                    }
                }
            }
            
            // ========================================
            // 2. ××™×¡×•×£ ×¤×¢×¨×™ ×“××™ × ×™×”×•×œ
            // ========================================
            for (let heshbonIndex = 0; heshbonIndex < pirteiHeshbon.length; heshbonIndex++) {
                const heshbon = pirteiHeshbon[heshbonIndex];
                const maslulim = heshbon.mafyenMaslulim || [];
                
                for (let maslulIndex = 0; maslulIndex < maslulim.length; maslulIndex++) {
                    const maslul = maslulim[maslulIndex];
                    const pathwayName = maslul.shemMaslulHashkaa || maslul.shemMaslul || '××¡×œ×•×œ ' + (maslulIndex + 1);
                    const pathwayAmount = parseFloat(maslul.schumTzvira || 0);
                    
                    if (pathwayAmount <= 0) continue;
                    
                    const maslulType = getMaslulType(pathwayName);
                    
                    // ×–×™×”×•×™ ×©× ×”××•×¦×¨
                    let productName = '';
                    switch(heshbon.sugMutzar) {
                        case '4':
                        case 4:
                            productName = '×§×¨× ×•×ª ×”×©×ª×œ××•×ª';
                            break;
                        case '3':
                        case 3:
                            productName = '×ª×’××•×œ×™× ×•××™×©×™×ª ×œ×¤×™×¦×•×™×™×';
                            break;
                        case '9':
                        case 9:
                            productName = '×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×”';
                            break;
                        case '10':
                        case 10:
                            productName = '×—×¡×›×•×Ÿ ×œ×™×œ×“';
                            break;
                        case '2':
                        case 2:
                        case '2_1':
                        case '2_2':
                            productName = '×§×¨× ×•×ª ×—×“×©×•×ª';
                            break;
                        case '1':
                        case 1:
                            productName = '×¤×•×œ×™×¡×ª ×‘×™×˜×•×— ×—×™×™× ××©×•×œ×‘ ×—×™×¡×›×•×Ÿ';
                            break;
                        case '5':
                        case 5:
                            productName = '×¤×•×œ×™×¡×ª ×—×¡×›×•×Ÿ';
                            break;
                    }
                    
                    // ×—×™×©×•×‘ ×“××™ × ×™×”×•×œ
                    const dmeyNihulShana = parseFloat(maslul.dmeyNihulShnatiyim) || 0;
                    const dmeyNihulHafkada = parseFloat(maslul.dmeyNihulHafkada) || 0;
                    
                    // ××¦×™××ª ×××•×¦×¢×™×
                    const avgFeesResult = await indicationsforadvancedanalysis(productName, maslulType);
                    
                    if (avgFeesResult) {
                        const avgDmeyNihulShana = parseFloat(avgFeesResult.dmeyNihul || 0);
                        const avgDmeyNihulHafkada = parseFloat(avgFeesResult.dmeyNihulHafkad || 0);
                        
                        // ×‘×“×™×§×” ×× ×“××™ ×”× ×™×”×•×œ ×’×‘×•×”×™× ××”×××•×¦×¢
                        if (dmeyNihulShana > 0 && avgDmeyNihulShana > 0 && dmeyNihulShana > avgDmeyNihulShana) {
                            feeGaps.push({
                                tochnit: heshbon.shemTochnit,
                                maslul: pathwayName,
                                maslulType: maslulType,
                                feeType: '×“××™ × ×™×”×•×œ ×©× ×ª×™×™×',
                                clientFee: dmeyNihulShana,
                                avgFee: avgDmeyNihulShana,
                                diff: dmeyNihulShana - avgDmeyNihulShana,
                                amount: pathwayAmount
                            });
                        }
                        
                        if (dmeyNihulHafkada > 0 && avgDmeyNihulHafkada > 0 && dmeyNihulHafkada > avgDmeyNihulHafkada) {
                            feeGaps.push({
                                tochnit: heshbon.shemTochnit,
                                maslul: pathwayName,
                                maslulType: maslulType,
                                feeType: '×“××™ × ×™×”×•×œ ×”×¤×§×“×”',
                                clientFee: dmeyNihulHafkada,
                                avgFee: avgDmeyNihulHafkada,
                                diff: dmeyNihulHafkada - avgDmeyNihulHafkada,
                                amount: pathwayAmount
                            });
                        }
                    }
                }
            }
            
            // ========================================
            // 3. ××™×¡×•×£ ×¤×¢×¨×™ ×ª×©×•××•×ª
            // ========================================
            // ×§×™×‘×•×¥ ×ª×›× ×™×•×ª ×•××¡×œ×•×œ×™× (×›××• ×‘-showReturnsAnalysis)
            const tochnitMapReturns = {};
            
            for (let heshbonIndex = 0; heshbonIndex < pirteiHeshbon.length; heshbonIndex++) {
                const heshbon = pirteiHeshbon[heshbonIndex];
                const maslulim = heshbon.mafyenMaslulim || [];
                
                if (maslulim.length === 0) continue;
                
                const tochnitKey = heshbon.shemTochnit || `×—×©×‘×•×Ÿ_${heshbonIndex}`;
                const isPensionFund = heshbon.sugMutzar === '2' || heshbon.sugMutzar === 2 || 
                                     heshbon.sugMutzar === '2_1' || heshbon.sugMutzar === '2_2';
                
                if (!tochnitMapReturns[tochnitKey]) {
                    tochnitMapReturns[tochnitKey] = {
                        shemTochnit: heshbon.shemTochnit,
                        shemMaasik: heshbon.shemMaasik,
                        sugMutzar: heshbon.sugMutzar,
                        isPension: isPensionFund,
                        maslulim: {}
                    };
                }
                
                for (let maslulIndex = 0; maslulIndex < maslulim.length; maslulIndex++) {
                    const maslul = maslulim[maslulIndex];
                    const pathwayAmount = parseFloat(maslul.schumTzvira || 0);
                    
                    if (pathwayAmount <= 0) continue;
                    
                    const kodMaslul = Number(maslul.kodMaslolHashkaa.slice(23,30)).toString();
                    
                    if (isPensionFund) {
                        if (!tochnitMapReturns[tochnitKey].maslulim[kodMaslul]) {
                            tochnitMapReturns[tochnitKey].maslulim[kodMaslul] = {
                                kodMaslul: kodMaslul,
                                pathwayName: maslul.shemMaslulHashkaa || maslul.shemMaslul,
                                totalAmount: 0
                            };
                        }
                        tochnitMapReturns[tochnitKey].maslulim[kodMaslul].totalAmount += pathwayAmount;
                    } else {
                        const uniqueKey = `${kodMaslul}_${maslulIndex}`;
                        tochnitMapReturns[tochnitKey].maslulim[uniqueKey] = {
                            kodMaslul: kodMaslul,
                            pathwayName: maslul.shemMaslulHashkaa || maslul.shemMaslul,
                            totalAmount: pathwayAmount
                        };
                    }
                }
            }
            
            // ×‘×“×™×§×ª ×ª×©×•××•×ª
            for (const [tochnitKey, tochnitData] of Object.entries(tochnitMapReturns)) {
                for (const [maslulKey, maslulData] of Object.entries(tochnitData.maslulim)) {
                    const kodMaslul = maslulData.kodMaslul;
                    const pathwayName = maslulData.pathwayName;
                    const maslulType = getMaslulType(pathwayName);
                    
                    // ×–×™×”×•×™ ×©× ×”××•×¦×¨
                    let productName = '';
                    switch(tochnitData.sugMutzar) {
                        case '4':
                        case 4:
                            productName = '×§×¨× ×•×ª ×”×©×ª×œ××•×ª';
                            break;
                        case '3':
                        case 3:
                            productName = '×ª×’××•×œ×™× ×•××™×©×™×ª ×œ×¤×™×¦×•×™×™×';
                            break;
                        case '9':
                        case 9:
                            productName = '×§×•×¤×ª ×’××œ ×œ×”×©×§×¢×”';
                            break;
                        case '10':
                        case 10:
                            productName = '×—×¡×›×•×Ÿ ×œ×™×œ×“';
                            break;
                        case '2':
                        case 2:
                        case '2_1':
                        case '2_2':
                            productName = '×§×¨× ×•×ª ×—×“×©×•×ª';
                            break;
                        case '1':
                        case 1:
                            productName = '×¤×•×œ×™×¡×ª ×‘×™×˜×•×— ×—×™×™× ××©×•×œ×‘ ×—×™×¡×›×•×Ÿ';
                            break;
                        case '5':
                        case 5:
                            productName = '×¤×•×œ×™×¡×ª ×—×¡×›×•×Ÿ';
                            break;
                    }
                    
                    // ×—×™×¤×•×© ×ª×©×•××•×ª
                    let getMaslul = null;
                    getMaslul = datanetunimKlaliXM.filter(item => item.mh === kodMaslul.toString());
                    if (getMaslul.length === 0) {
                        getMaslul = datanetunimKlaliXP.filter(item => item.mh === kodMaslul.toString());
                    }
                    if (getMaslul.length === 0) {
                        getMaslul = datanetunimKlaliXB.filter(item => item.mh === kodMaslul.toString());
                    }
                    
                    if (getMaslul && getMaslul.length > 0) {
                        const clientReturn = parseFloat(getMaslul[0].tesuam);
                        
                        // ××¦×™××ª ×××•×¦×¢
                        const avgReturnsResult = await indicationsforadvancedanalysis(productName, maslulType);
                        
                        if (avgReturnsResult) {
                            const avgYear = parseFloat(avgReturnsResult.tesuam || 0);
                            const comparison = compareReturns(clientReturn, avgYear);
                            
                            // ×× ×—×œ×© ××• ×˜×¢×•×Ÿ ×©×™×¤×•×¨ - ×”×•×¡×£ ×œ×¤×¢×¨×™×
                            if (comparison && !comparison.noData && 
                                (comparison.diffPercent <= -5)) {
                                returnGaps.push({
                                    tochnit: tochnitData.shemTochnit,
                                    maslul: pathwayName,
                                    maslulType: maslulType,
                                    clientReturn: clientReturn,
                                    avgReturn: avgYear,
                                    diff: comparison.diff,
                                    diffPercent: comparison.diffPercent,
                                    rating: comparison.diffPercent <= -10 ? '×—×œ×©' : '×˜×¢×•×Ÿ ×©×™×¤×•×¨',
                                    amount: maslulData.totalAmount
                                });
                            }
                        }
                    }
                }
            }
            
            // ========================================
            // 4. ×”×¦×’×ª ×”×“×•×—
            // ========================================
            let html = `
                <div class="analysis-card" style="background: linear-gradient(180deg, #62B1C8 0%, #2494B5 50%, #0183AA 100%); color: white; margin-bottom: 30px; padding: 30px; text-align: center;">
                    <h2 style="margin: 0 0 10px 0; font-size: clamp(1.5rem, 4vw, 2rem);">
                        <i class="fas fa-chart-line"></i>
                        ×“×•×— ×¤×¢×¨×™× ×•×”×–×“×× ×•×™×•×ª
                    </h2>
                    <p style="margin: 0; opacity: 0.9; font-size: clamp(0.9rem, 2.5vw, 1.1rem);">
                        ×–×™×”×•×™ ××–×•×¨×™× ×œ×©×™×¤×•×¨ ×•××•×¤×˜×™××™×–×¦×™×” ×‘×ª×™×§ ×”×”×©×§×¢×•×ª ×©×œ×š
                    </p>
                </div>
            `;
            
            // ×¡×™×›×•× ×›×œ×œ×™
            const totalGaps = riskGaps.length + feeGaps.length + returnGaps.length;
            
            html += `
                <div class="analysis-card" style="background: ${totalGaps > 0 ? '#fff3cd' : '#d4edda'}; border-right: 4px solid ${totalGaps > 0 ? '#ffc107' : '#28a745'}; margin-bottom: 30px;">
                    <h3 style="color: ${totalGaps > 0 ? '#856404' : '#155724'}; margin: 0 0 15px 0;">
                        <i class="fas ${totalGaps > 0 ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i>
                        ×¡×™×›×•× ×›×œ×œ×™
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: ${riskGaps.length > 0 ? '#dc3545' : '#28a745'};">
                                ${riskGaps.length}
                            </div>
                            <div style="color: var(--text-light); font-size: 0.9rem;">×¤×¢×¨×™ ×¡×™×›×•×Ÿ</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: ${feeGaps.length > 0 ? '#ff5722' : '#28a745'};">
                                ${feeGaps.length}
                            </div>
                            <div style="color: var(--text-light); font-size: 0.9rem;">×“××™ × ×™×”×•×œ ×’×‘×•×”×™×</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: ${returnGaps.length > 0 ? '#ffc107' : '#28a745'};">
                                ${returnGaps.length}
                            </div>
                            <div style="color: var(--text-light); font-size: 0.9rem;">×ª×©×•××•×ª × ××•×›×•×ª</div>
                        </div>
                    </div>
                </div>
            `;
            
            // ×¤×¢×¨×™ ×¡×™×›×•×Ÿ
            if (riskGaps.length > 0) {
                html += `
                    <div class="analysis-card" style="border-right: 4px solid #dc3545; margin-bottom: 30px;">
                        <h3 style="color: #dc3545; margin: 0 0 20px 0;">
                            <i class="fas fa-exclamation-triangle"></i>
                            ×¤×¢×¨×™ ×¡×™×›×•×Ÿ (${riskGaps.length})
                        </h3>
                        <p style="color: var(--text-light); margin-bottom: 20px;">
                            ××¡×œ×•×œ×™× ×©×¨××ª ×”×¡×™×›×•×Ÿ ×©×œ×”× ××™× ×” ××ª××™××” ×œ×¤×¨×•×¤×™×œ ×”×¡×™×›×•×Ÿ ×©×œ×š
                        </p>
                `;
                
                riskGaps.forEach(gap => {
                    html += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-right: 3px solid #dc3545;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <div style="font-weight: bold; color: var(--text-dark); margin-bottom: 5px;">
                                        ${gap.tochnit}
                                    </div>
                                    <div style="color: var(--text-light); font-size: 0.9rem;">
                                        <i class="fas fa-route"></i> ${gap.maslul}
                                    </div>
                                </div>
                                <div style="text-align: left;">
                                    <div style="font-weight: bold; color: var(--primary);">
                                        â‚ª${gap.amount.toLocaleString('he-IL', {maximumFractionDigits: 0})}
                                    </div>
                                </div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                    <div>
                                        <small style="color: var(--text-light);">×”×¡×™×›×•×Ÿ ×©×œ×š:</small>
                                        <div style="font-weight: bold; color: #28a745;">${gap.clientRisk}</div>
                                    </div>
                                    <div>
                                        <small style="color: var(--text-light);">×¡×™×›×•×Ÿ ×”××¡×œ×•×œ:</small>
                                        <div style="font-weight: bold; color: #dc3545;">${gap.pathwayRisk}</div>
                                    </div>
                                </div>
                                <div style="padding: 8px; background: #fff3cd; border-radius: 4px; border-right: 3px solid #ffc107;">
                                    <small style="color: #856404; font-weight: 600;">
                                        <i class="fas fa-info-circle"></i> ${gap.gap}
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            } else if (clientRisk && clientRisk !== "") {
                html += `
                    <div class="analysis-card" style="border-right: 4px solid #28a745; margin-bottom: 30px;">
                        <h3 style="color: #28a745; margin: 0 0 10px 0;">
                            <i class="fas fa-check-circle"></i>
                            ×¤×¢×¨×™ ×¡×™×›×•×Ÿ
                        </h3>
                        <p style="color: var(--text);">
                            âœ… ××¦×•×™×Ÿ! ×›×œ ×”××¡×œ×•×œ×™× ×©×œ×š ××ª××™××™× ×œ×¤×¨×•×¤×™×œ ×”×¡×™×›×•×Ÿ ×©×œ×š
                        </p>
                    </div>
                `;
            }
            
            // ×¤×¢×¨×™ ×“××™ × ×™×”×•×œ
            if (feeGaps.length > 0) {
                html += `
                    <div class="analysis-card" style="border-right: 4px solid #ff5722; margin-bottom: 30px;">
                        <h3 style="color: #ff5722; margin: 0 0 20px 0;">
                            <i class="fas fa-dollar-sign"></i>
                            ×“××™ × ×™×”×•×œ ×’×‘×•×”×™× ××”×××•×¦×¢ (${feeGaps.length})
                        </h3>
                        <p style="color: var(--text-light); margin-bottom: 20px;">
                            ××¡×œ×•×œ×™× ×©×‘×”× ×“××™ ×”× ×™×”×•×œ ×©×œ×š ×’×‘×•×”×™× ×™×•×ª×¨ ××”×××•×¦×¢ ×‘×¢× ×£
                        </p>
                `;
                
                feeGaps.forEach(gap => {
                    html += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-right: 3px solid #ff5722;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <div style="font-weight: bold; color: var(--text-dark); margin-bottom: 5px;">
                                        ${gap.tochnit}
                                    </div>
                                    <div style="color: var(--text-light); font-size: 0.9rem;">
                                        <i class="fas fa-route"></i> ${gap.maslulType}
                                    </div>
                                </div>
                                <div style="text-align: left;">
                                    <div style="font-weight: bold; color: var(--primary);">
                                        â‚ª${gap.amount.toLocaleString('he-IL', {maximumFractionDigits: 0})}
                                    </div>
                                </div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px;">
                                <div style="margin-bottom: 10px;">
                                    <small style="color: var(--text-light);">${gap.feeType}</small>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                    <div style="text-align: center;">
                                        <small style="color: var(--text-light);">×©×œ×š</small>
                                        <div style="font-weight: bold; color: #dc3545; font-size: 1.1rem;">${gap.clientFee.toFixed(2)}%</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <small style="color: var(--text-light);">×××•×¦×¢</small>
                                        <div style="font-weight: bold; color: var(--primary); font-size: 1.1rem;">${gap.avgFee.toFixed(2)}%</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <small style="color: var(--text-light);">×”×¤×¨×©</small>
                                        <div style="font-weight: bold; color: #ff5722; font-size: 1.1rem;">+${gap.diff.toFixed(2)}%</div>
                                    </div>
                                </div>
                                <div style="padding: 8px; background: #ffebee; border-radius: 4px; border-right: 3px solid #ff5722;">
                                    <small style="color: #c62828; font-weight: 600;">
                                        <i class="fas fa-exclamation-circle"></i> ×“××™ × ×™×”×•×œ ×’×‘×•×”×™× - ×©×§×•×œ ×œ×‘×“×•×§ ×—×œ×•×¤×•×ª
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            } else {
                html += `
                    <div class="analysis-card" style="border-right: 4px solid #28a745; margin-bottom: 30px;">
                        <h3 style="color: #28a745; margin: 0 0 10px 0;">
                            <i class="fas fa-check-circle"></i>
                            ×“××™ × ×™×”×•×œ
                        </h3>
                        <p style="color: var(--text);">
                            âœ… ××¦×•×™×Ÿ! ×“××™ ×”× ×™×”×•×œ ×©×œ×š ×¡×‘×™×¨×™× ××• × ××•×›×™× ××”×××•×¦×¢ ×‘×¢× ×£
                        </p>
                    </div>
                `;
            }
            
            // ×¤×¢×¨×™ ×ª×©×•××•×ª
            if (returnGaps.length > 0) {
                html += `
                    <div class="analysis-card" style="border-right: 4px solid #ffc107; margin-bottom: 30px;">
                        <h3 style="color: #856404; margin: 0 0 20px 0;">
                            <i class="fas fa-chart-line"></i>
                            ×ª×©×•××•×ª × ××•×›×•×ª ××”×××•×¦×¢ (${returnGaps.length})
                        </h3>
                        <p style="color: var(--text-light); margin-bottom: 20px;">
                            ××¡×œ×•×œ×™× ×©×”×ª×©×•××” ×©×œ×”× × ××•×›×” ××©××¢×•×ª×™×ª ××”×××•×¦×¢ ×‘×¢× ×£
                        </p>
                `;
                
                returnGaps.forEach(gap => {
                    html += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-right: 3px solid ${gap.rating === '×—×œ×©' ? '#dc3545' : '#ff5722'};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <div style="font-weight: bold; color: var(--text-dark); margin-bottom: 5px;">
                                        ${gap.tochnit}
                                    </div>
                                    <div style="color: var(--text-light); font-size: 0.9rem;">
                                        <i class="fas fa-route"></i> ${gap.maslulType}
                                    </div>
                                </div>
                                <div style="text-align: left;">
                                    <div style="font-weight: bold; color: var(--primary);">
                                        â‚ª${gap.amount.toLocaleString('he-IL', {maximumFractionDigits: 0})}
                                    </div>
                                </div>
                            </div>
                            <div style="background: white; padding: 12px; border-radius: 6px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                    <div style="text-align: center;">
                                        <small style="color: var(--text-light);">×ª×©×•××” ×©×œ×š</small>
                                        <div style="font-weight: bold; color: ${gap.rating === '×—×œ×©' ? '#dc3545' : '#ff5722'}; font-size: 1.1rem;">
                                            ${gap.clientReturn.toFixed(2)}%
                                        </div>
                                    </div>
                                    <div style="text-align: center;">
                                        <small style="color: var(--text-light);">×××•×¦×¢ ×¢× ×£</small>
                                        <div style="font-weight: bold; color: var(--primary); font-size: 1.1rem;">
                                            ${gap.avgReturn.toFixed(2)}%
                                        </div>
                                    </div>
                                    <div style="text-align: center;">
                                        <small style="color: var(--text-light);">×”×¤×¨×©</small>
                                        <div style="font-weight: bold; color: ${gap.rating === '×—×œ×©' ? '#dc3545' : '#ff5722'}; font-size: 1.1rem; direction: ltr; text-align: center;">
                                            ${gap.diff < 0 ? '-' : ''}${Math.abs(gap.diff).toFixed(2)}%
                                        </div>
                                    </div>
                                </div>
                                <div style="padding: 8px; background: ${gap.rating === '×—×œ×©' ? '#ffebee' : '#fff3e0'}; border-radius: 4px; border-right: 3px solid ${gap.rating === '×—×œ×©' ? '#dc3545' : '#ff5722'};">
                                    <small style="color: ${gap.rating === '×—×œ×©' ? '#c62828' : '#e65100'}; font-weight: 600;">
                                        <i class="fas fa-arrow-down"></i> ${gap.rating} - ×©×§×•×œ ×œ×‘×—×•×Ÿ ×‘×™×¦×•×¢×™ ×”××¡×œ×•×œ
                                    </small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            } else {
                html += `
                    <div class="analysis-card" style="border-right: 4px solid #28a745; margin-bottom: 30px;">
                        <h3 style="color: #28a745; margin: 0 0 10px 0;">
                            <i class="fas fa-check-circle"></i>
                            ×ª×©×•××•×ª
                        </h3>
                        <p style="color: var(--text);">
                            âœ… ××¦×•×™×Ÿ! ×”×ª×©×•××•×ª ×©×œ×š ×¡×‘×™×¨×•×ª ××• ×˜×•×‘×•×ª ×‘×™×—×¡ ×œ×××•×¦×¢ ×‘×¢× ×£
                        </p>
                    </div>
                `;
            }
            
            // ×¡×™×›×•× ×•×”××œ×¦×•×ª
            if (totalGaps > 0) {
                html += `
                    <div class="analysis-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px;">
                        <h3 style="margin: 0 0 15px 0; color: white;">
                            <i class="fas fa-lightbulb"></i>
                            ×”××œ×¦×•×ª ×œ×¤×¢×•×œ×”
                        </h3>
                        <ul style="margin: 0; padding-right: 20px; line-height: 1.8;">
                            ${riskGaps.length > 0 ? '<li>×©×§×•×œ ×œ×”×ª××™× ××ª ×”××¡×œ×•×œ×™× ×œ×¤×¨×•×¤×™×œ ×”×¡×™×›×•×Ÿ ×©×œ×š</li>' : ''}
                            ${feeGaps.length > 0 ? '<li>×‘×“×•×§ ××¤×©×¨×•×™×•×ª ×œ×”×§×˜× ×ª ×“××™ ×”× ×™×”×•×œ ××• ××¢×‘×¨ ×œ××¡×œ×•×œ×™× ×–×•×œ×™× ×™×•×ª×¨</li>' : ''}
                            ${returnGaps.length > 0 ? '<li>× ×ª×— ××ª ×‘×™×¦×•×¢×™ ×”××¡×œ×•×œ×™× ×•×©×§×•×œ ×©×™× ×•×™ ××¡×˜×¨×˜×’×™×”</li>' : ''}
                            <li>×”××©×š ×œ×©×œ×‘ 4 ×œ×§×‘×œ×ª ×”××œ×¦×•×ª ××¤×•×¨×˜×•×ª</li>
                        </ul>
                    </div>
                `;
            } else {
                html += `
                    <div class="analysis-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 25px; text-align: center;">
                        <h3 style="margin: 0 0 15px 0; color: white;">
                            <i class="fas fa-trophy"></i>
                            ×›×œ ×”×›×‘×•×“!
                        </h3>
                        <p style="margin: 0; font-size: 1.1rem; line-height: 1.6;">
                            ×œ× × ××¦××• ×¤×¢×¨×™× ××©××¢×•×ª×™×™× ×‘×ª×™×§ ×”×”×©×§×¢×•×ª ×©×œ×š.<br>
                            ×”×ª×™×§ ×× ×•×”×œ ×‘×¦×•×¨×” ×˜×•×‘×” ×•××ª××™× ×œ×¤×¨×•×¤×™×œ ×©×œ×š!
                        </p>
                    </div>
                `;
            }
            
            // ×©××™×¨×ª ×”× ×ª×•× ×™× ×œ×©×™××•×© ×‘×©×œ×‘ 4
            window.gapsData = {
                riskGaps: riskGaps,
                feeGaps: feeGaps,
                returnGaps: returnGaps
            };
            
            gapsContainer.innerHTML = html;
        }
        
        // ========================================
        // Navigate to Home Page Function
        // ========================================
        function navigateToHome() {
            // ×× ×× ×—× ×• ×›×‘×¨ ×‘×“×£ ×”×‘×™×ª - ×¤×©×•×˜ × ×’×œ×•×œ ×œ××¢×œ×”
            if (window.location.pathname.endsWith('index.html') || window.location.pathname === '/') {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                // ×× ×—× ×• ×‘×“×£ ××—×¨ - × ×¢×‘×•×¨ ×œ×“×£ ×”×‘×™×ª
                window.location.href = 'index.html';
            }
        }
    </script>
 
</body>
</html>

